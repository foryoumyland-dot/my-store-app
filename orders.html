<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>طلباتي</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
  /* ===== الشريط العلوي الثابت والمتجاوب ===== */
  .top-navbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: linear-gradient(135deg, #ff69b4, #ff1493);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(255, 105, 180, 0.4);
      border-bottom: 2px solid #ffb6c1;
  }

  /* اسم المتجر على اليمين - نص عادي غير قابل للنقر */
  .store-name {
      color: white;
      font-weight: bold;
      font-size: 1.3rem;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      padding: 8px 20px;
      border-radius: 25px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      cursor: default;
      user-select: none;
      position: relative;
      overflow: hidden;
  }

  /* تأثير اللمعة للاسم */
  .store-name::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      transition: left 0.5s;
  }

  .store-name:hover::before {
      left: 100%;
  }

  /* أيقونة القائمة على اليسار */
  .menu-icon {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      font-size: 1.4rem;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 12px;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
  }

  .menu-icon:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
      border-color: rgba(255, 255, 255, 0.5);
  }

  /* القائمة المنسدلة */
  .dropdown-menu {
      position: absolute;
      top: 65px;
      right: 20px;
      background: linear-gradient(135deg, #ffffff, #fff5f7);
      border-radius: 15px;
      box-shadow: 0 8px 30px rgba(255, 105, 180, 0.3);
      padding: 0;
      min-width: 200px;
      display: none;
      z-index: 1001;
      border: 2px solid #ffe4ec;
      backdrop-filter: blur(10px);
      text-align: center;
  }

  .dropdown-menu.show {
      display: block;
      animation: slideDown 0.3s ease;
  }

  @keyframes slideDown {
      from {
          opacity: 0;
          transform: translateY(-10px);
      }
      to {
          opacity: 1;
          transform: translateY(0);
      }
  }

  .dropdown-item {
      display: block;
      padding: 15px 20px;
      text-decoration: none;
      color: #d63384;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
      border: none;
      background: none;
      width: 100%;
      text-align: center;
  }

  .dropdown-item:hover {
      background: linear-gradient(45deg, #fff0f6, #ffe4ec);
      color: #ff1493;
  }

  /* الخط الفاصل بين العناصر */
  .menu-divider {
      width: 80%;
      height: 1px;
      background: linear-gradient(90deg, transparent, #ffb6c1, transparent);
      margin: 0 auto;
  }

  /* حجب القائمة عند النقر خارجها */
  .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      z-index: 999;
      display: none;
  }

  /* تصميم متجاوب لجميع الشاشات */
  @media (max-width: 768px) {
      .top-navbar {
          height: 55px;
          padding: 0 15px;
      }
      
      .store-name {
          font-size: 1.1rem;
          padding: 6px 15px;
      }
      
      .menu-icon {
          font-size: 1.2rem;
          padding: 6px 10px;
      }
      
      .dropdown-menu {
          min-width: 180px;
          top: 60px;
          right: 15px;
      }
      
      .dropdown-item {
          padding: 12px 16px;
          font-size: 0.9rem;
      }
  }

  @media (max-width: 480px) {
      .top-navbar {
          height: 50px;
          padding: 0 10px;
      }
      
      .store-name {
          font-size: 1rem;
          padding: 5px 12px;
      }
      
      .menu-icon {
          font-size: 1.1rem;
          padding: 5px 8px;
      }
      
      .dropdown-menu {
          min-width: 160px;
          top: 55px;
          right: 10px;
      }
      
      .dropdown-item {
          padding: 10px 14px;
          font-size: 0.85rem;
      }
  }

  @media (min-width: 1200px) {
      .top-navbar {
          height: 65px;
          padding: 0 25px;
      }
      
      .store-name {
          font-size: 1.5rem;
          padding: 10px 25px;
      }
      
      .menu-icon {
          font-size: 1.6rem;
          padding: 10px 15px;
      }
      
      .dropdown-menu {
          min-width: 220px;
          top: 70px;
          right: 25px;
      }
      
      .dropdown-item {
          padding: 16px 22px;
          font-size: 1.1rem;
      }
  }

  /* ===== تنسيقات صفحة الطلبات ===== */
  body { 
    font-family: Tahoma; 
    background:#f9f9f9; 
    margin: 0;
    padding-top: 70px;
    padding-bottom: 80px;
    direction: rtl; 
  }
  h2 { 
    color:#d63384; 
    text-align:center; 
    margin-top: 20px;
  }
  .order { 
    background:#fff; 
    padding:15px; 
    margin:10px 15px; 
    border-radius:8px; 
    box-shadow:0 2px 6px rgba(0,0,0,0.1); 
    border-right: 4px solid #d63384;
  }
  .order h3 { 
    margin:0 0 8px; 
    color:#333; 
  }
  .status { 
    font-weight:bold; 
    padding: 4px 8px;
    border-radius: 4px;
    display: inline-block;
  }
  .status-pending { background: #fff3cd; color: #856404; }
  .status-confirmed { background: #d1ecf1; color: #0c5460; }
  .status-shipping { background: #d1e7ff; color: #004085; }
  .status-delivered { background: #d4edda; color: #155724; }
  .status-cancelled { background: #f8d7da; color: #721c24; }
  
  .btn-action { 
    background: linear-gradient(45deg, #ff69b4, #ff1493);
    color:white; 
    border:none; 
    padding:8px 16px; 
    border-radius:6px; 
    cursor:pointer; 
    margin-top:10px;
    font-weight: bold;
    font-size: 14px;
  }
  
  .user-info {
    background: #e9f7ef;
    padding: 15px;
    margin: 15px;
    border-radius: 8px;
    text-align: center;
    border-right: 4px solid #28a745;
  }
  
  .no-orders {
    text-align: center;
    color: #666;
    padding: 40px 20px;
    font-size: 18px;
  }
  
  .loading {
    text-align: center;
    color: #d63384;
    padding: 20px;
    font-size: 16px;
  }
  
  /* تنبيهات متوافقة مع المتجر */
  .alert-custom { 
    position: fixed; 
    top: 80px; 
    left: 50%; 
    transform: translateX(-50%); 
    background: linear-gradient(45deg, #ff416c, #ff4b2b); 
    color: white; 
    padding: 12px 20px; 
    border-radius: 8px; 
    font-size: 16px; 
    font-weight: bold; 
    z-index: 3000; 
    display: none; 
  }
</style>
</head>
<body>

<!-- الشريط العلوي المدمج مباشرة -->
<nav class="top-navbar">
    <!-- أيقونة القائمة على اليسار -->
    <button class="menu-icon" onclick="toggleMenu()">☰</button>
    
    <!-- اسم المتجر على اليمين - نص عادي -->
    <div class="store-name">🌸 لأجلك سيدتي</div>
    
    <!-- القائمة المنسدلة -->
    <div class="dropdown-menu" id="dropdownMenu">
        <a href="profile.html" class="dropdown-item" onclick="closeMenu()">👤 بياناتي</a>
        <div class="menu-divider"></div>
        <a href="orders.html" class="dropdown-item" onclick="closeMenu()">📦 طلباتي</a>
    </div>
</nav>

<!-- حجب القائمة عند النقر خارجها -->
<div class="overlay" id="overlay" onclick="closeMenu()"></div>

<!-- تنبيهات -->
<div id="alertBox" class="alert-custom"></div>

<!-- الشريط السفلي -->
<iframe src="bottom-nav.html" style="width:100%; height:80px; border:none; position: fixed; bottom: 0; left: 0; z-index: 1000;"></iframe>

<h2>📦 طلباتي</h2>

<!-- ✅ معلومات المستخدم -->
<div id="userInfo" class="user-info" style="display:none;">
    <strong>👤 العميل: </strong><span id="customerName"></span> - 
    <strong>📞 الهاتف: </strong><span id="customerPhone"></span>
</div>

<!-- ✅ الطلبات -->
<div id="orders" class="loading">🔄 جاري تحميل الطلبات...</div>

<script>
// ✅ إعدادات Firebase - نفس إعدادات المتجر
const firebaseConfig = {
    apiKey: "AIzaSyA-LdNQbQneJyxJQ8iMUUd5gsJypTFi6sg",
    authDomain: "mystore-orders-a74f8.firebaseapp.com",
    databaseURL: "https://mystore-orders-a74f8-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "mystore-orders-a74f8",
    storageBucket: "mystore-orders-a74f8.appspot.com",
    messagingSenderId: "431733924264",
    appId: "1:431733924264:web:986b8dc983ef8c0097bd9d"
};

// تهيئة Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ✅ بيانات المستخدم من localStorage
let userProfile = JSON.parse(localStorage.getItem('userProfile'));

// وظائف القائمة المنسدلة
function toggleMenu() {
    const menu = document.getElementById('dropdownMenu');
    const overlay = document.getElementById('overlay');
    
    if (menu.classList.contains('show')) {
        closeMenu();
    } else {
        menu.classList.add('show');
        overlay.style.display = 'block';
    }
}

function closeMenu() {
    const menu = document.getElementById('dropdownMenu');
    const overlay = document.getElementById('overlay');
    
    menu.classList.remove('show');
    overlay.style.display = 'none';
}

// إغلاق القائمة عند النقر خارجها
document.addEventListener('click', function(event) {
    const menu = document.getElementById('dropdownMenu');
    const icon = document.querySelector('.menu-icon');
    
    if (!menu.contains(event.target) && !icon.contains(event.target)) {
        closeMenu();
    }
});

// إغلاق القائمة عند النقر على رابط
document.querySelectorAll('.dropdown-item').forEach(item => {
    item.addEventListener('click', function() {
        closeMenu();
    });
});

// ✅ عرض التنبيه
function showAlert(msg){
  let box = document.getElementById("alertBox");
  box.innerHTML = msg;
  box.style.display = "block";
  setTimeout(()=> box.style.display="none", 3000);
}

// ✅ عند تحميل الصفحة
window.onload = function() {
    if (userProfile && userProfile.name && userProfile.phone) {
        // عرض معلومات المستخدم
        document.getElementById('userInfo').style.display = 'block';
        document.getElementById('customerName').textContent = userProfile.name;
        document.getElementById('customerPhone').textContent = userProfile.phone;
        
        // تحميل الطلبات
        loadUserOrders(userProfile.phone);
    } else {
        // إذا لا توجد بيانات مستخدم
        document.getElementById('orders').innerHTML = `
            <div class="no-orders">
                <div style="font-size: 3rem; margin-bottom: 15px;">📝</div>
                <h3 style="color: #d63384;">بياناتك الشخصية مطلوبة</h3>
                <p>يجب تسجيل بياناتك الشخصية أولاً لعرض الطلبات</p>
                <button onclick="goToProfile()" class="btn-action" style="margin-top: 15px;">
                    👤 تسجيل البيانات
                </button>
            </div>
        `;
    }
};

// ✅ تحميل طلبات المستخدم
function loadUserOrders(userPhone) {
    db.ref("orders").on("value", function(snapshot) {
        let data = snapshot.val();
        let container = document.getElementById("orders");
        
        if (!data) {
            container.innerHTML = '<div class="no-orders">🚫 لا توجد طلبات في قاعدة البيانات</div>';
            return;
        }

        let userOrders = [];
        
        // البحث في جميع الطلبات
        Object.entries(data).forEach(([orderId, order]) => {
            // التحقق إذا كان الرقم مطابق
            if (order.customer && order.customer.phone === userPhone) {
                userOrders.push({
                    id: orderId,
                    ...order
                });
            }
        });

        if (userOrders.length === 0) {
            container.innerHTML = `
                <div class="no-orders">
                    <div style="font-size: 3rem; margin-bottom: 15px;">📭</div>
                    <h3 style="color: #d63384;">لا توجد طلبات</h3>
                    <p>لم تقم بإرسال أي طلبات بعد</p>
                    <button onclick="goToStore()" class="btn-action" style="margin-top: 15px;">
                        🛍️ تسوق الآن
                    </button>
                </div>
            `;
            return;
        }

        // عرض الطلبات من الأحدث إلى الأقدم
        container.innerHTML = '';
        userOrders.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        
        userOrders.forEach(order => {
            let itemsHtml = "<ul style='padding-right: 15px; margin: 10px 0;'>";
            
            if (order.items && Array.isArray(order.items)) {
                order.items.forEach(item => {
                    itemsHtml += `
                        <li style="margin-bottom: 8px; padding: 5px 0; border-bottom: 1px dashed #eee;">
                            <strong>${item.name}</strong>
                            ${item.size ? ` - مقاس: ${item.size}` : ''}
                            ${item.color ? ` - لون: ${item.color}` : ''}
                            ${item.type ? ` - نوع: ${item.type}` : ''}
                            <br>
                            <small>الكمية: ${item.qty || 1} × السعر: ${item.price || 0} د.ل</small>
                            <br>
                            <strong>المجموع: ${(item.price || 0) * (item.qty || 1)} د.ل</strong>
                        </li>
                    `;
                });
            } else {
                itemsHtml += "<li>لا توجد تفاصيل للمنتجات</li>";
            }
            itemsHtml += "</ul>";

            let statusClass = getStatusClass(order.status || "قيد الانتظار");
            let statusText = getStatusText(order.status || "قيد الانتظار");
            
            let actionBtn = "";
            if (order.status === "ملغى") {
                actionBtn = `<button class="btn-action" onclick="restoreOrder('${order.id}')" style="background:linear-gradient(45deg, #28a745, #20c997);">🔄 إعادة إرسال الطلب</button>`;
            } else if (order.status !== "قيد التوصيل" && order.status !== "تم التسليم" && order.status !== "ملغى") {
                actionBtn = `<button class="btn-action" onclick="deleteOrder('${order.id}')" style="background:linear-gradient(45deg, #dc3545, #c82333);">🗑 إلغاء الطلب</button>`;
            }

            let orderDiv = document.createElement("div");
            orderDiv.className = "order";
            orderDiv.innerHTML = `
                <h3>🛍️ طلبية #${order.id.substring(0, 8)}</h3>
                <div style="margin: 10px 0;">
                    ${itemsHtml}
                </div>
                <p><strong>💰 الإجمالي الكلي: ${order.total || 0} د.ل</strong></p>
                <p>📍 العنوان: ${order.customer?.city || 'غير محدد'}, ${order.customer?.address || 'غير محدد'}</p>
                <p>📅 التاريخ: ${order.timestamp ? new Date(order.timestamp).toLocaleString('ar-EG') : 'غير محدد'}</p>
                <p>📌 الحالة: <span class="status ${statusClass}">${statusText}</span></p>
                <div style="margin-top: 15px;">
                    ${actionBtn}
                </div>
            `;
            container.appendChild(orderDiv);
        });
    }, function(error) {
        console.error("❌ خطأ في جلب البيانات:", error);
        document.getElementById('orders').innerHTML = `
            <div class="no-orders">
                <div style="font-size: 3rem; margin-bottom: 15px;">❌</div>
                <h3 style="color: #d63384;">خطأ في الاتصال</h3>
                <p>تعذر تحميل الطلبات. تأكد من اتصال الإنترنت.</p>
                <button onclick="location.reload()" class="btn-action" style="background:#6c757d; margin-top:15px;">
                    🔄 إعادة المحاولة
                </button>
            </div>
        `;
    });
}

// ✅ دوال مساعدة للحالة
function getStatusText(status) {
    const statusMap = {
        'قيد الانتظار': '⏳ قيد الانتظار',
        'تم التأكيد': '✅ تم التأكيد', 
        'قيد التوصيل': '🚚 قيد التوصيل',
        'تم التسليم': '🎉 تم التسليم',
        'ملغى': '❌ ملغى'
    };
    return statusMap[status] || status;
}

function getStatusClass(status) {
    const classMap = {
        'قيد الانتظار': 'status-pending',
        'تم التأكيد': 'status-confirmed',
        'قيد التوصيل': 'status-shipping', 
        'تم التسليم': 'status-delivered',
        'ملغى': 'status-cancelled'
    };
    return classMap[status] || 'status-pending';
}

// ✅ دوال الإجراءات
function deleteOrder(orderId) {
    if (confirm("⚠️ هل أنت متأكد من أنك تريد إلغاء هذا الطلب؟")) {
        db.ref("orders/" + orderId).update({ status: "ملغى" })
        .then(() => {
            showAlert("✅ تم إلغاء الطلب بنجاح");
        })
        .catch(error => {
            showAlert("❌ خطأ في إلغاء الطلب");
        });
    }
}

function restoreOrder(orderId) {
    if (confirm("🔄 هل تريد إعادة إرسال هذا الطلب؟")) {
        db.ref("orders/" + orderId).update({ status: "قيد الانتظار" })
        .then(() => {
            showAlert("✅ تم إعادة إرسال الطلب بنجاح");
        })
        .catch(error => {
            showAlert("❌ خطأ في إعادة الإرسال");
        });
    }
}

// ✅ دوال التنقل
function goToProfile() {
    window.location.href = 'profile.html';
}

function goToStore() {
    window.location.href = 'index.html';
}
</script>

</body>
</html>