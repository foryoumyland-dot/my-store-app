<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>طلباتي</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
  body { font-family: Tahoma; background:#f9f9f9; padding:20px; direction: rtl; }
  h2 { color:#d63384; text-align:center; margin-top:55px; } /* عدلت الهامش العلوي ليتوافق مع شريط التنقل */
  .order { background:#fff; padding:15px; margin:10px 0; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
  .order h3 { margin:0 0 8px; color:#333; }
  .status { font-weight:bold; color:#d63384; }
  .input-phone { text-align:center; margin:20px 0; }
  .input-phone input { padding:8px; font-size:16px; border:1px solid #ccc; border-radius:4px; width:220px; text-align:center; }
  .input-phone button { margin-top:10px; padding:8px 14px; background:#d63384; color:#fff; border:none; border-radius:4px; cursor:pointer; }
  #currentPhoneBox { text-align:center; margin-bottom:20px; }
  #currentPhoneBox input { padding:8px; font-size:16px; border:1px solid #ccc; border-radius:4px; width:220px; text-align:center; background:#eee; }
  #changePhone { margin-top:10px; padding:6px 14px; background:#6c757d; color:#fff; border:none; border-radius:4px; cursor:pointer; }
  .btn-delete { background:#e63946; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; margin-top:10px; }
  .btn-restore { background:#198754; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; margin-top:10px; }

  /* ===== شريط التنقل العلوي ===== */
  .navbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 40px;
      background: rgba(255, 255, 255, 0.98);
      box-shadow: 0 2px 15px rgba(255, 105, 180, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
  }
  .nav-container { display:flex; align-items:center; }
  .nav-divider { width:1px; height:15px; background:#ffb6c1; margin:0 12px; }
  .nav-item { padding:5px 15px; text-decoration:none; color:#d63384; font-weight:700; font-size:0.8rem; transition:all 0.3s ease; border-radius:20px; }
  .nav-item:hover { background: linear-gradient(45deg, #ff69b4, #ff1493); color:white; transform:translateY(-2px); box-shadow:0 5px 15px rgba(255,105,180,0.3); }
  .nav-item.active { background: linear-gradient(45deg, #ff69b4, #ff1493); color:white; }
</style>
</head>
<body>

<!-- شريط التنقل -->
<nav class="navbar">
    <div class="nav-container">
        <a href="home.html" class="nav-item">الصفحة الرئيسية</a>
        <div class="nav-divider"></div>
        <a href="products.html" class="nav-item">المنتجات</a>
        <div class="nav-divider"></div>
        <a href="orders.html" class="nav-item active">طلباتي</a>
    </div>
</nav>

<h2>📦 طلبـــــــاتي</h2>

<!-- ✅ إدخال رقم الهاتف -->
<div class="input-phone" id="phoneBox">
  <input type="text" id="phoneInput" placeholder="📱 أدخل رقم هاتفك">
  <button onclick="savePhone()">تأكيد</button>
</div>

<!-- ✅ عرض الرقم الحالي -->
<div id="currentPhoneBox" style="display:none;">
  <input type="text" id="currentPhone" readonly>
  <br>
  <button id="changePhone" onclick="resetPhone()">🔄 تغيير الرقم</button>
</div>

<!-- ✅ الطلبات -->
<div id="orders"></div>

<script>
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "mystore-orders-a74f8.firebaseapp.com",
  databaseURL: "https://mystore-orders-a74f8-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "mystore-orders-a74f8",
  storageBucket: "mystore-orders-a74f8.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);

let userPhone = localStorage.getItem("userPhone");

if(userPhone){
  showCurrentPhone(userPhone);
  loadOrders(userPhone);
}

function savePhone(){
  let phone = document.getElementById("phoneInput").value.trim();
  if(!phone.startsWith("09") || phone.length !== 10){
    alert("⚠ الرجاء إدخال رقم هاتف صحيح يبدأ بـ 09");
    return;
  }
  localStorage.setItem("userPhone", phone);
  showCurrentPhone(phone);
  loadOrders(phone);
}

function showCurrentPhone(phone){
  document.getElementById("phoneBox").style.display = "none";
  document.getElementById("currentPhoneBox").style.display = "block";
  document.getElementById("currentPhone").value = phone;
}

function resetPhone(){
  localStorage.removeItem("userPhone");
  document.getElementById("phoneBox").style.display = "block";
  document.getElementById("currentPhoneBox").style.display = "none";
  document.getElementById("orders").innerHTML = "";
}

function deleteOrder(orderId){
  if(confirm("❌ هل أنت متأكد أنك تريد حذف هذه الطلبية؟")){
    firebase.database().ref("orders/" + orderId).update({ status: "تم الحذف من الزبون" });
  }
}

function restoreOrder(orderId){
  if(confirm("♻ هل تريد إعادة إرسال هذه الطلبية؟")){
    firebase.database().ref("orders/" + orderId).update({ status: "قيد التنفيذ" });
  }
}

function loadOrders(phone){
  firebase.database().ref("orders").on("value", snapshot => {
    let data = snapshot.val();
    let container = document.getElementById("orders");
    container.innerHTML = "";

    if(!data){
      container.innerHTML = "<p>🚫 لا توجد طلبات</p>";
      return;
    }

    let userOrders = Object.entries(data).filter(([id, order]) => order.phone === phone);

    if(userOrders.length === 0){
      container.innerHTML = "<p>🚫 لا توجد طلبات لهذا الرقم</p>";
      return;
    }

    userOrders.reverse().forEach(([id, order]) => {
      let itemsHtml = "<ul>";
      order.items.forEach(i => {
        itemsHtml += <li>${i.name} × ${i.qty} = ${i.price * i.qty} د</li>;
      });
      itemsHtml += "</ul>";

      let actionBtn = "";
      if(order.status === "تم الحذف من الزبون"){
        actionBtn = <button class="btn-restore" onclick="restoreOrder('${id}')">♻ إعادة إرسال الطلب</button>;
      } else if(order.status !== "قيد التوصيل" && order.status !== "تم التسليم"){
        actionBtn = <button class="btn-delete" onclick="deleteOrder('${id}')">🗑 حذف الطلب</button>;
      }

      let div = document.createElement("div");
      div.className = "order";
      div.innerHTML = `
        <h3>🛍 المنتجات:</h3>
        ${itemsHtml}
        <p>🚚 سعر التوصيل: ${order.delivery || 0} د</p>
        <p><b>💵 الإجمالي الكلي: ${order.finalTotal || order.total} د</b></p>
        <p>📍 العنوان: ${order.city}, ${order.address}</p>
        <p>📅 التاريخ: ${order.date}</p>
        <p>📌 الحالة: <span class="status">${order.status || "قيد التنفيذ"}</span></p>
        ${actionBtn}
      `;
      container.appendChild(div);
    });
  });
}
</script>

</body>
</html>
