<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تسجيل الدخول - متجرك</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background: #ffe6f0; font-family: Arial, sans-serif; }
.container { max-width: 400px; margin-top: 80px; background: #fff0f5; padding: 30px; border-radius: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.06); text-align: center; }

/* الدائرة والصورة - معدلة ومتناسقة */
.logo-circle { 
  width: 160px; 
  height: 160px; 
  margin: 0 auto 20px; 
  border-radius: 50%; 
  background: transparent; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  overflow: hidden;
  position: relative;
  padding: 8px; /* مساحة للتوهج */
}

.logo-circle::before {
  content: '';
  position: absolute;
  top: -5px;
  left: -5px;
  right: -5px;
  bottom: -5px;
  border-radius: 50%;
  background: linear-gradient(45deg, #ff6b9d, #ff99cc, #ff6b9d, #ff66b2);
  z-index: -1;
  animation: glow 2s ease-in-out infinite alternate;
  filter: blur(8px);
  opacity: 0.8;
}

.logo-circle::after {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  border-radius: 50%;
  background: linear-gradient(45deg, #ff6b9d, #ff99cc, #ff6b9d);
  z-index: -1;
  animation: glow-border 3s ease-in-out infinite alternate;
}

.logo-circle img { 
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid white;
  box-shadow: 0 0 0 4px #ff99cc;
  position: relative;
  z-index: 1;
}

@keyframes glow {
  0% {
    box-shadow: 0 0 20px #ff6b9d, 0 0 30px rgba(255, 107, 157, 0.6);
  }
  50% {
    box-shadow: 0 0 25px #ff99cc, 0 0 35px rgba(255, 153, 204, 0.7);
  }
  100% {
    box-shadow: 0 0 30px #ff66b2, 0 0 40px rgba(255, 102, 178, 0.8);
  }
}

@keyframes glow-border {
  0% {
    box-shadow: 0 0 15px #ff6b9d;
  }
  50% {
    box-shadow: 0 0 20px #ff99cc;
  }
  100% {
    box-shadow: 0 0 25px #ff66b2;
  }
}

.input-group { direction: ltr; margin-bottom: 10px; }
.input-group .form-control { border-top-left-radius: 0; border-bottom-left-radius: 0; border-top-right-radius: 8px; border-bottom-right-radius: 8px; text-align: left; padding-right: 12px; }
.input-group .input-group-text { width: 56px; background: #ff66b2; color: #fff; font-weight: 700; border: none; }

.error-msg { background:#ffe6f0; color:#d63384; font-weight:bold; padding:10px 15px; border-radius:12px; margin:10px 0; display:none; }
.small-link { font-size:0.9rem; cursor:pointer; color:#d63384; margin:10px 0; }
.small-link:hover { text-decoration: underline; }

/* زر فيسبوك */
.facebook-btn { 
    background: #1877F2; 
    color: white; 
    padding: 12px 20px;
    border: none; 
    border-radius: 10px; 
    font-size: 1rem; 
    font-weight: bold; 
    cursor: pointer;
    width: 100%;
    margin: 10px 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.3s ease;
}
.facebook-btn:hover {
    background: #166FE5;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(24, 119, 242, 0.3);
}

/* مربع OTP */
#otp-box {
  display: none; 
  background:#ffe6f0; 
  padding:25px; 
  border-radius:20px; 
  box-shadow:0 0 20px rgba(255,102,178,0.3); 
  text-align:center; 
  margin-top:15px;
}
#otp-box input {
  text-align:center; 
  font-size:1.2rem; 
  padding:8px; 
  border-radius:10px; 
  border:2px solid #ff66b2; 
  width: 60%;
}
#otp-box button {
  margin-top:15px; 
  background:#ff66b2; 
  color:white; 
  padding:10px 25px; 
  border:none; 
  border-radius:15px;
  font-weight:bold;
}
#otp-box p { margin-bottom:10px; font-weight:bold; color:#d63384; }

/* تحسين حقول الإدخال للجوال */
.form-control {
  font-size: 16px;
  padding: 12px 15px;
  border: 2px solid #e9ecef;
  transition: all 0.3s ease;
}

.form-control:focus {
  border-color: #ff66b2;
  box-shadow: 0 0 0 0.2rem rgba(255, 102, 178, 0.25);
}
</style>
</head>
<body>

<div class="container">
  <div class="logo-circle">
    <img src="https://i.postimg.cc/k5MKqjrP/inbound4957539369074756001.png" alt="Logo">
  </div>

  <div id="error-msg" class="error-msg"></div>

  <!-- تسجيل الدخول -->
  <div id="login-form">
    <div class="input-group mb-3">
      <span class="input-group-text">+218</span>
      <input type="text" id="login-phone" class="form-control" placeholder="رقم الهاتف" maxlength="9" inputmode="numeric" pattern="[0-9]*" />
    </div>
    <input type="password" id="login-password" class="form-control" placeholder="كلمة السر">
    <button class="btn btn-pink w-100 mb-2" style="background:#ff66b2;color:white;" id="login-btn">تسجيل الدخول</button>
    
    <!-- زر فيسبوك -->
    <button class="facebook-btn" id="facebook-login-btn">
        <span>تسجيل الدخول بـ فيسبوك</span>
        <span>📘</span>
    </button>

    <div class="small-link" id="show-register">إنشاء حساب</div>
    <hr>
  </div>

  <!-- إنشاء الحساب -->
  <div id="register-form" style="display:none;">
    <input type="text" id="reg-firstname" class="form-control" placeholder="الاسم الأول" autocomplete="given-name">
    <input type="text" id="reg-lastname" class="form-control" placeholder="اللقب" autocomplete="family-name">
    <div class="input-group mb-3">
      <span class="input-group-text">+218</span>
      <input type="text" id="reg-phone" class="form-control" placeholder="رقم الهاتف" maxlength="9" inputmode="numeric" pattern="[0-9]*" autocomplete="tel">
    </div>
    <input type="password" id="reg-password" class="form-control" placeholder="كلمة السر" autocomplete="new-password">
    <input type="password" id="reg-password-confirm" class="form-control" placeholder="تأكيد كلمة السر" autocomplete="new-password">
    <button class="btn btn-pink w-100 mb-2" style="background:#ff66b2;color:white;" id="register-btn">إنشاء حساب</button>
    <div class="small-link" id="resend-otp" style="display:none;">إعادة إرسال الرمز</div>
    <div class="small-link" id="show-login">الرجوع لتسجيل الدخول</div>
    <div id="otp-box">
      <p id="otp-message">أدخل رمز التحقق الذي وصلك:</p>
      <input type="text" id="otp-input" placeholder="رمز التحقق" maxlength="6" inputmode="numeric">
      <button id="otp-verify-btn">تحقق</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithPopup, FacebookAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDInTSRi4Lf_KO_ltoAajJhBOHTmfnCIvU",
  authDomain: "store-email-1846c.firebaseapp.com",
  databaseURL: "https://store-email-1846c-default-rtdb.firebaseio.com",
  projectId: "store-email-1846c",
  storageBucket: "store-email-1846c.firebasestorage.app",
  messagingSenderId: "238351247429",
  appId: "1:238351247429:web:5d83284ed44dc2e5ac5b2c",
  measurementId: "G-MJE9WCQCCM"
};

// تهيئة Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const errorMsg = document.getElementById("error-msg");
function showError(text){
  errorMsg.textContent = text;
  errorMsg.style.display = "block";
  setTimeout(()=>{ errorMsg.style.display = "none"; }, 5000);
}

function showRegister(){
  document.getElementById('login-form').style.display='none';
  document.getElementById('register-form').style.display='block';
  document.getElementById("otp-box").style.display = "none";
  document.getElementById("resend-otp").style.display = "none";
}

function showLogin(){
  document.getElementById('login-form').style.display='block';
  document.getElementById('register-form').style.display='none';
}

// التحقق من صحة أرقام الهاتف
document.querySelectorAll("#reg-phone, #login-phone").forEach(input=>{
  input.addEventListener("input",function(){ 
    this.value = this.value.replace(/\D/g,''); 
    if(this.value.length>9) this.value=this.value.slice(0,9); 
  });
});

function validatePhone(phone){
  if(phone.length!==9){ showError("رقم الهاتف يجب أن يكون 9 أرقام"); return false;}
  if(!phone.startsWith("91") && !phone.startsWith("92")){ showError("رقم الهاتف يجب أن يبدأ بـ 91 أو 92"); return false;}
  return true;
}

// تسجيل الدخول بفيسبوك
document.getElementById("facebook-login-btn").addEventListener("click", async function(){
    try {
        const provider = new FacebookAuthProvider();
        const result = await signInWithPopup(auth, provider);
        
        // حفظ بيانات المستخدم
        const user = result.user;
        localStorage.setItem("currentUser", JSON.stringify({
            uid: user.uid,
            displayName: user.displayName || "مستخدم فيسبوك",
            email: user.email,
            photoURL: user.photoURL
        }));
        
        // رسالة نجاح
        alert("✅ تم تسجيل الدخول بفيسبوك بنجاح!");
        
        // تحويل للصفحة الرئيسية
        setTimeout(() => {
            window.location.href = "home.html";
        }, 1000);
        
    } catch (error) {
        console.error("خطأ في تسجيل فيسبوك:", error);
        showError("❌ فشل تسجيل الدخول بفيسبوك");
    }
});

// إنشاء الحساب
document.getElementById("register-btn").addEventListener("click", async ()=>{
  const fname = document.getElementById("reg-firstname").value.trim();
  const lname = document.getElementById("reg-lastname").value.trim();
  const phone = document.getElementById("reg-phone").value.trim();
  const pass = document.getElementById("reg-password").value;
  const passc = document.getElementById("reg-password-confirm").value;

  if(!fname || !lname || !phone || !pass || !passc){ 
    showError("تأكد من تعبئة جميع الحقول"); 
    return; 
  }
  if(pass!==passc){ 
    showError("⚠️ كلمة السر غير متطابقة"); 
    return; 
  }
  if(!validatePhone(phone)) return;

  const fullPhone="+218"+phone;
  const email = `${phone}@store.com`;

  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
    const user = userCredential.user;
    
    const otp = Math.floor(100000+Math.random()*900000);
    localStorage.setItem("otp-temp", otp);
    localStorage.setItem("new-user", JSON.stringify({
      fname, lname, phone: fullPhone, 
      uid: user.uid, email
    }));

    alert("✅ تم إرسال رمز التحقق: " + otp);
    
    document.getElementById("otp-message").textContent = "أدخل رمز التحقق الذي وصلك:";
    document.getElementById("resend-otp").style.display="block";
    document.getElementById("otp-box").style.display = "block";

  } catch (error) {
    console.error("Error creating account:", error);
    showError("❌ حدث خطأ في إنشاء الحساب");
  }
});

// التحقق من OTP
document.getElementById("otp-verify-btn").addEventListener("click", async ()=>{
  const userOtp = document.getElementById("otp-input").value.trim();
  const savedOtp = localStorage.getItem("otp-temp");
  
  if(!userOtp) {
    alert("❌ الرجاء إدخال رمز التحقق");
    return;
  }
  
  if(userOtp !== savedOtp){
    alert("❌ الرمز غير صحيح"); 
    return;
  }

  const userData = JSON.parse(localStorage.getItem("new-user"));
  
  if (!userData) {
    alert("❌ بيانات المستخدم غير موجودة");
    return;
  }

  try {
    await set(ref(db, "users/" + userData.uid), {
      firstName: userData.fname,
      lastName: userData.lname,
      phone: userData.phone,
      email: userData.email,
      createdAt: new Date().toISOString()
    });

    localStorage.removeItem("otp-temp");
    localStorage.removeItem("new-user");
    
    alert("✅ تم إنشاء الحساب بنجاح!");
    
    setTimeout(()=>{ 
      document.getElementById("reg-firstname").value = "";
      document.getElementById("reg-lastname").value = "";
      document.getElementById("reg-phone").value = "";
      document.getElementById("reg-password").value = "";
      document.getElementById("reg-password-confirm").value = "";
      document.getElementById("otp-input").value = "";
      document.getElementById("otp-box").style.display = "none";
      document.getElementById("resend-otp").style.display = "none";
      
      showLogin();
    }, 2000);

  } catch (error) {
    console.error("❌ خطأ في حفظ البيانات:", error);
    alert("❌ حدث خطأ في إنشاء الحساب");
  }
});

// تسجيل الدخول العادي
document.getElementById("login-btn").addEventListener("click",async ()=>{
  const phone=document.getElementById("login-phone").value.trim();
  const pass=document.getElementById("login-password").value;
  
  if(!phone || !pass){
    showError("تأكد من إدخال جميع الحقول"); 
    return;
  }
  
  if(!validatePhone(phone)) return;
  
  const email = `${phone}@store.com`;

  try {
    const userCredential = await signInWithEmailAndPassword(auth, email, pass);
    const user = userCredential.user;

    const dbRef = ref(db);
    const snapshot = await get(child(dbRef, "users/" + user.uid));
    
    if(!snapshot.exists()){
      showError("❌ لا توجد بيانات للمستخدم"); 
      return;
    }
    
    const userData = snapshot.val();

    localStorage.setItem("currentUser", JSON.stringify({
      uid: user.uid,
      phone: userData.phone,
      firstName: userData.firstName,
      lastName: userData.lastName
    }));

    alert("✅ تم تسجيل الدخول بنجاح!");
    
    setTimeout(() => {
      window.location.href="home.html";
    }, 1500);
    
  } catch (error) {
    console.error("Login error:", error);
    if(error.code === 'auth/user-not-found') {
      showError("❌ لا يوجد حساب بهذا الرقم");
    } else if(error.code === 'auth/wrong-password') {
      showError("⚠️ كلمة السر خاطئة");
    } else {
      showError("❌ حدث خطأ في تسجيل الدخول");
    }
  }
});

// إعادة إرسال OTP
document.getElementById("resend-otp").addEventListener("click", function(){
  const otp = Math.floor(100000+Math.random()*900000);
  localStorage.setItem("otp-temp", otp);
  alert("✅ تم إرسال رمز جديد: " + otp);
});

document.getElementById("show-register").addEventListener("click",showRegister);
document.getElementById("show-login").addEventListener("click",showLogin);
</script>

</body>
</html>