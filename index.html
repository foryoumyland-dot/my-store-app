<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تسجيل الدخول - متجرك</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background: #ffe6f0; font-family: Arial, sans-serif; }
.container { max-width: 400px; margin-top: 80px; background: #fff0f5; padding: 30px; border-radius: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.06); text-align: center; }

.logo-circle { 
  width: 150px;  
  height: 150px;
  margin: 0 auto 20px; 
  border-radius: 50%; 
  background: white; 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  box-shadow: 0 0 0 5px #ff99cc, 0 6px 25px rgba(255,102,178,0.4);
  overflow: hidden;
  position: relative;
}
.logo-circle::before {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  border-radius: 50%;
  background: linear-gradient(45deg, #ff66b2, #ff99cc, #ff66b2);
  z-index: -1;
  animation: glow 2s ease-in-out infinite alternate;
}
.logo-circle img { 
  width: 100%;
  height: 100%;
  border-radius: 50%; 
  object-fit: cover;
  padding: 5px;
}

@keyframes glow {
  from {
    box-shadow: 0 0 10px #ff66b2, 0 0 20px #ff66b2;
  }
  to {
    box-shadow: 0 0 15px #ff66b2, 0 0 30px #ff66b2, 0 0 40px #ff66b2;
  }
}

input { margin-bottom: 15px; }
.small-link { font-size:0.9rem; cursor:pointer; color:#d63384; }
.small-link:hover { text-decoration: underline; }

/* إشعارات */
.otp-notification { 
  position: fixed; top: -80px; left:50%; transform:translateX(-50%); 
  background:#ff66b2; color:white; padding:12px 25px; 
  border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.18); 
  transition: top 0.5s ease; z-index:1000; font-weight:bold; 
}

/* دمج +218 مع الرقم - محسن */
.input-group { direction: ltr; margin-bottom: 10px; }
.input-group .form-control {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
  border-top-right-radius: 8px;
  border-bottom-right-radius: 8px;
  text-align: left;
  padding-right: 12px;
}
.input-group .input-group-text {
  width: 56px;
  min-width: 56px;
  padding: 6px 8px;
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
  border-top-left-radius: 8px;
  border-bottom-left-radius: 8px;
  background: #ff66b2;
  color: #fff;
  font-weight: 700;
  border: none;
}

/* مربع OTP أنيق */
#otp-box {
  display: none; 
  background:#ffe6f0; 
  padding:25px; 
  border-radius:20px; 
  box-shadow:0 0 20px rgba(255,102,178,0.3); 
  text-align:center; 
  margin-top:15px;
  animation: fadeIn 0.5s ease;
}
#otp-box input {
  text-align:center; 
  font-size:1.2rem; 
  padding:8px; 
  border-radius:10px; 
  border:2px solid #ff66b2; 
  width: 60%;
}
#otp-box button {
  margin-top:15px; 
  background:#ff66b2; 
  color:white; 
  padding:10px 25px; 
  border:none; 
  border-radius:15px;
  font-weight:bold;
}
#otp-box p { margin-bottom:10px; font-weight:bold; color:#d63384; }

/* الرسائل الخطأ */
.error-msg { 
  background:#ffe6f0; 
  color:#d63384; 
  font-weight:bold; 
  padding:10px 15px; 
  border-radius:12px; 
  margin:10px 0; 
  box-shadow:0 0 10px rgba(255,102,178,0.2);
  display:none;
  animation: fadeIn 0.5s ease;
}

.success-msg { 
  background:#e8f5e8; 
  color:#2e7d32; 
  font-weight:bold; 
  padding:10px 15px; 
  border-radius:12px; 
  margin:10px 0; 
  box-shadow:0 0 10px rgba(46,125,50,0.2);
  display:none;
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn { from{opacity:0} to{opacity:1} }

@media (max-width:420px){
  .container{ padding:20px; margin-top:50px; }
  .logo-circle{ width:120px; height:120px; }
}
</style>
</head>
<body>

<div class="container">
  <div class="logo-circle">
    <img src="https://i.postimg.cc/ZnjyZNZX/inbound1511225684022120209.png" alt="Logo">
  </div>

  <div id="error-msg" class="error-msg"></div>
  <div id="success-msg" class="success-msg"></div>

  <!-- تسجيل الدخول -->
  <div id="login-form">
    <div class="input-group mb-3">
      <span class="input-group-text">+218</span>
      <input type="text" id="login-phone" class="form-control" placeholder="رقم الهاتف" maxlength="9" inputmode="numeric" pattern="[0-9]*" />
    </div>
    <input type="password" id="login-password" class="form-control" placeholder="كلمة السر">
    <button class="btn btn-pink w-100 mb-2" style="background:#ff66b2;color:white;" id="login-btn">تسجيل الدخول</button>
    <div class="small-link" id="show-register">إنشاء حساب</div>
    <hr>
  </div>

  <!-- إنشاء الحساب -->
  <div id="register-form" style="display:none;">
    <input type="text" id="reg-firstname" class="form-control" placeholder="الاسم الأول">
    <input type="text" id="reg-lastname" class="form-control" placeholder="اللقب">
    <div class="input-group mb-3">
      <span class="input-group-text">+218</span>
      <input type="text" id="reg-phone" class="form-control" placeholder="رقم الهاتف" maxlength="9" inputmode="numeric" pattern="[0-9]*" />
    </div>
    <input type="password" id="reg-password" class="form-control" placeholder="كلمة السر">
    <input type="password" id="reg-password-confirm" class="form-control" placeholder="تأكيد كلمة السر">
    <button class="btn btn-pink w-100 mb-2" style="background:#ff66b2;color:white;" id="register-btn">إنشاء حساب</button>
    <div class="small-link" id="resend-otp" style="display:none;">إعادة إرسال الرمز</div>
    <div class="small-link" id="show-login">الرجوع لتسجيل الدخول</div>
    <div id="otp-box">
      <p id="otp-message">أدخل رمز التحقق الذي وصلك:</p>
      <input type="text" id="otp-input" placeholder="رمز التحقق" maxlength="6" />
      <button id="otp-verify-btn">تحقق</button>
    </div>
  </div>
</div>

<div id="otp-notif" class="otp-notification"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDInTSRi4Lf_KO_ltoAajJhBOHTmfnCIvU",
  authDomain: "store-email-1846c.firebaseapp.com",
  databaseURL: "https://store-email-1846c-default-rtdb.firebaseio.com",
  projectId: "store-email-1846c",
  storageBucket: "store-email-1846c.firebasestorage.app",
  messagingSenderId: "238351247429",
  appId: "1:238351247429:web:5d83284ed44dc2e5ac5b2c",
  measurementId: "G-MJE9WCQCCM"
};

// تهيئة Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const errorMsg = document.getElementById("error-msg");
const successMsg = document.getElementById("success-msg");

function showError(text){
  errorMsg.textContent = text;
  errorMsg.style.display = "block";
  successMsg.style.display = "none";
  setTimeout(()=>{ errorMsg.style.display = "none"; }, 5000);
}

function showSuccess(text){
  successMsg.textContent = text;
  successMsg.style.display = "block";
  errorMsg.style.display = "none";
  setTimeout(()=>{ successMsg.style.display = "none"; }, 5000);
}

function showRegister(){
  document.getElementById('login-form').style.display='none';
  document.getElementById('register-form').style.display='block';
  document.getElementById("otp-box").style.display = "none";
  document.getElementById("resend-otp").style.display = "none";
  errorMsg.style.display = "none";
  successMsg.style.display = "none";
}

function showLogin(){
  document.getElementById('login-form').style.display='block';
  document.getElementById('register-form').style.display='none';
  errorMsg.style.display = "none";
  successMsg.style.display = "none";
}

// التحقق من صحة أرقام الهاتف
document.querySelectorAll("#reg-phone, #login-phone").forEach(input=>{
  input.addEventListener("input",function(){ 
    this.value = this.value.replace(/\D/g,''); 
    if(this.value.length>9) this.value=this.value.slice(0,9); 
  });
});

function validatePhone(phone){
  if(phone.length!==9){ showError("رقم الهاتف يجب أن يكون 9 أرقام"); return false;}
  if(!phone.startsWith("91") && !phone.startsWith("92")){ showError("رقم الهاتف يجب أن يبدأ بـ 91 أو 92"); return false;}
  return true;
}

// إشعار OTP محسن
function showOtpNotification(text, isSuccess = false){
  const notif=document.getElementById("otp-notif");
  notif.textContent=text;
  notif.style.background = isSuccess ? "#4CAF50" : "#ff66b2";
  notif.style.top="20px";
  setTimeout(()=>{notif.style.top="-80px";},15000);
}

function generateOtp(){ return Math.floor(100000+Math.random()*900000); }

function resendOtp(){
  const otp = generateOtp();
  localStorage.setItem("otp-temp", otp);
  showOtpNotification("✅ تم إرسال رمز جديد: " + otp);
}

document.getElementById("resend-otp").addEventListener("click", resendOtp);

// إنشاء الحساب
document.getElementById("register-btn").addEventListener("click", async ()=>{
  const fname = document.getElementById("reg-firstname").value.trim();
  const lname = document.getElementById("reg-lastname").value.trim();
  const phone = document.getElementById("reg-phone").value.trim();
  const pass = document.getElementById("reg-password").value;
  const passc = document.getElementById("reg-password-confirm").value;

  if(!fname || !lname || !phone || !pass || !passc){ 
    showError("تأكد من تعبئة جميع الحقول"); 
    return; 
  }
  if(pass!==passc){ 
    showError("⚠️ كلمة السر غير متطابقة"); 
    return; 
  }
  if(!validatePhone(phone)) return;

  const fullPhone = "+218"+phone;
  const email = `${phone}@store.com`; // نصنع بريد من الرقم

  try {
    // إنشاء حساب في Authentication
    const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
    const user = userCredential.user;
    
    const otp = generateOtp();
    localStorage.setItem("otp-temp", otp);
    localStorage.setItem("new-user", JSON.stringify({
      fname, lname, phone: fullPhone, 
      uid: user.uid, email
    }));

    showOtpNotification("✅ تم إرسال رمز التحقق إلى هاتفك: " + otp);
    
    document.getElementById("otp-message").textContent = "أدخل رمز التحقق الذي وصلك:";
    document.getElementById("resend-otp").style.display="block";
    document.getElementById("otp-box").style.display = "block";

  } catch (error) {
    console.error("Error creating account:", error);
    showError("❌ حدث خطأ في إنشاء الحساب: " + error.message);
  }
});

// التحقق من OTP
document.getElementById("otp-verify-btn").addEventListener("click", async ()=>{
  const userOtp = document.getElementById("otp-input").value.trim();
  const savedOtp = localStorage.getItem("otp-temp");
  
  if(!userOtp) {
    showOtpNotification("❌ الرجاء إدخال رمز التحقق");
    return;
  }
  
  if(userOtp !== savedOtp){
    showOtpNotification("❌ الرمز غير صحيح"); 
    return;
  }

  const userData = JSON.parse(localStorage.getItem("new-user"));
  
  if (!userData) {
    showOtpNotification("❌ بيانات المستخدم غير موجودة");
    return;
  }

  try {
    // حفظ البيانات في Database تحت UID المستخدم
    await set(ref(db, "users/" + userData.uid), {
      firstName: userData.fname,
      lastName: userData.lname,
      phone: userData.phone,
      email: userData.email,
      createdAt: new Date().toISOString()
    });

    console.log("✅ تم حفظ البيانات بنجاح في Firebase");

    localStorage.removeItem("otp-temp");
    localStorage.removeItem("new-user");
    
    showOtpNotification("✅ تم إنشاء الحساب بنجاح في قاعدة البيانات!", true);
    showSuccess("✅ تم إنشاء حسابك بنجاح! يمكنك الآن تسجيل الدخول");
    
    // تنظيف الحقول
    setTimeout(()=>{ 
      document.getElementById("reg-firstname").value = "";
      document.getElementById("reg-lastname").value = "";
      document.getElementById("reg-phone").value = "";
      document.getElementById("reg-password").value = "";
      document.getElementById("reg-password-confirm").value = "";
      document.getElementById("otp-input").value = "";
      document.getElementById("otp-box").style.display = "none";
      document.getElementById("resend-otp").style.display = "none";
      
      showLogin();
    }, 2000);

  } catch (error) {
    console.error("❌ خطأ في حفظ البيانات في Firebase:", error);
    showOtpNotification("❌ حدث خطأ في إنشاء الحساب: " + error.message);
  }
});

// تسجيل الدخول
document.getElementById("login-btn").addEventListener("click", async ()=>{
  const phone = document.getElementById("login-phone").value.trim();
  const pass = document.getElementById("login-password").value;
  
  if(!phone || !pass){
    showError("تأكد من إدخال جميع الحقول"); 
    return;
  }
  
  if(!validatePhone(phone)) return;
  
  const email = `${phone}@store.com`;

  try {
    // تسجيل الدخول بـ Authentication
    const userCredential = await signInWithEmailAndPassword(auth, email, pass);
    const user = userCredential.user;

    // جلب بيانات المستخدم من Database
    const dbRef = ref(db);
    const snapshot = await get(child(dbRef, "users/" + user.uid));
    
    if(!snapshot.exists()){
      showError("❌ لا توجد بيانات للمستخدم"); 
      return;
    }
    
    const userData = snapshot.val();

    localStorage.setItem("currentUser", JSON.stringify({
      uid: user.uid,
      phone: userData.phone,
      firstName: userData.firstName,
      lastName: userData.lastName
    }));

    showOtpNotification("تم تسجيل الدخول بنجاح ✅", true);
    showSuccess("✅ تم تسجيل الدخول بنجاح! يتم تحويلك...");
    
    setTimeout(() => {
      window.location.href="home.html";
    }, 1500);
    
  } catch (error) {
    console.error("Login error:", error);
    if(error.code === 'auth/user-not-found') {
      showError("❌ لا يوجد حساب بهذا الرقم");
    } else if(error.code === 'auth/wrong-password') {
      showError("⚠️ كلمة السر خاطئة");
    } else {
      showError("❌ حدث خطأ في تسجيل الدخول");
    }
  }
});

// إضافة إمكانية الضغط على Enter في الحقول
document.addEventListener('keypress', function(event) {
  if (event.key === 'Enter') {
    if (document.getElementById('login-form').style.display !== 'none') {
      document.getElementById('login-btn').click();
    } else {
      if (document.getElementById('otp-box').style.display !== 'none') {
        document.getElementById('otp-verify-btn').click();
      } else {
        document.getElementById('register-btn').click();
      }
    }
  }
});

document.getElementById("show-register").addEventListener("click",showRegister);
document.getElementById("show-login").addEventListener("click",showLogin);

// رسالة ترحيب عند التحميل
setTimeout(() => {
  showSuccess("✅ النظام الآمن جاهز! البيانات محمية الآن");
}, 1000);
</script>

</body>
</html>