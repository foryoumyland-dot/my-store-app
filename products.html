<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<base href="/my-store-app/">
<title>ğŸ›ï¸ Ù…ØªØ¬Ø±ÙŠ</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<style>
body { 
    background:#fff0f6; 
    font-family: Tahoma; 
    margin: 0; 
    padding: 0; 
    padding-bottom: 80px; 
    padding-top: 70px; 
}

.top-navbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 60px;
    background: linear-gradient(135deg, #ff69b4, #ff1493);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    z-index: 1000;
    box-shadow: 0 4px 20px rgba(255, 105, 180, 0.4);
    border-bottom: 2px solid #ffb6c1;
}

.store-name {
    color: white;
    font-weight: bold;
    font-size: 1.3rem;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    padding: 8px 20px;
    border-radius: 25px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    cursor: default;
    user-select: none;
    position: relative;
    overflow: hidden;
}

.store-name::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: left 0.5s;
}

.store-name:hover::before {
    left: 100%;
}

.menu-icon {
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    font-size: 1.4rem;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 12px;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.menu-icon:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
    border-color: rgba(255, 255, 255, 0.5);
}

.dropdown-menu {
    position: absolute;
    top: 65px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #ffffff, #fff5f7);
    border-radius: 15px;
    box-shadow: 0 8px 30px rgba(255, 105, 180, 0.3);
    padding: 0;
    min-width: 200px;
    display: none;
    z-index: 1001;
    border: 2px solid #ffe4ec;
    backdrop-filter: blur(10px);
    text-align: center;
}

.dropdown-menu.show {
    display: block;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

.dropdown-item {
    display: block;
    padding: 15px 20px;
    text-decoration: none;
    color: #d63384;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    border: none;
    background: none;
    width: 100%;
    text-align: center;
}

.dropdown-item:hover {
    background: linear-gradient(45deg, #fff0f6, #ffe4ec);
    color: #ff1493;
}

.menu-divider {
    width: 80%;
    height: 1px;
    background: linear-gradient(90deg, transparent, #ffb6c1, transparent);
    margin: 0 auto;
}

.overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: transparent;
    z-index: 999;
    display: none;
}

@media (max-width: 768px) {
    .top-navbar {
        height: 55px;
        padding: 0 15px;
    }
    
    .store-name {
        font-size: 1.1rem;
        padding: 6px 15px;
    }
    
    .menu-icon {
        font-size: 1.2rem;
        padding: 6px 10px;
    }
    
    .dropdown-menu {
        min-width: 180px;
        top: 60px;
    }
    
    .dropdown-item {
        padding: 12px 16px;
        font-size: 0.9rem;
    }
}

@media (max-width: 480px) {
    .top-navbar {
        height: 50px;
        padding: 0 10px;
    }
    
    .store-name {
        font-size: 1rem;
        padding: 5px 12px;
    }
    
    .menu-icon {
        font-size: 1.1rem;
        padding: 5px 8px;
    }
    
    .dropdown-menu {
        min-width: 160px;
        top: 55px;
    }
    
    .dropdown-item {
        padding: 10px 14px;
        font-size: 0.85rem;
    }
}

@media (min-width: 1200px) {
    .top-navbar {
        height: 65px;
        padding: 0 25px;
    }
    
    .store-name {
        font-size: 1.5rem;
        padding: 10px 25px;
    }
    
    .menu-icon {
        font-size: 1.6rem;
        padding: 10px 15px;
    }
    
    .dropdown-menu {
        min-width: 220px;
        top: 70px;
    }
    
    .dropdown-item {
        padding: 16px 22px;
        font-size: 1.1rem;
    }
}

.card img { height: auto; width: 100%; object-fit: contain; cursor:pointer; }

.products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px;
    padding: 15px;
}

.product-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(255, 105, 180, 0.1);
    border: 1px solid #ffe4ec;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(255, 105, 180, 0.2);
}

.product-card.out-of-stock {
    opacity: 0.4; 
    cursor: not-allowed;
}

.product-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 15px 15px 0 0;
    cursor: pointer;
}

.product-body {
    padding: 15px;
}

.product-title {
    font-size: 16px;
    font-weight: bold;
    color: #d63384;
    margin-bottom: 8px;
    line-height: 1.3;
}

.product-price {
    font-size: 18px;
    font-weight: bold;
    color: #e91e63;
    margin-bottom: 5px;
}

.product-stock {
    font-size: 12px;
    color: #666;
    margin-bottom: 10px;
}

.chip-group {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
}

.option-label {
    font-size: 14px;
    font-weight: bold;
    color: #d63384;
    min-width: 40px;
}

.option-radio {
    display: none;
}

.option-chip {
    padding: 4px 10px;
    border-radius: 12px;
    border: 2px solid #ffb6c1;
    color: #d63384;
    background-color: #fff5f7;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s ease;
    user-select: none;
}

.option-radio:checked + .option-chip {
    background-color: #ff69b4;
    color: white;
    border-color: #ff1493;
    box-shadow: 0 2px 5px rgba(255, 105, 180, 0.4);
    transform: scale(1.05);
}

/* ============= Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆØ±ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ============= */
@keyframes slideIn {
    from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
    to { transform: translateX(-50%) translateY(0); opacity: 1; }
}

@keyframes slideDown {
    from { transform: translateX(-50%) translateY(-30px); opacity: 0; }
    to { transform: translateX(-50%) translateY(0); opacity: 1; }
}

@keyframes alertPulse {
    0% { transform: translateX(-50%) scale(0.9); opacity: 0; }
    70% { transform: translateX(-50%) scale(1.05); }
    100% { transform: translateX(-50%) scale(1); opacity: 1; }
}

@keyframes pulse {
    0% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.05); }
    100% { transform: translate(-50%, -50%) scale(1); }
}

@keyframes popIn {
    0% { transform: translate(-50%, -50%) scale(0.7); opacity: 0; }
    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
}

/* ØªØ­Ø¯ÙŠØ« Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¹Ø·Ù„Ø© */
.option-chip.chip-disabled {
    opacity: 0.3;
    cursor: not-allowed !important;
    background-color: #f5f5f5 !important;
    color: #aaa !important;
    border-color: #ddd !important;
    position: relative;
}

.option-chip.chip-disabled::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 2px;
    background: #ff6b6b;
    transform: translateY(-50%) rotate(-45deg);
}

.chip-disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background-color: #f7f7f7 !important;
    color: #aaa !important;
    border-color: #eee !important;
    text-decoration: line-through;
}

.chip-disabled:hover {
    transform: none !important;
}

.heart-btn {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 18px;
    transition: all 0.3s ease;
    z-index: 10;
}

.heart-btn:hover {
    background: white;
    transform: scale(1.1);
}

.heart-btn.active {
    color: #e91e63;
}

#categoriesBar { 
    text-align: center; 
    margin: 20px 0; 
    padding: 0 15px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
}

#categoriesBar .btn { 
    border-radius: 20px; 
    padding: 8px 16px; 
    font-weight: bold;
    font-size: 14px;
    border: 2px solid #d63384;
    color: #d63384;
    background: white;
}

#categoriesBar .btn:hover,
#categoriesBar .btn.active {
    background: linear-gradient(45deg, #ff69b4, #ff1493);
    color: white;
    border-color: #ff69b4;
}

#cartIcon { 
    position: fixed; 
    bottom: 100px;
    right: 20px; 
    background: #d63384; 
    color: #fff; 
    padding: 12px 18px; 
    border-radius: 50%; 
    font-size: 24px; 
    cursor: pointer; 
    box-shadow: 0px 4px 15px rgba(255, 105, 180, 0.3); 
    z-index: 999; 
    transition: all 0.3s ease;
}

#cartIcon:hover {
    transform: scale(1.1);
    background: #e91e63;
}

#cartCount { 
    position: absolute; 
    top: -5px; 
    right: -5px; 
    background: #28a745; 
    color: #fff; 
    border-radius: 50%; 
    padding: 2px 7px; 
    font-size: 14px; 
}

#cartPanel { 
    position: fixed; 
    top: 60px;
    right: -400px; 
    width: 360px; 
    height: calc(100vh - 60px - 80px);
    background: #fff; 
    box-shadow: -2px 0 10px rgba(0,0,0,0.3); 
    transition: right 0.4s ease; 
    z-index: 1000; 
    padding: 20px; 
    overflow-y: auto; 
}

#cartPanel.open { right: 0; }

.cart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

#cartPanel h4 { 
    color:#d63384; 
    font-weight:bold;
    margin: 0;
}

.close-cart-btn {
    background: none;
    border: none;
    color: #ff1493;
    font-size: 1.8rem;
    cursor: pointer;
    font-weight: 300;
    transition: transform 0.2s;
}

.close-cart-btn:hover {
    transform: scale(1.1);
    color: #e91e63;
}

.cart-item-img {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 5px;
    margin-left: 10px;
    border: 1px solid #eee;
}

.alert-custom { 
    position: fixed; 
    top: 80px; 
    left: 50%; 
    transform: translateX(-50%); 
    background: linear-gradient(45deg, #ff416c, #ff4b2b); 
    color: white; 
    padding: 12px 20px; 
    border-radius: 8px; 
    font-size: 16px; 
    font-weight: bold; 
    z-index: 3000; 
    display: none; 
}

@media (max-width: 768px) {
    .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 12px;
        padding: 10px;
    }
    
    .product-image {
        height: 180px;
    }
}

@media (max-width: 480px) {
    .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 10px;
        padding: 8px;
    }
    
    .product-image {
        height: 160px;
    }
    
    .chip-group {
        gap: 6px;
    }

    .option-chip {
        padding: 3px 8px;
        font-size: 11px;
    }
    
    #categoriesBar .btn {
        font-size: 12px;
        padding: 6px 12px;
    }
    
    #cartIcon {
        bottom: 90px;
        right: 15px;
        padding: 10px 15px;
        font-size: 20px;
    }
    
    #cartPanel {
        width: 100%;
        right: -100%;
    }
}

.confirm-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 5000; justify-content: center; align-items: center; }
.confirm-content { background: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 5px 25px rgba(0,0,0,0.3); max-width: 400px; width: 90%; }
.confirm-buttons { margin-top: 20px; display: flex; gap: 10px; justify-content: center;}

.data-alert { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #ff69b4, #ff1493); color: white; padding: 30px; border-radius: 20px; font-size: 1.2rem; font-weight: bold; z-index: 2000; display: none; box-shadow: 0 15px 40px rgba(255, 105, 180, 0.5); text-align: center; border: 3px solid white; animation: alertPop 0.5s ease; }
.data-alert-buttons { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
.data-alert-btn { padding: 10px 20px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; }
.data-alert-btn.primary { background: white; color: #d63384; }
.data-alert-btn.secondary { background: rgba(255, 255, 255, 0.2); color: white; border: 2px solid white; }
.data-alert-btn:hover { transform: translateY(-2px); }
@keyframes alertPop { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); } 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); } }

.product-gallery { position: relative; width: 100%; height: 200px; overflow: hidden; border-radius: 15px 15px 0 0; }
.main-product-image { width: 100%; height: 100%; object-fit: cover; cursor: pointer; transition: transform 0.3s ease; }
.main-product-image:hover { transform: scale(1.05); }
.thumbnail-container { position: absolute; bottom: 10px; left: 0; right: 0; display: flex; justify-content: center; gap: 5px; padding: 0 10px; }
.thumbnail { width: 30px; height: 30px; object-fit: cover; border-radius: 4px; border: 2px solid transparent; cursor: pointer; opacity: 0.7; transition: all 0.3s ease; }
.thumbnail.active { border-color: #ff69b4; opacity: 1; }
.thumbnail:hover { opacity: 1; }
.image-nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255, 255, 255, 0.8); border: none; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; color: #d63384; transition: all 0.3s ease; z-index: 10; }
.image-nav-btn:hover { background: white; transform: translateY(-50%) scale(1.1); }
.image-nav-btn.prev { right: 10px; }
.image-nav-btn.next { left: 10px; }
.image-counter { position: absolute; top: 10px; left: 10px; background: rgba(0, 0, 0, 0.6); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; z-index: 10; }

.image-gallery-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 4000; justify-content: center; align-items: center; }
.gallery-main-image { max-width: 90%; max-height: 80%; object-fit: contain; border-radius: 10px; }
.gallery-thumbnails { position: absolute; bottom: 20px; left: 0; right: 0; display: flex; justify-content: center; gap: 10px; padding: 10px; }
.gallery-thumbnail { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border: 2px solid transparent; cursor: pointer; opacity: 0.7; transition: all 0.3s ease; }
.gallery-thumbnail.active { border-color: #ff69b4; opacity: 1; }
.gallery-thumbnail:hover { opacity: 1; }
.gallery-nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255, 255, 255, 0.2); border: none; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; color: white; transition: all 0.3s ease; }
.gallery-nav-btn:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-50%) scale(1.1); }
.gallery-nav-btn.prev { right: 20px; }
.gallery-nav-btn.next { left: 20px; }
.gallery-close { position: absolute; top: 20px; right: 20px; background: rgba(255, 255, 255, 0.2); border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; color: white; transition: all 0.3s ease; }
.gallery-close:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
.gallery-counter { position: absolute; top: 20px; left: 20px; color: white; font-size: 16px; font-weight: bold; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 10px; z-index: 10; }
</style>
</head>
<body>

<nav class="top-navbar">
    <button class="menu-icon" onclick="toggleMenu()">â˜°</button>
    
    <div class="store-name">Ø±ÙŠÙ€Ù€Ù€ÙÙ€Ù€Ù€Ù€REVANAÙ€Ù€Ù€Ù€Ø§Ù†Ù€Ù€Ù€Ù€Ø§</div>
    
    <div class="dropdown-menu" id="dropdownMenu">
        <a href="profile.html" class="dropdown-item" onclick="closeMenu()">ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ</a>
        <div class="menu-divider"></div>
        <a href="orders.html" class="dropdown-item" onclick="closeMenu()">ğŸ“¦ Ø·Ù„Ø¨Ø§ØªÙŠ</a>
    </div>
</nav>

<div class="overlay" id="overlay" onclick="closeMenu()"></div>

<div class="page-title" style="text-align: center; margin: 20px 0; color: #d63384; font-weight: bold; font-size: 2rem;">ğŸ›ï¸ Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§</div>

<div id="categoriesBar"></div>

<div class="products-grid" id="productsContainer">
    <div class="col-12 text-center loading-spinner" style="grid-column: 1 / -1; padding: 40px;">
        <div class="spinner-border text-primary" role="status"></div>
        <p style="color: #666; font-size: 16px; margin-top: 10px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…...</p>
    </div>
</div>

<div id="cartIcon">
  ğŸ›’ <span id="cartCount">0</span>
</div>

<div id="cartPanel">
  <div class="cart-header">
    <h4>ğŸ›’ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h4>
    <button onclick="closeCart()" class="close-cart-btn">âœ•</button>
  </div>
  <div id="cartItems"></div>
  <hr>
  <div id="cartTotal"></div>
  <button class="btn btn-success w-100 mt-2" onclick="confirmSendOrder()">âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
  <button class="btn btn-danger w-100 mt-2" onclick="confirmClearCart()">ğŸ—‘ï¸ ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©</button>
</div>

<div id="alertBox" class="alert-custom"></div>

<div id="dataAlert" class="data-alert">
    <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ“</div>
    <h4 style="margin-bottom: 15px;">Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ© Ù…Ø·Ù„ÙˆØ¨Ø©</h4>
    <p style="margin-bottom: 20px; line-height: 1.5;">ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</p>
    <div class="data-alert-buttons">
        <button class="data-alert-btn primary" onclick="goToProfile()">ğŸ‘¤ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button class="data-alert-btn secondary" onclick="closeDataAlert()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>
<div class="overlay" id="dataAlertOverlay" style="display: none;"></div>

<div id="confirmSendModal" class="confirm-modal">
  <div class="confirm-content">
    <h5 style="color: #d63384;">ğŸ“¦ ØªØ£ÙƒÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</h5>
    <p style="font-weight: bold; line-height: 1.7;">
        Ø³ÙŠØªÙ… ØªØ£ÙƒÙŠØ¯ Ùˆ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯ <span style="color: #ff1493;">{1 Ø³Ø§Ø¹Ø©}</span>.<br>
        ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ùˆ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù„ØºØ§Ø¦Ù‡ ÙÙŠ Ù‡Ø§Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª Ù…Ù† Ù‚Ø³Ù… "Ø·Ù„Ø¨Ø§ØªÙŠ"<br>
        <span style="color: #ff1493;">ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù„ØºØ§Ø¦Ù‡ Ø¨Ø¹Ø¯ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯.</span>
        <br><br>
        <span style="font-size: 0.9em; font-weight: normal;">"Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙÙ‡Ù…ÙƒÙ… Ùˆ Ù†ØªÙ…Ù†Ø§ Ù„ÙƒÙ… ØªØ³ÙˆÙ‚ Ù…Ù…ØªØ¹"</span>
    </p>
    <div class="confirm-buttons">
      <button class="btn btn-success" onclick="sendOrderFixed()">âœ… Ù†Ø¹Ù…ØŒ Ø¥Ø±Ø³Ø§Ù„</button>
      <button class="btn btn-secondary" onclick="closeConfirmSend()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<div id="confirmClearModal" class="confirm-modal">
  <div class="confirm-content">
    <h5 style="color: #d63384;">ğŸ—‘ï¸ ØªØ£ÙƒÙŠØ¯ ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©</h5>
    <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±.</p>
    <div class="confirm-buttons">
      <button class="btn btn-danger" onclick="clearCart()">âœ… Ù†Ø¹Ù…ØŒ ØªÙØ±ÙŠØº</button>
      <button class="btn btn-secondary" onclick="closeConfirmClear()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<div id="imageGalleryModal" class="image-gallery-modal">
    <button class="gallery-close" onclick="closeImageGallery()">âœ•</button>
    <div class="gallery-counter" id="galleryCounter">1/5</div>
    <button class="gallery-nav-btn prev" onclick="prevGalleryImage()">â®</button>
    <img class="gallery-main-image" id="galleryMainImage" src="">
    <button class="gallery-nav-btn next" onclick="nextGalleryImage()">â¯</button>
    <div class="gallery-thumbnails" id="galleryThumbnails"></div>
</div>

<script>
// ============= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª API =============
const API_BASE_URL = 'https://foryoumyland.ly/api';

async function apiRequest(endpoint, method = 'GET', data = null) {
    try {
        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            }
        };
        
        if (data && (method === 'POST' || method === 'PUT')) {
            options.body = JSON.stringify(data);
        }
        
        const response = await fetch(`${API_BASE_URL}/${endpoint}`, options);
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.message || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
        }
        
        return result;
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ API:', error);
        showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
        throw error;
    }
}

// ============= Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© =============
let allProductsData = [];
let productsCache = {};
let currentCategory = "";
let categoriesMap = {};
let favorites = JSON.parse(localStorage.getItem("favorites")) || {};
let currentGalleryImages = [];
let currentGalleryIndex = 0;
let cart = JSON.parse(localStorage.getItem("cart")) || [];

// ============= Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆØ±ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© =============
let stockMonitorInterval;
let lastStockState = {};
let concurrentReservations = {};
let userSessionId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

// ============= Ø¯ÙˆØ§Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =============
async function loadCategories() {
    try {
        const result = await apiRequest('categories.php');
        
        if (result.status === 'success') {
            let cats = result.data;
            let bar = document.getElementById("categoriesBar");
            bar.innerHTML = "";
            categoriesMap = {};
            let firstCategoryName = null;

            cats.forEach((cat, index) => {
                categoriesMap[cat.name] = cat.id;
                
                if (index === 0) {
                    firstCategoryName = cat.name;
                }
                
                let btn = document.createElement("button");
                btn.className = "btn btn-outline-primary";
                btn.innerText = cat.name;
                btn.onclick = () => showCategory(cat.name);
                bar.appendChild(btn);
            });
            
            loadAllProducts();
            
            if (firstCategoryName) {
                showCategory(firstCategoryName);
            }
        }
    } catch (error) {
        console.error("Error loading categories:", error);
        document.getElementById("productsContainer").innerHTML = 
            `<div class="col-12 text-center" style="grid-column: 1 / -1; padding: 40px;">
                <p style="color: red; font-size: 18px;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</p>
                <button onclick="loadCategories()" class="btn btn-primary mt-2">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
            </div>`;
    }
}

async function loadAllProducts() {
    try {
        const result = await apiRequest('products.php');
        
        if (result.status === 'success') {
            allProductsData = result.data;
            productsCache = {};
            
            allProductsData.forEach(product => {
                const categoryName = Object.keys(categoriesMap).find(key => categoriesMap[key] === product.category_id);
                
                if (categoryName) {
                    if (!productsCache[categoryName]) {
                        productsCache[categoryName] = [];
                    }
                    // ØªØ­ÙˆÙŠÙ„ stock_details Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù†Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø© ÙˆØªÙ†Ù‚ÙŠØªÙ‡Ø§
                    if (product.stock_details && typeof product.stock_details === 'object') {
                        let cleanedDetails = {};
                        for (const key in product.stock_details) {
                            if (product.stock_details.hasOwnProperty(key) && key.trim() !== "") {
                                cleanedDetails[key.trim()] = product.stock_details[key];
                            }
                        }
                        product.stock_details = cleanedDetails;
                    }

                    productsCache[categoryName].push(product);
                }
            });
            
            if (currentCategory) {
                renderProducts(currentCategory);
            }
            
            // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            setTimeout(() => {
                startRealTimeStockMonitoring();
            }, 1000);
        }
    } catch (error) {
        console.error("Error loading products:", error);
    }
}

// ============= Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø«Ø© =============
function getVariantStock(product, color = "", size = "", type = "") {
    // 1. Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø®Ø²ÙˆÙ† ØªÙØµÙŠÙ„ÙŠØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„ÙƒÙ„ÙŠ
    if (!product.stock_details || Object.keys(product.stock_details).length === 0) {
        return parseInt(product.total_stock) || 0;
    }
    
    const stockDetails = product.stock_details;
    
    // 2. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© (Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: Ù„ÙˆÙ†|Ù…Ù‚Ø§Ø³|Ù†ÙˆØ¹)
    const options = [];
    if (color) options.push(color);
    if (size) options.push(size);
    if (type) options.push(type);
    
    // Ø§Ù„Ù…ÙØªØ§Ø­ Ù‡Ùˆ Ø§Ù„ØªØ±ÙƒÙŠØ¨Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø§Ù„Ø¶Ø¨Ø·
    const key = options.join("|");
    
    // 3. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØªØ·Ø§Ø¨Ù‚ Ø¯Ù‚ÙŠÙ‚
    if (stockDetails[key] !== undefined) {
        return parseInt(stockDetails[key]) || 0;
    }
    
    // 4. Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø®ÙŠØ§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ØŒ Ù†Ø±Ø¬Ø¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„ÙƒÙ„ÙŠ (ÙˆÙ‡Ùˆ Ù…Ø§ Ù„Ø§ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­Ø¯Ø« Ù‡Ù†Ø§)
    if (options.length === 0) {
        return parseInt(product.total_stock) || 0;
    }

    // 5. ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØªØ·Ø§Ø¨Ù‚ Ø¯Ù‚ÙŠÙ‚ Ù„Ù„Ù…ÙØªØ§Ø­ØŒ Ù†Ø±Ø¬Ø¹ ØµÙØ± (Ù„Ø£Ù†Ù†Ø§ Ù†Ø¨Ø­Ø« Ø¹Ù† Ù…Ø®Ø²ÙˆÙ† ØªØ±ÙƒÙŠØ¨Ø© Ù…Ø­Ø¯Ø¯Ø©)
    return 0;
}

function getAvailableOptions(product, currentSelections = {}) {
    const available = {
        colors: [],
        sizes: [],
        types: []
    };
    
    // Ø¥Ø°Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø®Ø²ÙˆÙ† ØªÙØµÙŠÙ„ÙŠØŒ ÙƒÙ„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªØ§Ø­Ø©
    if (!product.stock_details || Object.keys(product.stock_details).length === 0) {
        available.colors = product.colors || [];
        available.sizes = product.sizes || [];
        available.types = product.types || [];
        return available;
    }
    
    const allColors = product.colors || [];
    const allSizes = product.sizes || [];
    const allTypes = product.types || [];
    const stockDetails = product.stock_details;
    
    // Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© (Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹)
    const fixedColor = currentSelections.color || '';
    const fixedSize = currentSelections.size || '';
    const fixedType = currentSelections.type || '';
    
    
    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙØ± - Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø°ÙŠ ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù„ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø±
    function checkAvailability(optionToTest, optionType) {
        
        let requiredOptions = [];

        // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¨Ø¹ÙŠØ©:
        
        // Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø®ØªØ¨Ø± Ø§Ù„Ø£Ù„ÙˆØ§Ù†ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ù‚Ø§Ø³ ÙˆØ§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø«Ø§Ø¨ØªÙŠÙ†
        if (optionType === 'color') {
            if (fixedSize) requiredOptions.push(fixedSize);
            if (fixedType) requiredOptions.push(fixedType);
        } 
        // Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø®ØªØ¨Ø± Ø§Ù„Ù…Ù‚Ø§Ø³Ø§ØªØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù„ÙˆÙ† ÙˆØ§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø«Ø§Ø¨ØªÙŠÙ†
        else if (optionType === 'size') {
            if (fixedColor) requiredOptions.push(fixedColor);
            if (fixedType) requiredOptions.push(fixedType);
        }
        // Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø®ØªØ¨Ø± Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù„ÙˆÙ† ÙˆØ§Ù„Ù…Ù‚Ø§Ø³ Ø§Ù„Ø«Ø§Ø¨ØªÙŠÙ†
        else if (optionType === 'type') {
            if (fixedColor) requiredOptions.push(fixedColor);
            if (fixedSize) requiredOptions.push(fixedSize);
        }
        
        
        // A. Ù†Ø¨Ø­Ø« Ø£ÙˆÙ„Ø§Ù‹ Ø¹Ù† ØªØ±ÙƒÙŠØ¨Ø© ØªØªØ¶Ù…Ù† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© ÙˆØ§Ù„Ø®ÙŠØ§Ø± Ù‚ÙŠØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        
        let searchCombination = [...requiredOptions, optionToTest];
        let foundMatchWithFixed = false;
        
        // 1. Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ¨Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© (Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ + Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø§Ù„Ø£Ø®Ø±Ù‰)
        for (const key in stockDetails) {
            const stock = parseInt(stockDetails[key]) || 0;
            if (stock <= 0) continue;

            const keyParts = key.split('|');
            
            let allMatch = true;
            for (const req of searchCombination) {
                if (!keyParts.includes(req)) {
                    allMatch = false;
                    break;
                }
            }
            
            if (allMatch) {
                foundMatchWithFixed = true;
                break;
            }
        }
        
        if (foundMatchWithFixed) {
            return true; // Ø¥Ø°Ø§ ØªÙˆÙØ±Øª Ø§Ù„ØªØ±ÙƒÙŠØ¨Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©ØŒ ÙÙ‡Ùˆ Ù…ØªØ§Ø­
        }

        // 2. Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ·Ø§Ø¨Ù‚ ÙƒØ§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© (Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø§Ù„Ø°ÙŠ ÙŠØ­Ø¯Ø« ÙÙŠÙ‡ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©)ØŒ 
        // Ù†ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®ÙŠØ§Ø± Ù‚ÙŠØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªØ§Ø­Ø§Ù‹ ÙÙŠ Ø£ÙŠ ØªØ±ÙƒÙŠØ¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚.
        // Ù‡Ø°Ø§ ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù„ÙˆØ§Ù† (Ø£Ùˆ Ø£ÙŠ Ø®ÙŠØ§Ø± Ø±Ø¦ÙŠØ³ÙŠ) Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ÙŠØªÙˆÙØ± Ø§Ù„Ù…Ù‚Ø§Ø³ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø¹Ù‡.
        
        // ÙÙ‚Ø· Ù†Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø®ÙŠØ§Ø± Ù‚ÙŠØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø§Ù„Ø£Ø®Ø±Ù‰ Ù„ØºØ±Ø¶ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„)
        for (const key in stockDetails) {
            const stock = parseInt(stockDetails[key]) || 0;
            if (stock > 0 && key.split('|').includes(optionToTest)) {
                 return true; // ÙˆØ¬Ø¯Ù†Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù‚ÙŠØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªØ§Ø­Ø§Ù‹ ÙÙŠ ØªØ±ÙƒÙŠØ¨Ø© Ù…Ø§
            }
        }

        return false;
    }
    
    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ø£Ù„ÙˆØ§Ù†
    for (const color of allColors) {
        if (checkAvailability(color, 'color')) {
            available.colors.push(color);
        }
    }
    
    // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª
    for (const size of allSizes) {
        if (checkAvailability(size, 'size')) {
            available.sizes.push(size);
        }
    }
    
    // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
    for (const type of allTypes) {
        if (checkAvailability(type, 'type')) {
            available.types.push(type);
        }
    }
    
    return available;
}

function getCurrentSelections(productId) {
    return {
        color: getSelectedOptionValue(productId, 'color'),
        size: getSelectedOptionValue(productId, 'size'),
        type: getSelectedOptionValue(productId, 'type')
    };
}

function updateStockStatus(productId) {
    const product = getProductById(productId);
    if (!product) return;
    
    const color = getSelectedOptionValue(productId, 'color');
    const size = getSelectedOptionValue(productId, 'size');
    const type = getSelectedOptionValue(productId, 'type');
    
    const variantStock = getVariantStock(product, color, size, type);
    
    const stockAlert = document.getElementById(`stock-alert-${productId}`);
    const addButton = document.getElementById(`add-btn-${productId}`);
    const productCard = document.getElementById(`product-card-${productId}`);
    
    
    // ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡Ø§ Ø¨Ø¹Ø¯
    const requiresColor = product.colors && product.colors.length > 0;
    const requiresSize = product.sizes && product.sizes.length > 0;
    const requiresType = product.types && product.types.length > 0;

    const requiresSelection = (requiresColor && !color) || 
                              (requiresSize && !size) ||
                              (requiresType && !type);

    const isOutOfStock = !requiresSelection && variantStock === 0;

    if (stockAlert) {
        if (requiresSelection) {
             stockAlert.textContent = "âš ï¸ Ø§Ø®ØªØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©";
             stockAlert.style.color = "#ffc107"; // Ù„ÙˆÙ† ØªØ­Ø°ÙŠØ±ÙŠ
        } else if (isOutOfStock) {
            stockAlert.textContent = "ğŸ”´ Ù‡Ø°Ù‡ Ø§Ù„ØªØ±ÙƒÙŠØ¨Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹";
            stockAlert.style.color = "red";
        } else {
            stockAlert.textContent = `ğŸŸ¢ Ù…ØªÙˆÙØ± (${variantStock} Ù‚Ø·Ø¹Ø©)`;
            stockAlert.style.color = "green";
        }
    }
    
    // ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù‡ÙŠ ØµÙØ± (Ù†ØªÙŠØ¬Ø© Ø¹Ø¯Ù… Ø§Ø®ØªÙŠØ§Ø± Ø£Ø­Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©)
    const disableAdd = requiresSelection || isOutOfStock;

    if (addButton) {
        addButton.disabled = disableAdd;
        addButton.style.opacity = disableAdd ? "0.5" : "1";
        addButton.style.cursor = disableAdd ? "not-allowed" : "pointer";
    }
    
    if (productCard) {
        // Ù†Ø³ØªØ®Ø¯Ù… isOutOfStock ÙÙ‚Ø· Ù„ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙƒØ±Øª Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„
        productCard.classList.toggle('out-of-stock', product.total_stock == 0);
    }
    
    updateAllOptionStatus(productId);
}

function updateAllOptionStatus(productId) {
    const product = getProductById(productId);
    if (!product) return;
    
    const currentSelections = getCurrentSelections(productId);
    const availableOptions = getAvailableOptions(product, currentSelections);
    
    // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ù„ÙˆØ§Ù†
    if (product.colors && product.colors.length > 0) {
        product.colors.forEach(color => {
            const radio = document.getElementById(`color-${productId}-${color.replace(/\s/g, '-')}`);
            const chip = document.querySelector(`label[for="color-${productId}-${color.replace(/\s/g, '-')}"]`);
            
            if (radio && chip) {
                const isAvailable = availableOptions.colors.includes(color);
                
                radio.disabled = !isAvailable;
                chip.classList.toggle('chip-disabled', !isAvailable);
                chip.style.cursor = isAvailable ? 'pointer' : 'not-allowed';

                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù…Ø­Ø¯Ø¯Ø§Ù‹ØŒ Ù†Ø¶Ù…Ù† Ø¹Ø¯Ù… ØªØ¹Ø·ÙŠÙ„Ù‡ Ø¨ØµØ±ÙŠØ§Ù‹
                if (currentSelections.color === color) {
                    radio.disabled = false;
                    chip.classList.remove('chip-disabled');
                    chip.style.cursor = 'pointer';
                }
            }
        });
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª
    if (product.sizes && product.sizes.length > 0) {
        product.sizes.forEach(size => {
            const radio = document.getElementById(`size-${productId}-${size.replace(/\s/g, '-')}`);
            const chip = document.querySelector(`label[for="size-${productId}-${size.replace(/\s/g, '-')}"]`);
            
            if (radio && chip) {
                const isAvailable = availableOptions.sizes.includes(size);
                
                radio.disabled = !isAvailable;
                chip.classList.toggle('chip-disabled', !isAvailable);
                chip.style.cursor = isAvailable ? 'pointer' : 'not-allowed';

                if (currentSelections.size === size) {
                    radio.disabled = false;
                    chip.classList.remove('chip-disabled');
                    chip.style.cursor = 'pointer';
                }
            }
        });
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
    if (product.types && product.types.length > 0) {
        product.types.forEach(type => {
            const radio = document.getElementById(`type-${productId}-${type.replace(/\s/g, '-')}`);
            const chip = document.querySelector(`label[for="type-${productId}-${type.replace(/\s/g, '-')}"]`);
            
            if (radio && chip) {
                const isAvailable = availableOptions.types.includes(type);
                
                radio.disabled = !isAvailable;
                chip.classList.toggle('chip-disabled', !isAvailable);
                chip.style.cursor = isAvailable ? 'pointer' : 'not-allowed';
                
                if (currentSelections.type === type) {
                    radio.disabled = false;
                    chip.classList.remove('chip-disabled');
                    chip.style.cursor = 'pointer';
                }
            }
        });
    }
}

function handleOptionChange(productId, changedOptionType) {
    const product = getProductById(productId);
    if (!product) return;

    // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù‚Ø¨Ù„ Ø£ÙŠ ØªÙ†Ø¸ÙŠÙ)
    let currentSelections = getCurrentSelections(productId);
    // Ù†Ø³ØªØ®Ø¯Ù… Ù†Ø³Ø®Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ø¨Ø¹Ø¯ Ø£ÙŠ ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    let availableOptions = getAvailableOptions(product, currentSelections);

    // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù‚Ø§Ø³: Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø­Ø¯Ø¯Ø§Ù‹ ÙˆØ£ØµØ¨Ø­ ØºÙŠØ± Ù…ØªÙˆÙØ±ØŒ Ù‚Ù… Ø¨Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯Ù‡
    const currentSize = currentSelections.size;
    if (currentSize && !availableOptions.sizes.includes(currentSize)) {
        // Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù‚Ø§Ø³
        const radio = document.getElementById(`size-${productId}-${currentSize.replace(/\s/g, '-')}`);
        if (radio) radio.checked = false;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø¹Ø¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ù‚Ø§Ø³ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
        currentSelections.size = ''; 
        availableOptions = getAvailableOptions(product, currentSelections);
    }
    
    // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ÙˆØ¹: Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø­Ø¯Ø¯Ø§Ù‹ ÙˆØ£ØµØ¨Ø­ ØºÙŠØ± Ù…ØªÙˆÙØ±ØŒ Ù‚Ù… Ø¨Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯Ù‡
    const currentType = currentSelections.type;
    if (currentType && !availableOptions.types.includes(currentType)) {
        // Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ÙˆØ¹
        const radio = document.getElementById(`type-${productId}-${currentType.replace(/\s/g, '-')}`);
        if (radio) radio.checked = false;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø¹Ø¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù†ÙˆØ¹ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
        currentSelections.type = '';
        availableOptions = getAvailableOptions(product, currentSelections);
    }
    
    // 4. Ø£Ø®ÙŠØ±Ø§Ù‹ØŒ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¹Ø·Ù„Ø©/Ø§Ù„Ù…ØªØ§Ø­Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ¯Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    updateStockStatus(productId);
}

// ============= Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø±Ø¶ =============
function renderProducts(cat) {
    let container = document.getElementById("productsContainer");
    
    const categoryProducts = productsCache[cat] || [];

    if (categoryProducts.length === 0) {
        container.innerHTML = `<div class="col-12 text-center" style="grid-column: 1 / -1; padding: 40px;">
            <p style="color: #666; font-size: 18px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¹Ø±ÙˆØ¶Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</p>
        </div>`;
        return;
    }
    
    let allProductsHTML = "";
    categoryProducts.forEach((p, i) => {
        const isFavorite = favorites[p.id];
        const hasMultipleImages = p.images && p.images.length > 1;
        const currentTotalStock = parseInt(p.total_stock) || 0;
        const isOutOfStock = currentTotalStock === 0;

        const initialAvailable = getAvailableOptions(p, {});

        // Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù†
        let colorsHTML = p.colors && p.colors.length > 0 ? 
            `<div class="chip-group" id="colors-group-${p.id}">
                <label class="option-label">Ø§Ù„Ù„ÙˆÙ†:</label>
                ${p.colors.map(c => {
                    const isAvailable = initialAvailable.colors.includes(c);
                    return `
                    <input type="radio" name="color-${p.id}" id="color-${p.id}-${c.replace(/\s/g, '-')}" value="${c}" class="option-radio" data-option-type="color"
                          onchange="handleOptionChange('${p.id}', 'color')"
                          ${!isAvailable ? 'disabled' : ''}>
                    <label for="color-${p.id}-${c.replace(/\s/g, '-')}" class="option-chip ${!isAvailable ? 'chip-disabled' : ''}" data-value="${c}">${c}</label>
                `}).join("")}
            </div>` : "";

        // Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª
        let sizesHTML = p.sizes && p.sizes.length > 0 ? 
            `<div class="chip-group" id="sizes-group-${p.id}">
                <label class="option-label">Ø§Ù„Ù…Ù‚Ø§Ø³:</label>
                ${p.sizes.map(s => {
                    const isAvailable = initialAvailable.sizes.includes(s);
                    return `
                    <input type="radio" name="size-${p.id}" id="size-${p.id}-${s.replace(/\s/g, '-')}" value="${s}" class="option-radio" data-option-type="size"
                          onchange="handleOptionChange('${p.id}', 'size')"
                          ${!isAvailable ? 'disabled' : ''}>
                    <label for="size-${p.id}-${s.replace(/\s/g, '-')}" class="option-chip ${!isAvailable ? 'chip-disabled' : ''}" data-value="${s}">${s}</label>
                `}).join("")}
            </div>` : "";
        
        // Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
        let typesHTML = p.types && p.types.length > 0 ? 
            `<div class="chip-group" id="types-group-${p.id}">
                <label class="option-label">Ù…ÙˆØ¯ÙŠÙ„:</label>
                ${p.types.map(t => {
                    const isAvailable = initialAvailable.types.includes(t);
                    return `
                    <input type="radio" name="type-${p.id}" id="type-${p.id}-${t.replace(/\s/g, '-')}" value="${t}" class="option-radio" data-option-type="type"
                          onchange="handleOptionChange('${p.id}', 'type')"
                          ${!isAvailable ? 'disabled' : ''}>
                    <label for="type-${p.id}-${t.replace(/\s/g, '-')}" class="option-chip ${!isAvailable ? 'chip-disabled' : ''}" data-value="${t}">${t}</label>
                `}).join("")}
            </div>` : "";
        
        // Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ØµØºØ±Ø©
        let thumbnailsHTML = "";
        if (hasMultipleImages) {
            thumbnailsHTML = `
                <button class="image-nav-btn prev" onclick="changeProductImage('${p.id}', -1)">â®</button>
                <button class="image-nav-btn next" onclick="changeProductImage('${p.id}', 1)">â¯</button>
                <div class="thumbnail-container" id="thumbnails-${p.id}">
                ${p.images.map((img, index) => `
                    <img src="${img}" class="thumbnail ${index === 0 ? 'active' : ''}" 
                        onclick="setProductImage('${p.id}', ${index})"
                        loading="lazy" 
                        onerror="this.src='${getDefaultImage()}'">
                `).join('')}
                </div>`;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„ÙƒÙ„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const initialStockMessage = isOutOfStock ? 'ğŸ”´ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹' : 'âš ï¸ Ø§Ø®ØªØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©';
        
        allProductsHTML += `
            <div class="product-card ${isOutOfStock ? 'out-of-stock' : ''}" id="product-card-${p.id}">
                <button class="heart-btn ${isFavorite ? 'active' : ''}" onclick="toggleFavorite(${p.id})">
                    ${isFavorite ? 'â¤ï¸' : 'ğŸ¤'}
                </button>
                <div class="product-gallery" id="gallery-${p.id}">
                ${hasMultipleImages ? `<div class="image-counter">1/${p.images.length}</div>` : ''}
                
                <img src="${p.images && p.images[0] ? p.images[0] : getDefaultImage()}" class="main-product-image" 
                    onclick="openImageGallery(${p.id})" 
                    loading="lazy" 
                    onerror="this.src='${getDefaultImage()}'"
                    data-current-index="0">
                
                ${thumbnailsHTML}
                </div>
                <div class="product-body">
                <h5 class="product-title">${p.name}</h5>
                <div class="product-price">ğŸ’µ ${parseFloat(p.price).toFixed(2)} Ø¯</div>
                
                ${colorsHTML}
                ${sizesHTML}
                ${typesHTML}
                
                <p id="stock-alert-${p.id}" style="font-size: 12px; color: ${isOutOfStock ? 'red' : '#ffc107'}; font-weight: bold; margin-bottom: 5px;">
                    ${initialStockMessage}
                </p>
                
                <div class="input-group mb-2">
                    <button class="btn btn-outline-danger" style="font-size: 12px; padding: 4px 8px;" onclick="changeQty(${p.id},-1)">â–</button>
                    <input type="text" id="qty-${p.id}" class="form-control text-center" value="1" readonly style="font-size: 12px;">
                    <button class="btn btn-outline-success" style="font-size: 12px; padding: 4px 8px;" onclick="changeQty(${p.id},1)">â•</button>
                </div>
                
                <button class="btn btn-primary w-100" style="background: linear-gradient(45deg, #ff69b4, #ff1493); border: none; font-size: 14px; padding: 8px;" 
                    onclick="addToCart(${p.id})" id="add-btn-${p.id}" ${isOutOfStock ? 'disabled' : ''}>
                    ğŸ›’ Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©
                </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = allProductsHTML;
    
    // Ø¨Ø¹Ø¯ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§ØªØŒ Ù†ÙƒØ±Ø± Ø¹Ù„Ù‰ ÙƒÙ„ Ù…Ù†ØªØ¬ ÙˆÙ†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†/Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ
    categoryProducts.forEach(p => {
        const requiresColor = p.colors && p.colors.length > 0;
        const requiresSize = p.sizes && p.sizes.length > 0;
        const requiresType = p.types && p.types.length > 0;
        if (requiresColor || requiresSize || requiresType) {
            updateStockStatus(p.id);
        }
    });
}

function showCategory(cat) {
    currentCategory = cat;
    
    document.querySelectorAll('#categoriesBar .btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('#categoriesBar .btn').forEach(btn => {
        if (btn.innerText.trim() === cat.trim()) btn.classList.add('active');
    });

    let container = document.getElementById("productsContainer");

    if (Object.keys(productsCache).length > 0) {
        renderProducts(cat);
    } else {
        container.innerHTML = `<div class="col-12 text-center loading-spinner" style="grid-column: 1 / -1; padding: 40px;">
            <div class="spinner-border text-primary" role="status"></div>
            <p style="color: #666; font-size: 16px; margin-top: 10px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù†ØªØ¬Ø§Øª Ù‚Ø³Ù… ${cat}...</p>
        </div>`;
    }
}

// ============= Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ù†ØªØ¬ =============
function getProductById(productId) {
    return allProductsData.find(p => p.id == productId) || null;
}

function getSelectedOptionValue(productId, type) {
    return document.querySelector(`input[name="${type}-${productId}"]:checked`)?.value || "";
}

function changeQty(id, delta) {
    let input = document.getElementById(`qty-${id}`);
    let value = parseInt(input.value) || 1;
    value += delta;
    if (value < 1) value = 1;
    input.value = value;
}

// ============= Ø¯ÙˆØ§Ù„ Ø§Ù„Ø³Ù„Ø© =============
function updateCart() {
    document.getElementById("cartCount").innerText = cart.length;
    let container = document.getElementById("cartItems");
    container.innerHTML = "";
    
    let subTotal = 0;
    
    if (cart.length === 0) {
         container.innerHTML = `<p class="text-center text-muted mt-3">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</p>`;
    }

    cart.forEach((it, index) => {
        const itemTotal = it.price * it.qty;
        const imgHtml = it.image ? `<img src="${it.image}" class="cart-item-img">` : '';

        container.innerHTML += `
            <div class="d-flex justify-content-between align-items-center mb-2" style="background:#f9f9f9; padding:5px; border-radius:8px;">
                <div class="d-flex align-items-center">
                    ${imgHtml}
                    <div style="font-size: 13px; margin-right:10px;">
                        <strong>${it.name}</strong><br>
                        ${it.size ? `Ù…: ${it.size}` : ""} ${it.color ? `| Ù„: ${it.color}` : ""} ${it.type ? `| Ù†ÙˆØ¹: ${it.type}` : ""}<br>
                        ${it.qty} Ã— ${it.price} = <strong>${itemTotal.toFixed(2)} Ø¯</strong>
                    </div>
                </div>
                <div style="min-width: 80px; text-align: left;">
                    <button class="btn btn-sm btn-outline-secondary p-1" onclick="editCartQty(${index},-1)">â–</button>
                    <button class="btn btn-sm btn-outline-danger p-1" onclick="removeFromCart(${index})">ğŸ—‘ï¸</button>
                    <button class="btn btn-sm btn-outline-secondary p-1" onclick="editCartQty(${index},1)">â•</button>
                </div>
            </div>
        `;
        subTotal += itemTotal;
    });
    
    const shippingCost = getShippingCost();
    const grandTotal = subTotal + shippingCost;
    
    document.getElementById("cartTotal").innerHTML = `
        <div class="d-flex justify-content-between mb-1" style="font-size: 16px;">
            <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</span>
            <span style="font-weight: bold;">${subTotal.toFixed(2)} Ø¯</span>
        </div>
        <div class="d-flex justify-content-between mb-1" style="font-size: 16px;">
            <span>Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„:</span>
            <span style="font-weight: bold; color: #d63384;">+ ${shippingCost.toFixed(2)} Ø¯</span>
        </div>
        <hr style="margin: 5px 0;">
        <div class="d-flex justify-content-between" style="font-size: 18px;">
            <span style="font-weight: bold;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</span>
            <span style="font-weight: bold; color: #ff1493;">${grandTotal.toFixed(2)} Ø¯</span>
        </div>
    `;
}

function addToCart(productId) {
    const product = getProductById(productId);
    if (!product) {
        showAlert("âŒ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
        return;
    }
    
    let qty = parseInt(document.getElementById(`qty-${productId}`).value) || 1;
    let size = getSelectedOptionValue(productId, 'size');
    let color = getSelectedOptionValue(productId, 'color');
    let type = getSelectedOptionValue(productId, 'type');

    const requiresColor = product.colors && product.colors.length > 0;
    const requiresSize = product.sizes && product.sizes.length > 0;
    const requiresType = product.types && product.types.length > 0;

    if ((requiresSize && size === "") || (requiresColor && color === "") || (requiresType && type === "")) {
        showAlert("âš ï¸ Ø§Ø®ØªØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©");
        return;
    }
    
    if (qty === 0) {
        showAlert("âš ï¸ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù‡ÙŠ ØµÙØ±");
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    const variantStock = getVariantStock(product, color, size, type);
    if (variantStock === 0) {
        showAlert("âŒ Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± ØºÙŠØ± Ù…ØªÙˆÙØ± ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†");
        return;
    }
    
    if (qty > variantStock) {
        showAlert(`âš ï¸ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙ‚Ø· ${variantStock} Ù‚Ø·Ø¹Ø©`);
        return;
    }

    const existingItemIndex = cart.findIndex(item => 
        item.id == productId && item.color === color && item.size === size && item.type === type
    );
    
    const mainImage = (product.images && product.images.length > 0) ? product.images[0] : getDefaultImage();

    if (existingItemIndex !== -1) {
        const newQty = cart[existingItemIndex].qty + qty;
        if (newQty > variantStock) {
            showAlert(`âš ï¸ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·Ù„Ø¨ ${variantStock} Ù‚Ø·Ø¹Ø©`);
            return;
        }
        cart[existingItemIndex].qty = newQty;
        cart[existingItemIndex].image = mainImage;
        showAlert("ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ø³Ù„Ø©");
    } else {
        cart.push({
            id: productId,
            name: product.name,
            price: product.price,
            image: mainImage,
            qty,
            size,
            color,
            type
        });
        showAlert("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©");
    }
    
    localStorage.setItem("cart", JSON.stringify(cart));
    updateCart();
    
    // Ø­Ø¬Ø² Ø§Ù„Ù…Ù†ØªØ¬ ÙÙˆØ±ÙŠØ§Ù‹ Ù„Ù…Ø¯Ø© 10 Ø¯Ù‚Ø§Ø¦Ù‚
    reserveProductImmediately(productId, qty, color, size, type);
}

function editCartQty(index, delta) {
    const item = cart[index];
    const product = getProductById(item.id);
    
    if (!product) {
        showAlert("âŒ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
        return;
    }
    
    const newQty = item.qty + delta;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
    const variantStock = getVariantStock(product, item.color, item.size, item.type);
    
    if (newQty < 1) {
        removeFromCart(index);
        return;
    }
    
    if (newQty > variantStock) {
        showAlert(`âš ï¸ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙ‚Ø· ${variantStock} Ù‚Ø·Ø¹Ø©`);
        return;
    }
    
    item.qty = newQty;
    localStorage.setItem("cart", JSON.stringify(cart));
    updateCart();
}

function removeFromCart(index) {
    cart.splice(index, 1);
    localStorage.setItem("cart", JSON.stringify(cart));
    updateCart();
    showAlert("ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø³Ù„Ø©");
}

function getShippingCost() {
    const userData = JSON.parse(localStorage.getItem('userProfile'));
    let shippingCost = 0;
    if (userData && userData.cityData) {
        const cityDataParts = userData.cityData.split('_');
        shippingCost = parseFloat(cityDataParts[cityDataParts.length - 1]) || 0;
    }
    return shippingCost;
}

// ============= Ù†Ø¸Ø§Ù… Ø­Ø¬Ø² Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠ =============
async function reserveProductImmediately(productId, qty, color, size, type) {
    try {
        const response = await fetch(`${API_BASE_URL}/reserve-product.php`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                product_id: productId,
                qty: qty,
                color: color,
                size: size,
                type: type,
                session_id: userSessionId
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø­Ø¬Ø² Ù…Ø­Ù„ÙŠØ§Ù‹
            concurrentReservations[productId] = {
                qty: qty,
                expires: result.reserved_until,
                timestamp: Date.now()
            };
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø¤Ù‚ØªØ§Ù‹
            hideProductTemporarily(productId);
            
            // Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            showReservationNotification(productId, qty);
            
            return true;
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²:', error);
        return false;
    }
}

function hideProductTemporarily(productId) {
    const productCard = document.getElementById(`product-card-${productId}`);
    if (productCard) {
        productCard.style.opacity = '0.3';
        productCard.style.pointerEvents = 'none';
        productCard.style.position = 'relative';
        
        // Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠØ· "Ù…Ø­Ø¬ÙˆØ² Ù…Ø¤Ù‚ØªØ§Ù‹"
        const reserveBadge = document.createElement('div');
        reserveBadge.innerHTML = `
            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); 
                       background:linear-gradient(45deg,#ff9800,#ff5722); color:white; 
                       padding:10px 20px; border-radius:10px; font-weight:bold; z-index:100;
                       text-align:center; box-shadow:0 4px 15px rgba(255,152,0,0.4);">
                ğŸ•’ Ù…Ø­Ø¬ÙˆØ² Ù…Ø¤Ù‚ØªØ§Ù‹<br>
                <small style="font-size:12px;">Ù„Ù…Ø¯Ø© 10 Ø¯Ù‚Ø§Ø¦Ù‚</small>
            </div>
        `;
        reserveBadge.id = `reserve-badge-${productId}`;
        productCard.appendChild(reserveBadge);
    }
}

function showReservationNotification(productId, qty) {
    const product = getProductById(productId);
    if (!product) return;
    
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(45deg, #4CAF50, #2E7D32);
        color: white;
        padding: 20px 30px;
        border-radius: 15px;
        font-size: 16px;
        font-weight: bold;
        z-index: 3000;
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
        text-align: center;
        animation: slideIn 0.5s ease;
        max-width: 400px;
        width: 90%;
    `;
    
    notification.innerHTML = `
        <div style="font-size: 24px; margin-bottom: 10px;">âœ…</div>
        <strong>ØªÙ… Ø­Ø¬Ø² Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!</strong><br>
        "${product.name}" Ã— ${qty}<br>
        <small style="font-size: 14px; opacity: 0.9;">Ù„Ø¯ÙŠÙƒ 10 Ø¯Ù‚Ø§Ø¦Ù‚ Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</small>
        <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
            <button onclick="completeOrderNow()" style="background:white; color:#4CAF50; border:none; padding:8px 20px; border-radius:8px; font-weight:bold; cursor:pointer;">
                Ø£ÙƒÙ…Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†
            </button>
            <button onclick="this.parentElement.parentElement.remove()" style="background:transparent; color:white; border:1px solid white; padding:8px 20px; border-radius:8px; cursor:pointer;">
                ØªØ£Ø¬ÙŠÙ„
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†ÙŠ
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 500);
        }
    }, 10000);
}

function completeOrderNow() {
    openCart();
    document.querySelectorAll('.alert-custom, [style*="position: fixed"]').forEach(el => {
        if (el.id !== 'cartPanel' && el.id !== 'cartIcon') el.remove();
    });
}

// ============= Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„ÙÙˆØ±ÙŠØ© =============
function startRealTimeStockMonitoring() {
    // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ø¥Ù†ØªØ±ÙØ§Ù„ Ø³Ø§Ø¨Ù‚
    if (stockMonitorInterval) clearInterval(stockMonitorInterval);
    
    stockMonitorInterval = setInterval(async () => {
        try {
            const productIds = allProductsData.map(p => p.id);
            
            const response = await fetch(`${API_BASE_URL}/real-time-stock.php`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({product_ids: productIds, session_id: userSessionId})
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                result.products.forEach(product => {
                    updateProductStockInRealTime(product);
                });
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø©
                if (result.reserved && Object.keys(result.reserved).length > 0) {
                    Object.keys(result.reserved).forEach(productId => {
                        if (!concurrentReservations[productId]) {
                            showConcurrentOrderAlert(productId);
                        }
                    });
                }
            }
        } catch (error) {
            console.log('Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:', error.message);
        }
    }, 3000); // ÙƒÙ„ 3 Ø«ÙˆØ§Ù†ÙŠ
}

function updateProductStockInRealTime(product) {
    const productId = product.id;
    const currentStock = parseInt(product.total_stock) || 0;
    const lastStock = lastStockState[productId] || currentStock;
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
    const stockAlert = document.getElementById(`stock-alert-${productId}`);
    const addButton = document.getElementById(`add-btn-${productId}`);
    const productCard = document.getElementById(`product-card-${productId}`);
    
    if (productCard && currentStock !== lastStock) {
        if (currentStock === 0 && lastStock > 0) {
            // Ù†ÙØ§Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙÙˆØ±Ø§Ù‹
            productCard.classList.add('out-of-stock');
            productCard.style.opacity = '0.4';
            if (addButton) addButton.disabled = true;
            
            // Ø¥Ø´Ø¹Ø§Ø± Ù†ÙØ§Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            showOutOfStockImmediately(productId, product.name, product.price);
        } else if (currentStock > 0 && lastStock === 0) {
            // Ø¹ÙˆØ¯Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            productCard.classList.remove('out-of-stock');
            productCard.style.opacity = '1';
            if (addButton) addButton.disabled = false;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        if (stockAlert) {
            stockAlert.textContent = `ğŸŸ¢ Ù…ØªÙˆÙØ± (${currentStock} Ù‚Ø·Ø¹Ø©)`;
            stockAlert.style.color = 'green';
        }
    }
    
    lastStockState[productId] = currentStock;
}

function showConcurrentOrderAlert(productId) {
    const product = getProductById(productId);
    if (!product || concurrentReservations[productId]) return;
    
    // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
    if (sessionStorage.getItem(`alert_shown_${productId}`)) return;
    sessionStorage.setItem(`alert_shown_${productId}`, 'true');
    
    const alert = document.createElement('div');
    alert.style.cssText = `
        position: fixed;
        top: 150px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(45deg, #ff9800, #ff5722);
        color: white;
        padding: 25px;
        border-radius: 15px;
        font-size: 16px;
        font-weight: bold;
        z-index: 3000;
        box-shadow: 0 10px 30px rgba(255, 152, 0, 0.5);
        text-align: center;
        animation: alertPulse 0.5s ease;
        max-width: 450px;
        width: 90%;
        border: 3px solid white;
    `;
    
    alert.innerHTML = `
        <div style="font-size: 32px; margin-bottom: 15px;">âš ï¸</div>
        <h4 style="margin-bottom: 10px;">Ø§Ù„Ù…Ù†ØªØ¬ ØªÙ… Ø·Ù„Ø¨Ù‡ Ø§Ù„Ø¢Ù†!</h4>
        <p style="line-height: 1.6; margin-bottom: 15px;">
            Ø§Ù„Ù…Ù†ØªØ¬ <strong>"${product.name}"</strong> Ø¨Ø³Ø¹Ø± <strong>${product.price} Ø¯.Ù„</strong><br>
            ØªÙ… Ø·Ù„Ø¨Ù‡ Ù…Ù† Ù‚Ø¨Ù„ Ø²Ø¨ÙˆÙ† Ø¢Ø®Ø± ÙˆÙ„Ù… ÙŠØ¹Ø¯ Ù…ØªÙˆÙØ±Ø§Ù‹.
        </p>
        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; margin: 15px 0;">
            â³ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø³ÙŠØ®ØªÙÙŠ Ø®Ù„Ø§Ù„ <span id="alert-timer">10</span> Ø«ÙˆØ§Ù†ÙŠ
        </div>
    `;
    
    document.body.appendChild(alert);
    
    // Ø¹Ø¯Ù‘Ø§Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ
    let countdown = 10;
    const timer = setInterval(() => {
        countdown--;
        const timerElement = document.getElementById('alert-timer');
        if (timerElement) timerElement.textContent = countdown;
        
        if (countdown <= 0) {
            clearInterval(timer);
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 500);
        }
    }, 1000);
    
    // Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ© Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
    setTimeout(() => {
        sessionStorage.removeItem(`alert_shown_${productId}`);
    }, 30000);
}

function showOutOfStockImmediately(productId, productName, productPrice) {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø³Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const inCart = cart.find(item => item.id == productId);
    
    if (inCart) {
        // Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø³Ù„Ø©
        removeFromCart(cart.findIndex(item => item.id == productId));
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø±
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            z-index: 3000;
            box-shadow: 0 10px 30px rgba(255, 65, 108, 0.5);
            text-align: center;
            animation: slideDown 0.5s ease;
            max-width: 500px;
            width: 90%;
            border: 3px solid white;
        `;
        
        notification.innerHTML = `
            <div style="font-size: 28px; margin-bottom: 10px;">âŒ</div>
            <h4 style="margin-bottom: 10px;">Ù†ÙØ§Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„ÙÙˆØ±ÙŠ!</h4>
            <p style="line-height: 1.6; margin-bottom: 15px;">
                Ø§Ù„Ù…Ù†ØªØ¬ <strong>"${productName}"</strong> Ø¨Ø³Ø¹Ø± <strong>${productPrice} Ø¯.Ù„</strong><br>
                Ù†ÙØ¯ Ù…Ø®Ø²ÙˆÙ†Ù‡ Ù„Ù„ØªÙˆ ÙˆØªÙ… Ø¥Ø²Ø§Ù„ØªÙ‡ Ù…Ù† Ø³Ù„Ø© Ù…Ø´ØªØ±ÙŠØ§ØªÙƒ.
            </p>
            <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; margin: 15px 0;">
                â³ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø³ÙŠØ®ØªÙÙŠ Ø®Ù„Ø§Ù„ <span id="outofstock-timer">10</span> Ø«ÙˆØ§Ù†ÙŠ
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Ø¹Ø¯Ù‘Ø§Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ
        let countdown = 10;
        const timer = setInterval(() => {
            countdown--;
            const timerElement = document.getElementById('outofstock-timer');
            if (timerElement) timerElement.textContent = countdown;
            
            if (countdown <= 0) {
                clearInterval(timer);
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 500);
            }
        }, 1000);
    }
}

// ============= Ø¯ÙˆØ§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª =============
function confirmSendOrder() {
    if (cart.length === 0) {
        showAlert("âš ï¸ Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©ØŒ Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆÙ„Ø§Ù‹");
        return;
    }
    const userData = JSON.parse(localStorage.getItem('userProfile'));
    if (!userData || !userData.name || !userData.phone || !userData.cityData || !userData.address) {
        showDataAlert();
        return;
    }
    document.getElementById("confirmSendModal").style.display = "flex";
}

async function sendOrderFixed() {
    if (cart.length === 0) {
        showAlert("âš ï¸ Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©");
        return;
    }
    
    const userData = JSON.parse(localStorage.getItem('userProfile'));
    if (!userData || !userData.name || !userData.phone || !userData.cityData || !userData.address) {
        showDataAlert();
        return;
    }
    
    closeConfirmSend();
    
    // Ø¥Ø´Ø¹Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ù…Ø¹ ØªØµÙ…ÙŠÙ… Ø£ÙØ¶Ù„
    const loadingAlert = document.createElement('div');
    loadingAlert.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 30px;
        border-radius: 20px;
        font-size: 18px;
        font-weight: bold;
        z-index: 4000;
        box-shadow: 0 15px 40px rgba(102, 126, 234, 0.5);
        text-align: center;
        animation: pulse 1.5s infinite;
        border: 3px solid white;
    `;
    loadingAlert.innerHTML = `
        <div style="font-size: 40px; margin-bottom: 15px;">â³</div>
        <h4 style="margin-bottom: 10px;">Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ...</h4>
        <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ÙˆÙ„Ø§ ØªØºÙ„Ù‚ Ø§Ù„ØµÙØ­Ø©</p>
        <div class="spinner-border text-light mt-3" role="status">
            <span class="visually-hidden">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </div>
    `;
    document.body.appendChild(loadingAlert);
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ
    let subTotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
    const shippingCost = getShippingCost();
    const grandTotal = subTotal + shippingCost;
    
    // ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
    const orderData = {
        customer: {
            name: userData.name,
            phone: userData.phone,
            address: userData.address,
            cityData: userData.cityData
        },
        items: cart,
        subTotal: subTotal,
        shippingCost: shippingCost,
        total: grandTotal,
        sendTelegram: true
    };
    
    try {
        const response = await fetch(`${API_BASE_URL}/add-order.php`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(orderData)
        });
        
        const result = await response.json();
        
        // Ø¥Ø²Ø§Ù„Ø© Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        loadingAlert.remove();
        
        if (result.status === 'success') {
            // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­ Ù…Ø¹ ØªØµÙ…ÙŠÙ… Ù…ØªÙ…ÙŠØ²
            const successAlert = document.createElement('div');
            successAlert.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #4CAF50, #2E7D32);
                color: white;
                padding: 40px;
                border-radius: 20px;
                font-size: 20px;
                font-weight: bold;
                z-index: 4000;
                box-shadow: 0 20px 50px rgba(76, 175, 80, 0.5);
                text-align: center;
                animation: popIn 0.5s ease;
                border: 4px solid white;
                max-width: 500px;
                width: 90%;
            `;
            successAlert.innerHTML = `
                <div style="font-size: 60px; margin-bottom: 20px;">ğŸ‰</div>
                <h3 style="margin-bottom: 15px;">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!</h3>
                <p style="font-size: 18px; margin-bottom: 10px;">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: <strong>#${result.order_id}</strong></p>
                <p style="font-size: 16px; margin-bottom: 20px;">Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ø®Ù„Ø§Ù„ Ø³Ø§Ø¹Ø©</p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="viewOrder(${result.order_id})" style="background:white; color:#4CAF50; border:none; padding:12px 25px; border-radius:10px; font-weight:bold; cursor:pointer; font-size:16px;">
                        Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨
                    </button>
                    <button onclick="this.parentElement.parentElement.remove(); closeCart();" style="background:transparent; color:white; border:2px solid white; padding:12px 25px; border-radius:10px; cursor:pointer; font-size:16px;">
                        Ù…ÙˆØ§ÙÙ‚
                    </button>
                </div>
            `;
            document.body.appendChild(successAlert);
            
            // ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©
            clearCartAfterOrder();
            closeCart();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            setTimeout(() => {
                loadAllProducts();
                startRealTimeStockMonitoring();
            }, 1000);
            
        } else {
            showAlert(`âŒ ${result.message || 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨'}`, 5000);
        }
        
    } catch (error) {
        loadingAlert.remove();
        showAlert('âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 5000);
        console.error('Ø®Ø·Ø£ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨:', error);
    }
}

// ============= Ø¥ÙØ±Ø§Øº Ø§Ù„Ø³Ù„Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ù„Ø¨ =============
function clearCartAfterOrder() {
    cart = [];
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCart();
    
    // Ø¥Ø´Ø¹Ø§Ø± Ù†Ø¬Ø§Ø­
    showAlert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ø³Ù„Ø© Ù…ÙØ±ÙˆØºØ© Ø§Ù„Ø¢Ù†', 3000);
}

function viewOrder(orderId) {
    window.location.href = `orders.html?order_id=${orderId}`;
}

// ============= Ø¯ÙˆØ§Ù„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… =============
function toggleMenu() {
    const menu = document.getElementById('dropdownMenu');
    const overlay = document.getElementById('overlay');
    if (menu.classList.contains('show')) {
        closeMenu();
    } else {
        menu.classList.add('show');
        overlay.style.display = 'block';
        history.pushState({ panel: 'menu' }, '', '#menu');
    }
}

function closeMenu() {
    const menu = document.getElementById('dropdownMenu');
    const overlay = document.getElementById('overlay');
    if (menu.classList.contains('show')) {
        menu.classList.remove('show');
        overlay.style.display = 'none';
        if (history.state && history.state.panel === 'menu') {
            history.back();
        }
    }
}

function openCart() {
    const panel = document.getElementById("cartPanel");
    if (!panel.classList.contains("open")) {
        panel.classList.add("open");
        history.pushState({ panel: 'cart' }, '', '#cart');
    }
}

function closeCart() {
    const panel = document.getElementById("cartPanel");
    if (panel.classList.contains("open")) {
        panel.classList.remove("open");
        if (history.state && history.state.panel === 'cart') {
            history.back();
        }
    }
}

function showAlert(msg, duration = 2500) {
    let box = document.getElementById("alertBox");
    box.innerHTML = msg;
    box.style.display = "block";
    // Ù„Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ ØªØ§ÙŠÙ…Ø± Ø³Ø§Ø¨Ù‚
    clearTimeout(box.dataset.timer); 
    const timer = setTimeout(() => box.style.display = "none", duration);
    box.dataset.timer = timer;
}

function showDataAlert() {
    document.getElementById('dataAlert').style.display = 'flex';
    document.getElementById('dataAlertOverlay').style.display = 'block';
}

function closeDataAlert() {
    document.getElementById('dataAlert').style.display = 'none';
    document.getElementById('dataAlertOverlay').style.display = 'none';
}

function goToProfile() {
    window.location.href = 'profile.html';
}

function closeConfirmSend() {
    document.getElementById("confirmSendModal").style.display = "none";
}

function confirmClearCart() {
    if (cart.length === 0) {
        showAlert("âš ï¸ Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©");
        return;
    }
    document.getElementById("confirmClearModal").style.display = "flex";
}

function closeConfirmClear() {
    document.getElementById("confirmClearModal").style.display = "none";
}

function clearCart() {
    cart = [];
    localStorage.setItem("cart", JSON.stringify(cart));
    updateCart();
    showAlert("ğŸ—‘ï¸ ØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©");
    closeConfirmClear();
    closeCart();
}

function toggleFavorite(productId) {
    favorites[productId] = !favorites[productId];
    localStorage.setItem("favorites", JSON.stringify(favorites));
    // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‚Ù„Ø¨
    showCategory(currentCategory); 
    showAlert(favorites[productId] ? "â¤ï¸ ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©" : "ğŸ¤ ØªÙ… Ø§Ù„Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©");
}

// ============= Ø¯ÙˆØ§Ù„ Ø§Ù„ØµÙˆØ± =============
function changeProductImage(productId, direction) {
    const product = getProductById(productId);
    if (!product || !product.images || product.images.length <= 1) return;
    const gallery = document.getElementById(`gallery-${productId}`);
    const mainImage = gallery.querySelector('.main-product-image');
    let currentIndex = parseInt(mainImage.dataset.currentIndex || 0);
    let newIndex = (currentIndex + direction + product.images.length) % product.images.length;
    updateProductImageDisplay(productId, newIndex);
}

function setProductImage(productId, index) {
    updateProductImageDisplay(productId, index);
}

function updateProductImageDisplay(productId, index) {
    const product = getProductById(productId);
    if (!product || !product.images) return;
    const gallery = document.getElementById(`gallery-${productId}`);
    const mainImage = gallery.querySelector('.main-product-image');
    const thumbnails = gallery.querySelectorAll('.thumbnail');
    const counter = gallery.querySelector('.image-counter');
    mainImage.src = product.images[index] || getDefaultImage();
    mainImage.dataset.currentIndex = index;
    thumbnails.forEach((thumb, i) => {
        thumb.classList.toggle('active', i === index);
    });
    if (counter) {
        counter.textContent = `${index + 1}/${product.images.length}`;
    }
}

function openImageGallery(productId) {
    const product = getProductById(productId);
    if (!product || !product.images || product.images.length === 0) return;
    const mainImageElement = document.getElementById(`gallery-${productId}`).querySelector('.main-product-image');
    currentGalleryIndex = parseInt(mainImageElement.dataset.currentIndex || 0);
    currentGalleryImages = product.images;
    updateGalleryDisplay();
    document.getElementById('imageGalleryModal').style.display = 'flex';
    history.pushState({ panel: 'gallery' }, '', '#gallery');
}

function updateGalleryDisplay() {
    document.getElementById('galleryMainImage').src = currentGalleryImages[currentGalleryIndex] || getDefaultImage();
    document.getElementById('galleryCounter').textContent = `${currentGalleryIndex + 1}/${currentGalleryImages.length}`;
    const thumbnailsContainer = document.getElementById('galleryThumbnails');
    thumbnailsContainer.innerHTML = '';
    currentGalleryImages.forEach((img, index) => {
        const thumb = document.createElement('img');
        thumb.className = `gallery-thumbnail ${index === currentGalleryIndex ? 'active' : ''}`;
        thumb.src = img || getDefaultImage();
        thumb.onclick = () => {
            currentGalleryIndex = index;
            updateGalleryDisplay();
        };
        thumbnailsContainer.appendChild(thumb);
    });
}

function nextGalleryImage() {
    currentGalleryIndex = (currentGalleryIndex + 1) % currentGalleryImages.length;
    updateGalleryDisplay();
}

function prevGalleryImage() {
    currentGalleryIndex = (currentGalleryIndex - 1 + currentGalleryImages.length) % currentGalleryImages.length;
    updateGalleryDisplay();
}

function closeImageGallery() {
    const modal = document.getElementById('imageGalleryModal');
    if (modal.style.display === 'flex') {
        modal.style.display = 'none';
        if (history.state && history.state.panel === 'gallery') {
            history.back();
        }
    }
}

function getDefaultImage() {
    return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMuMjMyMi9zdmciPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IiNmOGY5ZmEiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+PGRlZnM+PHN0eWxlPi5hYyB7b3BhY2l0eToxO30uYmQgeyBmaWxsOiMzN2EzZDk7fSA8L3N0eWxlPjwvZGVmcz48dGV4dCB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMDAuMDAwMDA5IDY4LjYwMDAwMSkiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiM2NjYiIGZvbnQtZmFtaWx5PSJUYWlkaW5nIE1hdHRlIFRleHQiIHRleHQtYW5jaG9yPSJtaWRkbGUiPjx0c3BhbiB4PSIwIiB5PSIwIj7wn5S3INmE2YTZhCDYp9mE2K/ZitlKPC90c3Bhbj48L3RleHQ+PC9zdmc+';
}

// ============= ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© =============
window.onload = function() {
    loadCategories();
    document.getElementById("cartIcon").onclick = openCart;
    updateCart();
    
    // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„ÙÙˆØ±ÙŠØ©
    setTimeout(() => {
        startRealTimeStockMonitoring();
    }, 2000);
};

window.addEventListener('popstate', function(event) {
    const cartPanel = document.getElementById("cartPanel");
    const menu = document.getElementById('dropdownMenu');
    const galleryModal = document.getElementById('imageGalleryModal');
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø£ÙˆÙ„Ø§Ù‹
    if (galleryModal.style.display === 'flex') {
        galleryModal.style.display = 'none';
        return;
    }
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø«Ø§Ù†ÙŠØ§Ù‹
    if (cartPanel.classList.contains("open")) {
        cartPanel.classList.remove("open");
        return;
    }
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø«Ø§Ù„Ø«Ø§Ù‹
    if (menu.classList.contains('show')) {
        menu.classList.remove('show');
        document.getElementById('overlay').style.display = 'none';
        return;
    }
});

document.addEventListener('click', function(event) {
    const menu = document.getElementById('dropdownMenu');
    const icon = document.querySelector('.menu-icon');
    if (menu.classList.contains('show') && !menu.contains(event.target) && !icon.contains(event.target)) {
        closeMenu();
    }
});

document.querySelectorAll('.dropdown-item').forEach(item => {
    item.addEventListener('click', function() {
        closeMenu();
    });
});
</script>

<iframe src="bottom-nav.html" style="width:100%; height:80px; border:none; position: fixed; bottom: 0; left: 0; z-index: 1000;"></iframe>
</body>
</html>