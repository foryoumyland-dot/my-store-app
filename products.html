<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>🛍️ متجري</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<style>
body { background:#fff0f6; font-family: Tahoma; }
.card img { height: auto; width: 100%; object-fit: contain; cursor:pointer; }

/* ===== شريط التنقل العلوي ===== */
.navbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 40px;
    background: rgba(255, 255, 255, 0.98);
    box-shadow: 0 2px 15px rgba(255, 105, 180, 0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}
.nav-container {
    display: flex;
    align-items: center;
}
.nav-divider {
    width: 1px;
    height: 15px;
    background: #ffb6c1;
    margin: 0 12px;
}
.nav-item {
    padding: 5px 15px;
    text-decoration: none;
    color: #d63384;
    font-weight: 700;
    font-size: 0.8rem;
    transition: all 0.3s ease;
    border-radius: 20px;
}
.nav-item:hover { background: linear-gradient(45deg, #ff69b4, #ff1493); color: white; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 105, 180, 0.3); }
.nav-item.active { background: linear-gradient(45deg, #ff69b4, #ff1493); color: white; }

/* ✅ العنوان تحت الشريط */
.page-title {
    text-align: center;
    margin: 60px 0 20px 0;
    color: #d63384;
    font-weight: bold;
    font-size: 2rem;
}

/* ✅ أزرار الأقسام */
#categoriesBar { text-align: center; margin: 20px 0; }
#categoriesBar .btn { margin: 5px; border-radius: 20px; padding: 8px 18px; font-weight: bold; }

/* ✅ أيقونة السلة */
#cartIcon { position: fixed; bottom: 20px; right: 20px; background: #d63384; color: #fff; padding: 12px 18px; border-radius: 50%; font-size: 24px; cursor: pointer; box-shadow: 0px 4px 8px rgba(0,0,0,0.2); z-index: 999; }
#cartCount { position: absolute; top: -5px; right: -5px; background: #28a745; color: #fff; border-radius: 50%; padding: 2px 7px; font-size: 14px; }

/* ✅ السلة */
#cartPanel { position: fixed; top: 0; right: -400px; width: 360px; height: 100%; background: #fff; box-shadow: -2px 0 10px rgba(0,0,0,0.3); transition: right 0.4s ease; z-index: 1000; padding: 20px; overflow-y: auto; }
#cartPanel.open { right: 0; }
#cartPanel h4 { color:#d63384; font-weight:bold; }

/* ✅ نافذة تكبير الصور */
#imageModal { display: none; position: fixed; z-index: 4000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
#imageModal img { max-width: 90%; max-height: 90%; border-radius: 8px; }

/* ✅ تنبيه */
.alert-custom { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); background: linear-gradient(45deg, #ff416c, #ff4b2b); color: white; padding: 12px 20px; border-radius: 8px; font-size: 16px; font-weight: bold; z-index: 3000; display: none; }

/* ✅ نافذة التأكيد */
.confirm-modal { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.5); 
    z-index: 5000; 
    justify-content: center; 
    align-items: center; 
}
.confirm-content { 
    background: white; 
    padding: 25px; 
    border-radius: 15px; 
    text-align: center; 
    box-shadow: 0 5px 25px rgba(0,0,0,0.3);
    max-width: 400px;
    width: 90%;
}
.confirm-buttons { 
    margin-top: 20px; 
    display: flex; 
    gap: 10px; 
    justify-content: center;
}
</style>
</head>
<body>

<!-- ===== شريط التنقل ===== -->
<nav class="navbar">
    <div class="nav-container">
        <a href="home.html" class="nav-item">الصفحة الرئيسية</a>
        <div class="nav-divider"></div>
        <a href="products.html" class="nav-item active">المنتجات</a>
        <div class="nav-divider"></div>
        <a href="orders.html" class="nav-item">طلباتي</a>
    </div>
</nav>

<!-- ✅ العنوان تحت الشريط -->
<div class="page-title">🛍️ منتجاتنا</div>

<div class="container py-4">

  <!-- ✅ الأقسام -->
  <div id="categoriesBar"></div>

  <!-- ✅ المنتجات -->
  <div class="row" id="productsContainer"></div>
</div>

<!-- ✅ أيقونة السلة -->
<div id="cartIcon">
  🛒 <span id="cartCount">0</span>
</div>

<!-- ✅ السلة -->
<div id="cartPanel">
  <h4>🛒 سلة المشتريات</h4>
  <div id="cartItems"></div>
  <hr>
  <div id="cartTotal"></div>
  <button class="btn btn-success w-100 mt-2" onclick="confirmSendOrder()">✅ إرسال الطلب</button>
  <button class="btn btn-danger w-100 mt-2" onclick="confirmClearCart()">🗑️ تفريغ السلة</button>
  <button class="btn btn-secondary w-100 mt-2" onclick="closeCart()">⬅️ رجوع</button>
</div>

<!-- ✅ تنبيه -->
<div id="alertBox" class="alert-custom"></div>

<!-- ✅ نافذة تكبير الصور -->
<div id="imageModal" onclick="closeImage()">
  <img id="modalImg" src="">
</div>

<!-- ✅ نافذة تأكيد الإرسال -->
<div id="confirmSendModal" class="confirm-modal">
  <div class="confirm-content">
    <h5 style="color: #d63384;">📦 تأكيد إرسال الطلب</h5>
    <p>هل أنت متأكد من أنك تريد إرسال هذا الطلب؟</p>
    <div class="confirm-buttons">
      <button class="btn btn-success" onclick="sendOrder()">✅ نعم، إرسال</button>
      <button class="btn btn-secondary" onclick="closeConfirmSend()">❌ إلغاء</button>
    </div>
  </div>
</div>

<!-- ✅ نافذة تأكيد التفريغ -->
<div id="confirmClearModal" class="confirm-modal">
  <div class="confirm-content">
    <h5 style="color: #d63384;">🗑️ تأكيد تفريغ السلة</h5>
    <p>هل أنت متأكد من أنك تريد تفريغ السلة؟ سيتم حذف جميع العناصر.</p>
    <div class="confirm-buttons">
      <button class="btn btn-danger" onclick="clearCart()">✅ نعم، تفريغ</button>
      <button class="btn btn-secondary" onclick="closeConfirmClear()">❌ إلغاء</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
const firebaseConfig = { apiKey:"AIzaSyA-LdNQbQneJyxJQ8iMUUd5gsJypTFi6sg", authDomain:"mystore-orders-a74f8.firebaseapp.com", databaseURL:"https://mystore-orders-a74f8-default-rtdb.europe-west1.firebasedatabase.app", projectId:"mystore-orders-a74f8", storageBucket:"mystore-orders-a74f8.appspot.com", messagingSenderId:"431733924264", appId:"1:431733924264:web:986b8dc983ef8c0097bd9d" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let products = {};
let currentCategory = "";

/* ✅ تحميل الأقسام */
function loadCategories() {
  db.ref("categories").on("value", snap => {
    let cats = snap.val() || {};
    let bar = document.getElementById("categoriesBar");
    bar.innerHTML = "";
    Object.keys(cats).forEach(id=>{
      let btn = document.createElement("button");
      btn.className = "btn btn-outline-primary";
      btn.innerText = cats[id].name;
      btn.onclick = ()=> showCategory(cats[id].name);
      bar.appendChild(btn);
    });
  });
}

/* ✅ تحميل المنتجات */
function loadProducts() {
  db.ref("products").on("value", snap => {
    products = {};
    let data = snap.val() || {};
    Object.keys(data).forEach(id=>{
      let p = data[id];
      if(p.status === "معروض"){
        if(!products[p.category]) products[p.category] = [];
        products[p.category].push({...p, id});
      }
    });
    if(currentCategory) showCategory(currentCategory);
  });
}

/* ✅ عرض المنتجات */
function showCategory(cat){
  currentCategory = cat;
  let container = document.getElementById("productsContainer");
  container.innerHTML = "";
  if(!products[cat]) return;
  products[cat].forEach((p,i)=>{
    container.innerHTML += `
      <div class="col-md-4 mb-3">
        <div class="card">
          <img src="${p.images && p.images.length ? p.images[0] : ''}" class="card-img-top" onclick="openImage('${p.images && p.images.length ? p.images[0] : ''}')">
          <div class="card-body">
            <h5 class="card-title">${p.name}</h5>
            <p class="card-text">💵 ${p.price} د</p>
            <p>📦 الكمية: ${p.qty}</p>
            ${p.sizes && p.sizes.length ? `<select id="size-${p.id}" class="form-select mb-2"><option value="">المقاس</option>${p.sizes.map(s=>`<option value="${s}">${s}</option>`).join("")}</select>` : ""}
            ${p.colors && p.colors.length ? `<select id="color-${p.id}" class="form-select mb-2"><option value="">اللون</option>${p.colors.map(c=>`<option value="${c}">${c}</option>`).join("")}</select>` : ""}
            <div class="input-group mb-2">
              <button class="btn btn-outline-danger" onclick="changeQty('${p.id}',-1)">➖</button>
              <input type="text" id="qty-${p.id}" class="form-control text-center" value="1" readonly>
              <button class="btn btn-outline-success" onclick="changeQty('${p.id}',1)">➕</button>
            </div>
            <button class="btn btn-primary w-100" onclick="addToCart('${p.id}','${p.name}',${p.price},${p.qty})">🛒 أضف للسلة</button>
          </div>
        </div>
      </div>
    `;
  });
}

function changeQty(id,delta){
  let input = document.getElementById(`qty-${id}`);
  let value = parseInt(input.value) || 1;
  value += delta;
  if(value < 1) value = 1;
  input.value = value;
}

/* ✅ السلة */
let cart = JSON.parse(localStorage.getItem("cart")) || [];
updateCart();

function addToCart(id,name, price, stock){
  let qty = parseInt(document.getElementById("qty-"+id).value) || 1;
  if(qty > stock) { showAlert("⚠️ الكمية غير متوفرة"); return; }
  let size = document.getElementById("size-"+id)?.value || "";
  let color = document.getElementById("color-"+id)?.value || "";

  if((document.getElementById("size-"+id) && size==="") ||
     (document.getElementById("color-"+id) && color==="")){
    showAlert("⚠️ اختر الخيارات المطلوبة");
    return;
  }

  cart.push({id,name, price, qty, size, color});
  localStorage.setItem("cart", JSON.stringify(cart));
  updateCart();
  showAlert("✅ تمت إضافة المنتج إلى السلة");
}

function updateCart(){
  document.getElementById("cartCount").innerText = cart.length;
  let container = document.getElementById("cartItems");
  container.innerHTML = "";
  let total = 0;
  cart.forEach((it,index)=>{
    container.innerHTML += `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          - ${it.name} ${it.size? "| مقاس: "+it.size:""} ${it.color? "| لون: "+it.color:""} × ${it.qty} (${it.price * it.qty} د)
        </div>
        <div>
          <button class="btn btn-sm btn-outline-secondary" onclick="editCartQty(${index},-1)">➖</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="editCartQty(${index},1)">➕</button>
          <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})">🗑️</button>
        </div>
      </div>
    `;
    total += it.price * it.qty;
  });
  document.getElementById("cartTotal").innerHTML = `<b>الإجمالي: ${total} د</b><br><small style="color:#d63384;">💵 سعر التوصيل يختلف حسب المدينة</small>`;
}

function editCartQty(index,delta){ cart[index].qty += delta; if(cart[index].qty < 1) cart[index].qty = 1; localStorage.setItem("cart", JSON.stringify(cart)); updateCart(); }
function removeFromCart(index){ cart.splice(index,1); localStorage.setItem("cart", JSON.stringify(cart)); updateCart(); showAlert("🗑️ تم حذف المنتج من السلة"); }
function closeCart(){ document.getElementById("cartPanel").classList.remove("open"); }

/* ✅ نوافذ التأكيد */
function confirmSendOrder() {
    if (cart.length === 0) {
        showAlert("⚠️ السلة فارغة، أضف منتجات أولاً");
        return;
    }
    document.getElementById("confirmSendModal").style.display = "flex";
}

function confirmClearCart() {
    if (cart.length === 0) {
        showAlert("⚠️ السلة فارغة بالفعل");
        return;
    }
    document.getElementById("confirmClearModal").style.display = "flex";
}

function closeConfirmSend() {
    document.getElementById("confirmSendModal").style.display = "none";
}

function closeConfirmClear() {
    document.getElementById("confirmClearModal").style.display = "none";
}

/* ✅ إرسال الطلب */
function sendOrder() {
    if (cart.length === 0) {
        showAlert("⚠️ السلة فارغة");
        closeConfirmSend();
        return;
    }
    
    let total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
    let orderData = {
        items: cart,
        total: total,
        timestamp: Date.now(),
        status: "قيد الانتظار"
    };
    
    db.ref("orders").push(orderData)
        .then(() => {
            showAlert("✅ تم إرسال الطلب بنجاح");
            cart = [];
            localStorage.setItem("cart", JSON.stringify(cart));
            updateCart();
            closeCart();
            closeConfirmSend();
        })
        .catch(error => {
            showAlert("❌ خطأ في إرسال الطلب: " + error.message);
            closeConfirmSend();
        });
}

/* ✅ تفريغ السلة */
function clearCart() {
    cart = [];
    localStorage.setItem("cart", JSON.stringify(cart));
    updateCart();
    showAlert("🗑️ تم تفريغ السلة");
    closeConfirmClear();
    closeCart();
}

/* ✅ نافذة التأكيد والأقسام تشتغل */
window.onload = function(){
    loadCategories();
    loadProducts();
    document.getElementById("cartIcon").onclick = function(){
        const panel = document.getElementById("cartPanel");
        if(panel.classList.contains("open")) panel.classList.remove("open");
        else panel.classList.add("open");
    };
};

/* ✅ تنبيه */
function showAlert(msg){
  let box = document.getElementById("alertBox");
  box.innerHTML = msg;
  box.style.display = "block";
  setTimeout(()=> box.style.display="none", 2500);
}

/* ✅ تكبير الصور */
function openImage(src){ document.getElementById("modalImg").src = src; document.getElementById("imageModal").style.display = "flex"; }
function closeImage(){ document.getElementById("imageModal").style.display = "none"; }
</script>
</body>
</html>