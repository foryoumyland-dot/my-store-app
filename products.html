<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<base href="/my-store-app/">
<title>🛍️ متجري</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<style>
body { 
    background:#fff0f6; 
    font-family: Tahoma; 
    margin: 0; 
    padding: 0; 
    padding-bottom: 80px; 
    padding-top: 70px; /* ⬅️ مساحة للشريط العلوي */
}

/* ===== الشريط العلوي الثابت والمتجاوب ===== */
.top-navbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 60px;
    background: linear-gradient(135deg, #ff69b4, #ff1493);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    z-index: 1000;
    box-shadow: 0 4px 20px rgba(255, 105, 180, 0.4);
    border-bottom: 2px solid #ffb6c1;
}

/* اسم المتجر على اليمين - نص عادي غير قابل للنقر */
.store-name {
    color: white;
    font-weight: bold;
    font-size: 1.3rem;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    padding: 8px 20px;
    border-radius: 25px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    cursor: default;
    user-select: none;
    position: relative;
    overflow: hidden;
}

/* تأثير اللمعة للاسم */
.store-name::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: left 0.5s;
}

.store-name:hover::before {
    left: 100%;
}

/* أيقونة القائمة على اليسار */
.menu-icon {
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    font-size: 1.4rem;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 12px;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.menu-icon:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
    border-color: rgba(255, 255, 255, 0.5);
}

/* القائمة المنسدلة */
.dropdown-menu {
    position: absolute;
    top: 65px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #ffffff, #fff5f7);
    border-radius: 15px;
    box-shadow: 0 8px 30px rgba(255, 105, 180, 0.3);
    padding: 0;
    min-width: 200px;
    display: none;
    z-index: 1001;
    border: 2px solid #ffe4ec;
    backdrop-filter: blur(10px);
    text-align: center;
}

.dropdown-menu.show {
    display: block;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

.dropdown-item {
    display: block;
    padding: 15px 20px;
    text-decoration: none;
    color: #d63384;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    border: none;
    background: none;
    width: 100%;
    text-align: center;
}

.dropdown-item:hover {
    background: linear-gradient(45deg, #fff0f6, #ffe4ec);
    color: #ff1493;
}

/* الخط الفاصل بين العناصر */
.menu-divider {
    width: 80%;
    height: 1px;
    background: linear-gradient(90deg, transparent, #ffb6c1, transparent);
    margin: 0 auto;
}

/* حجب القائمة عند النقر خارجها */
.overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: transparent;
    z-index: 999;
    display: none;
}

/* تصميم متجاوب لجميع الشاشات */
@media (max-width: 768px) {
    .top-navbar {
        height: 55px;
        padding: 0 15px;
    }
    
    .store-name {
        font-size: 1.1rem;
        padding: 6px 15px;
    }
    
    .menu-icon {
        font-size: 1.2rem;
        padding: 6px 10px;
    }
    
    .dropdown-menu {
        min-width: 180px;
        top: 60px;
    }
    
    .dropdown-item {
        padding: 12px 16px;
        font-size: 0.9rem;
    }
}

@media (max-width: 480px) {
    .top-navbar {
        height: 50px;
        padding: 0 10px;
    }
    
    .store-name {
        font-size: 1rem;
        padding: 5px 12px;
    }
    
    .menu-icon {
        font-size: 1.1rem;
        padding: 5px 8px;
    }
    
    .dropdown-menu {
        min-width: 160px;
        top: 55px;
    }
    
    .dropdown-item {
        padding: 10px 14px;
        font-size: 0.85rem;
    }
}

@media (min-width: 1200px) {
    .top-navbar {
        height: 65px;
        padding: 0 25px;
    }
    
    .store-name {
        font-size: 1.5rem;
        padding: 10px 25px;
    }
    
    .menu-icon {
        font-size: 1.6rem;
        padding: 10px 15px;
    }
    
    .dropdown-menu {
        min-width: 220px;
        top: 70px;
    }
    
    .dropdown-item {
        padding: 16px 22px;
        font-size: 1.1rem;
    }
}

.card img { height: auto; width: 100%; object-fit: contain; cursor:pointer; }

/* ✅ تصميم جديد للمنتجات */
.products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px;
    padding: 15px;
}

.product-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(255, 105, 180, 0.1);
    border: 1px solid #ffe4ec;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(255, 105, 180, 0.2);
}

.product-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 15px 15px 0 0;
    cursor: pointer;
}

.product-body {
    padding: 15px;
}

.product-title {
    font-size: 16px;
    font-weight: bold;
    color: #d63384;
    margin-bottom: 8px;
    line-height: 1.3;
}

.product-price {
    font-size: 18px;
    font-weight: bold;
    color: #e91e63;
    margin-bottom: 5px;
}

.product-stock {
    font-size: 12px;
    color: #666;
    margin-bottom: 10px;
}

/* ✅ قلب المفضلة */
.heart-btn {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 18px;
    transition: all 0.3s ease;
    z-index: 10;
}

.heart-btn:hover {
    background: white;
    transform: scale(1.1);
}

.heart-btn.active {
    color: #e91e63;
}

/* ✅ أزرار الأقسام */
#categoriesBar { 
    text-align: center; 
    margin: 20px 0; 
    padding: 0 15px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
}

#categoriesBar .btn { 
    border-radius: 20px; 
    padding: 8px 16px; 
    font-weight: bold;
    font-size: 14px;
    border: 2px solid #d63384;
    color: #d63384;
    background: white;
}

#categoriesBar .btn:hover,
#categoriesBar .btn.active {
    background: linear-gradient(45deg, #ff69b4, #ff1493);
    color: white;
    border-color: #ff69b4;
}

/* ✅ أيقونة السلة - تم التعديل لأسفل الصفحة */
#cartIcon { 
    position: fixed; 
    bottom: 100px; /* فوق الشريط السفلي مباشرة */
    right: 20px; 
    background: #d63384; 
    color: #fff; 
    padding: 12px 18px; 
    border-radius: 50%; 
    font-size: 24px; 
    cursor: pointer; 
    box-shadow: 0px 4px 15px rgba(255, 105, 180, 0.3); 
    z-index: 999; 
    transition: all 0.3s ease;
}

#cartIcon:hover {
    transform: scale(1.1);
    background: #e91e63;
}

#cartCount { 
    position: absolute; 
    top: -5px; 
    right: -5px; 
    background: #28a745; 
    color: #fff; 
    border-radius: 50%; 
    padding: 2px 7px; 
    font-size: 14px; 
}

/* ✅ السلة */
#cartPanel { 
    position: fixed; 
    top: 0; 
    right: -400px; 
    width: 360px; 
    height: 100%; 
    background: #fff; 
    box-shadow: -2px 0 10px rgba(0,0,0,0.3); 
    transition: right 0.4s ease; 
    z-index: 1000; 
    padding: 20px; 
    overflow-y: auto; 
}

#cartPanel.open { right: 0; }
#cartPanel h4 { color:#d63384; font-weight:bold; }

/* ✅ تنبيه */
.alert-custom { 
    position: fixed; 
    top: 80px; 
    left: 50%; 
    transform: translateX(-50%); 
    background: linear-gradient(45deg, #ff416c, #ff4b2b); 
    color: white; 
    padding: 12px 20px; 
    border-radius: 8px; 
    font-size: 16px; 
    font-weight: bold; 
    z-index: 3000; 
    display: none; 
}

/* ✅ تصميم متجاوب */
@media (max-width: 768px) {
    .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 12px;
        padding: 10px;
    }
    
    .product-image {
        height: 180px;
    }
}

@media (max-width: 480px) {
    .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 10px;
        padding: 8px;
    }
    
    .product-image {
        height: 160px;
    }
    
    #categoriesBar .btn {
        font-size: 12px;
        padding: 6px 12px;
    }
    
    #cartIcon {
        bottom: 90px;
        right: 15px;
        padding: 10px 15px;
        font-size: 20px;
    }
}

/* ✅ باقي الأنماط */
#imageModal { display: none; position: fixed; z-index: 4000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
#imageModal img { max-width: 90%; max-height: 90%; border-radius: 8px; }

.confirm-modal { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.5); 
    z-index: 5000; 
    justify-content: center; 
    align-items: center; 
}
.confirm-content { 
    background: white; 
    padding: 25px; 
    border-radius: 15px; 
    text-align: center; 
    box-shadow: 0 5px 25px rgba(0,0,0,0.3);
    max-width: 400px;
    width: 90%;
}
.confirm-buttons { 
    margin-top: 20px; 
    display: flex; 
    gap: 10px; 
    justify-content: center;
}

/* تنبيه البيانات */
.data-alert {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #ff69b4, #ff1493);
    color: white;
    padding: 30px;
    border-radius: 20px;
    font-size: 1.2rem;
    font-weight: bold;
    z-index: 2000;
    display: none;
    box-shadow: 0 15px 40px rgba(255, 105, 180, 0.5);
    text-align: center;
    border: 3px solid white;
    animation: alertPop 0.5s ease;
}

.data-alert-buttons {
    margin-top: 20px;
    display: flex;
    gap: 10px;
    justify-content: center;
}

.data-alert-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.data-alert-btn.primary {
    background: white;
    color: #d63384;
}

.data-alert-btn.secondary {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 2px solid white;
}

.data-alert-btn:hover {
    transform: translateY(-2px);
}

@keyframes alertPop {
    0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
    }
    100% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
}
</style>
</head>
<body>

<!-- الشريط العلوي المدمج مباشرة -->
<nav class="top-navbar">
    <!-- أيقونة القائمة على اليسار -->
    <button class="menu-icon" onclick="toggleMenu()">☰</button>
    
    <!-- اسم المتجر على اليمين - نص عادي -->
    <div class="store-name">🌸 لأجلك سيدتي</div>
    
    <!-- القائمة المنسدلة -->
    <div class="dropdown-menu" id="dropdownMenu">
        <a href="profile.html" class="dropdown-item" onclick="closeMenu()">👤 بياناتي</a>
        <div class="menu-divider"></div>
        <a href="orders.html" class="dropdown-item" onclick="closeMenu()">📦 طلباتي</a>
    </div>
</nav>

<!-- حجب القائمة عند النقر خارجها -->
<div class="overlay" id="overlay" onclick="closeMenu()"></div>

<!-- ✅ العنوان -->
<div class="page-title" style="text-align: center; margin: 20px 0; color: #d63384; font-weight: bold; font-size: 2rem;">🛍️ منتجاتنا</div>

<!-- ✅ الأقسام -->
<div id="categoriesBar"></div>

<!-- ✅ المنتجات -->
<div class="products-grid" id="productsContainer"></div>

<!-- ✅ أيقونة السلة -->
<div id="cartIcon">
  🛒 <span id="cartCount">0</span>
</div>

<!-- ✅ السلة -->
<div id="cartPanel">
  <h4>🛒 سلة المشتريات</h4>
  <div id="cartItems"></div>
  <hr>
  <div id="cartTotal"></div>
  <button class="btn btn-success w-100 mt-2" onclick="confirmSendOrder()">✅ إرسال الطلب</button>
  <button class="btn btn-danger w-100 mt-2" onclick="confirmClearCart()">🗑️ تفريغ السلة</button>
  <button class="btn btn-secondary w-100 mt-2" onclick="closeCart()">⬅️ رجوع</button>
</div>

<!-- ✅ تنبيه -->
<div id="alertBox" class="alert-custom"></div>

<!-- ✅ تنبيه البيانات -->
<div id="dataAlert" class="data-alert">
    <div style="font-size: 3rem; margin-bottom: 15px;">📝</div>
    <h4 style="margin-bottom: 15px;">بياناتك الشخصية مطلوبة</h4>
    <p style="margin-bottom: 20px; line-height: 1.5;">يجب تسجيل بياناتك الشخصية أولاً لإرسال الطلب</p>
    <div class="data-alert-buttons">
        <button class="data-alert-btn primary" onclick="goToProfile()">👤 تسجيل البيانات</button>
        <button class="data-alert-btn secondary" onclick="closeDataAlert()">❌ إلغاء</button>
    </div>
</div>
<div class="overlay" id="dataAlertOverlay" style="display: none;"></div>

<!-- ✅ نافذة تكبير الصور -->
<div id="imageModal" onclick="closeImage()">
  <img id="modalImg" src="">
</div>

<!-- ✅ نافذة تأكيد الإرسال -->
<div id="confirmSendModal" class="confirm-modal">
  <div class="confirm-content">
    <h5 style="color: #d63384;">📦 تأكيد إرسال الطلب</h5>
    <p>هل أنت متأكد من أنك تريد إرسال هذا الطلب؟</p>
    <div class="confirm-buttons">
      <button class="btn btn-success" onclick="sendOrder()">✅ نعم، إرسال</button>
      <button class="btn btn-secondary" onclick="closeConfirmSend()">❌ إلغاء</button>
    </div>
  </div>
</div>

<!-- ✅ نافذة تأكيد التفريغ -->
<div id="confirmClearModal" class="confirm-modal">
  <div class="confirm-content">
    <h5 style="color: #d63384;">🗑️ تأكيد تفريغ السلة</h5>
    <p>هل أنت متأكد من أنك تريد تفريغ السلة؟ سيتم حذف جميع العناصر.</p>
    <div class="confirm-buttons">
      <button class="btn btn-danger" onclick="clearCart()">✅ نعم، تفريغ</button>
      <button class="btn btn-secondary" onclick="closeConfirmClear()">❌ إلغاء</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
const firebaseConfig = { 
    apiKey: "AIzaSyA-LdNQbQneJyxJQ8iMUUd5gsJypTFi6sg",
    authDomain: "mystore-orders-a74f8.firebaseapp.com",
    databaseURL: "https://mystore-orders-a74f8-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "mystore-orders-a74f8",
    storageBucket: "mystore-orders-a74f8.appspot.com",
    messagingSenderId: "431733924264",
    appId: "1:431733924264:web:986b8dc983ef8c0097bd9d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let products = {};
let currentCategory = "";
let categoriesMap = {};
let favorites = JSON.parse(localStorage.getItem("favorites")) || {};

/* ✅ تحميل الأقسام */
function loadCategories() {
  db.ref("categories").on("value", snap => {
    let cats = snap.val() || {};
    let bar = document.getElementById("categoriesBar");
    bar.innerHTML = "";
    
    categoriesMap = {};
    Object.keys(cats).forEach(id=>{
      categoriesMap[id] = cats[id].name;
      
      let btn = document.createElement("button");
      btn.className = "btn btn-outline-primary";
      btn.innerText = cats[id].name;
      btn.onclick = ()=> showCategory(cats[id].name);
      bar.appendChild(btn);
    });
    
    loadProducts();
  });
}

/* ✅ تحميل المنتجات */
function loadProducts() {
  db.ref("products").on("value", snap => {
    products = {};
    let data = snap.val() || {};
    
    Object.keys(data).forEach(id=>{
      let p = data[id];
      
      if(p.status === "معروض" && p.category){
        let categoryName = categoriesMap[p.category];
        
        if(categoryName) {
          if(!products[categoryName]) products[categoryName] = [];
          products[categoryName].push({
            id: id,
            name: p.name,
            price: p.price,
            category: categoryName,
            status: p.status,
            qty: p.stock || 10,
            images: p.images || [],
            sizes: p.sizes || [],
            colors: p.colors || [],
            types: p.types || [] // إضافة حقل النوع
          });
        }
      }
    });
    
    if(currentCategory) showCategory(currentCategory);
  });
}

/* ✅ عرض المنتجات - تصميم جديد */
function showCategory(cat){
  currentCategory = cat;
  let container = document.getElementById("productsContainer");
  container.innerHTML = "";
  
  if(!products[cat] || products[cat].length === 0) {
    container.innerHTML = `<div class="col-12 text-center" style="grid-column: 1 / -1; padding: 40px;"><p style="color: #666; font-size: 18px;">لا توجد منتجات في هذا القسم</p></div>`;
    return;
  }
  
  products[cat].forEach((p,i)=>{
    const isFavorite = favorites[p.id];
    const mainImage = p.images && p.images.length > 0 ? p.images[0] : '';
    
    container.innerHTML += `
      <div class="product-card">
        <button class="heart-btn ${isFavorite ? 'active' : ''}" onclick="toggleFavorite('${p.id}')">
            ${isFavorite ? '❤️' : '🤍'}
        </button>
        <img src="${mainImage}" class="product-image" onclick="openImage('${mainImage}')" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmOWZhIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0i>🛍️ لا توجد صورة</dGV4dD48L3N2Zz4='">
        <div class="product-body">
          <h5 class="product-title">${p.name}</h5>
          <div class="product-price">💵 ${p.price} د</div>
          <div class="product-stock">📦 ${p.qty} متوفر</div>
          ${p.sizes && p.sizes.length ? `<select id="size-${p.id}" class="form-select mb-2" style="font-size: 12px;"><option value="">المقاس</option>${p.sizes.map(s=>`<option value="${s}">${s}</option>`).join("")}</select>` : ""}
          ${p.colors && p.colors.length ? `<select id="color-${p.id}" class="form-select mb-2" style="font-size: 12px;"><option value="">اللون</option>${p.colors.map(c=>`<option value="${c}">${c}</option>`).join("")}</select>` : ""}
          ${p.types && p.types.length ? `<select id="type-${p.id}" class="form-select mb-2" style="font-size: 12px;"><option value="">النوع</option>${p.types.map(t=>`<option value="${t}">${t}</option>`).join("")}</select>` : ""}
          <div class="input-group mb-2">
            <button class="btn btn-outline-danger" style="font-size: 12px; padding: 4px 8px;" onclick="changeQty('${p.id}',-1)">➖</button>
            <input type="text" id="qty-${p.id}" class="form-control text-center" value="1" readonly style="font-size: 12px;">
            <button class="btn btn-outline-success" style="font-size: 12px; padding: 4px 8px;" onclick="changeQty('${p.id}',1)">➕</button>
          </div>
          <button class="btn btn-primary w-100" style="background: linear-gradient(45deg, #ff69b4, #ff1493); border: none; font-size: 14px; padding: 8px;" onclick="addToCart('${p.id}','${p.name}',${p.price},${p.qty})">🛒 أضف للسلة</button>
        </div>
      </div>
    `;
  });
}

/* ✅ قلب المفضلة */
function toggleFavorite(productId) {
    favorites[productId] = !favorites[productId];
    localStorage.setItem("favorites", JSON.stringify(favorites));
    showCategory(currentCategory); // إعادة تحميل العرض لتحديث القلوب
    showAlert(favorites[productId] ? "❤️ تم الإضافة إلى المفضلة" : "🤍 تم الإزالة من المفضلة");
}

/* ✅ إرسال الطلب - مع التحقق من البيانات */
function sendOrder() {
    if (cart.length === 0) {
        showAlert("⚠️ السلة فارغة");
        closeConfirmSend();
        return;
    }
    
    // التحقق من وجود بيانات المستخدم
    const userData = JSON.parse(localStorage.getItem('userProfile'));
    if (!userData || !userData.name || !userData.phone || !userData.city || !userData.address) {
        showDataAlert();
        closeConfirmSend();
        return;
    }
    
    let total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
    let orderData = {
        items: cart,
        total: total,
        timestamp: Date.now(),
        status: "قيد الانتظار",
        customer: userData // إضافة بيانات العميل للطلب
    };
    
    // إرسال الطلب
    db.ref("orders").push(orderData, (error) => {
        if (error) {
            showAlert("❌ خطأ في إرسال الطلب: " + error.message);
            console.error("Firebase error:", error);
        } else {
            showAlert("✅ تم إرسال الطلب بنجاح");
            cart = [];
            localStorage.setItem("cart", JSON.stringify(cart));
            updateCart();
            closeCart();
            closeConfirmSend();
        }
    });
}

/* ✅ باقي الدوال (بدون تغيير) */
function changeQty(id,delta){
  let input = document.getElementById(`qty-${id}`);
  let value = parseInt(input.value) || 1;
  value += delta;
  if(value < 1) value = 1;
  input.value = value;
}

let cart = JSON.parse(localStorage.getItem("cart")) || [];
updateCart();

function addToCart(id,name, price, stock){
  let qty = parseInt(document.getElementById("qty-"+id).value) || 1;
  if(qty > stock) { showAlert("⚠️ الكمية غير متوفرة"); return; }
  let size = document.getElementById("size-"+id)?.value || "";
  let color = document.getElementById("color-"+id)?.value || "";
  let type = document.getElementById("type-"+id)?.value || "";

  if((document.getElementById("size-"+id) && size==="") ||
     (document.getElementById("color-"+id) && color==="") ||
     (document.getElementById("type-"+id) && type==="")){
    showAlert("⚠️ اختر الخيارات المطلوبة");
    return;
  }

  cart.push({id,name, price, qty, size, color, type});
  localStorage.setItem("cart", JSON.stringify(cart));
  updateCart();
  showAlert("✅ تمت إضافة المنتج إلى السلة");
}

function updateCart(){
  document.getElementById("cartCount").innerText = cart.length;
  let container = document.getElementById("cartItems");
  container.innerHTML = "";
  let total = 0;
  cart.forEach((it,index)=>{
    container.innerHTML += `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div style="font-size: 14px;">
          - ${it.name} ${it.size? "| مقاس: "+it.size:""} ${it.color? "| لون: "+it.color:""} ${it.type? "| نوع: "+it.type:""} × ${it.qty} (${it.price * it.qty} د)
        </div>
        <div>
          <button class="btn btn-sm btn-outline-secondary" onclick="editCartQty(${index},-1)">➖</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="editCartQty(${index},1)">➕</button>
          <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})">🗑️</button>
        </div>
      </div>
    `;
    total += it.price * it.qty;
  });
  document.getElementById("cartTotal").innerHTML = `<b>الإجمالي: ${total} د</b><br><small style="color:#d63384;">💵 سعر التوصيل يختلف حسب المدينة</small>`;
}

function editCartQty(index,delta){ cart[index].qty += delta; if(cart[index].qty < 1) cart[index].qty = 1; localStorage.setItem("cart", JSON.stringify(cart)); updateCart(); }
function removeFromCart(index){ cart.splice(index,1); localStorage.setItem("cart", JSON.stringify(cart)); updateCart(); showAlert("🗑️ تم حذف المنتج من السلة"); }
function closeCart(){ document.getElementById("cartPanel").classList.remove("open"); }

function confirmSendOrder() {
    if (cart.length === 0) {
        showAlert("⚠️ السلة فارغة، أضف منتجات أولاً");
        return;
    }
    document.getElementById("confirmSendModal").style.display = "flex";
}

function confirmClearCart() {
    if (cart.length === 0) {
        showAlert("⚠️ السلة فارغة بالفعل");
        return;
    }
    document.getElementById("confirmClearModal").style.display = "flex";
}

function closeConfirmSend() {
    document.getElementById("confirmSendModal").style.display = "none";
}

function closeConfirmClear() {
    document.getElementById("confirmClearModal").style.display = "none";
}

function clearCart() {
    cart = [];
    localStorage.setItem("cart", JSON.stringify(cart));
    updateCart();
    showAlert("🗑️ تم تفريغ السلة");
    closeConfirmClear();
    closeCart();
}

// وظائف القائمة المنسدلة
function toggleMenu() {
    const menu = document.getElementById('dropdownMenu');
    const overlay = document.getElementById('overlay');
    
    if (menu.classList.contains('show')) {
        closeMenu();
    } else {
        menu.classList.add('show');
        overlay.style.display = 'block';
    }
}

function closeMenu() {
    const menu = document.getElementById('dropdownMenu');
    const overlay = document.getElementById('overlay');
    
    menu.classList.remove('show');
    overlay.style.display = 'none';
}

// إغلاق القائمة عند النقر خارجها
document.addEventListener('click', function(event) {
    const menu = document.getElementById('dropdownMenu');
    const icon = document.querySelector('.menu-icon');
    
    if (!menu.contains(event.target) && !icon.contains(event.target)) {
        closeMenu();
    }
});

// إغلاق القائمة عند النقر على رابط
document.querySelectorAll('.dropdown-item').forEach(item => {
    item.addEventListener('click', function() {
        closeMenu();
    });
});

// وظائف تنبيه البيانات
function showDataAlert() {
    document.getElementById('dataAlert').style.display = 'block';
    document.getElementById('dataAlertOverlay').style.display = 'block';
}

function closeDataAlert() {
    document.getElementById('dataAlert').style.display = 'none';
    document.getElementById('dataAlertOverlay').style.display = 'none';
}

function goToProfile() {
    window.location.href = 'profile.html';
}

window.onload = function(){
    loadCategories();
    document.getElementById("cartIcon").onclick = function(){
        const panel = document.getElementById("cartPanel");
        if(panel.classList.contains("open")) panel.classList.remove("open");
        else panel.classList.add("open");
    };
};

function showAlert(msg){
  let box = document.getElementById("alertBox");
  box.innerHTML = msg;
  box.style.display = "block";
  setTimeout(()=> box.style.display="none", 2500);
}

function openImage(src){ 
    if(src && src.startsWith('data:image')) {
        document.getElementById("modalImg").src = src; 
        document.getElementById("imageModal").style.display = "flex"; 
    }
}
function closeImage(){ document.getElementById("imageModal").style.display = "none"; }
</script>

<!-- الشريط السفلي -->
<iframe src="bottom-nav.html" style="width:100%; height:80px; border:none; position: fixed; bottom: 0; left: 0; z-index: 1000;"></iframe>
</body>
</html>