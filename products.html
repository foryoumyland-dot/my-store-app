<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<base href="/my-store-app/">
<title>ğŸ›ï¸ Ù…ØªØ¬Ø±ÙŠ | Ø±ÙŠÙ€Ù€Ù€ÙÙ€Ù€Ù€REVANAÙ€Ù€Ù€Ù€Ø§Ù†Ù€Ù€Ù€Ù€Ù€Ø§</title> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<style>
/* ... (Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©) ... */
body { 
    background:#fff0f6; 
    font-family: Tahoma; 
    margin: 0; 
    padding: 0; 
    padding-bottom: 80px; 
    padding-top: 70px; 
}

/* ===== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø§Ù„Ø«Ø§Ø¨Øª ÙˆØ§Ù„Ù…ØªØ¬Ø§ÙˆØ¨ ===== */
.top-navbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 60px;
    background: linear-gradient(135deg, #ff69b4, #ff1493);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    z-index: 1000;
    box-shadow: 0 4px 20px rgba(255, 105, 180, 0.4);
    border-bottom: 2px solid #ffb6c1;
}

.store-name {
    color: white;
    font-weight: bold;
    font-size: 1.3rem;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    padding: 8px 20px;
    border-radius: 25px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    cursor: default;
    user-select: none;
    position: relative;
    overflow: hidden;
}

.store-name::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: left 0.5s;
}

.store-name:hover::before {
    left: 100%;
}

.menu-icon {
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    font-size: 1.4rem;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 12px;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.menu-icon:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
    border-color: rgba(255, 255, 255, 0.5);
}

.dropdown-menu {
    position: absolute;
    top: 65px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #ffffff, #fff5f7);
    border-radius: 15px;
    box-shadow: 0 8px 30px rgba(255, 105, 180, 0.3);
    padding: 0;
    min-width: 200px;
    display: none;
    z-index: 1001;
    border: 2px solid #ffe4ec;
    backdrop-filter: blur(10px);
    text-align: center;
}

.dropdown-menu.show {
    display: block;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

.dropdown-item {
    display: block;
    padding: 15px 20px;
    text-decoration: none;
    color: #d63384;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    border: none;
    background: none;
    width: 100%;
    text-align: center;
}

.dropdown-item:hover {
    background: linear-gradient(45deg, #fff0f6, #ffe4ec);
    color: #ff1493;
}

.menu-divider {
    width: 80%;
    height: 1px;
    background: linear-gradient(90deg, transparent, #ffb6c1, transparent);
    margin: 0 auto;
}

.overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: transparent;
    z-index: 999;
    display: none;
}

@media (max-width: 768px) {
    .top-navbar {
        height: 55px;
        padding: 0 15px;
    }
    
    .store-name {
        font-size: 1.1rem;
        padding: 6px 15px;
    }
    
    .menu-icon {
        font-size: 1.2rem;
        padding: 6px 10px;
    }
    
    .dropdown-menu {
        min-width: 180px;
        top: 60px;
    }
    
    .dropdown-item {
        padding: 12px 16px;
        font-size: 0.9rem;
    }
}

@media (max-width: 480px) {
    .top-navbar {
        height: 50px;
        padding: 0 10px;
    }
    
    .store-name {
        font-size: 1rem;
        padding: 5px 12px;
    }
    
    .menu-icon {
        font-size: 1.1rem;
        padding: 5px 8px;
    }
    
    .dropdown-menu {
        min-width: 160px;
        top: 55px;
    }
    
    .dropdown-item {
        padding: 10px 14px;
        font-size: 0.85rem;
    }
}

@media (min-width: 1200px) {
    .top-navbar {
        height: 65px;
        padding: 0 25px;
    }
    
    .store-name {
        font-size: 1.5rem;
        padding: 10px 25px;
    }
    
    .menu-icon {
        font-size: 1.6rem;
        padding: 10px 15px;
    }
    
    .dropdown-menu {
        min-width: 220px;
        top: 70px;
    }
    
    .dropdown-item {
        padding: 16px 22px;
        font-size: 1.1rem;
    }
}

.card img { height: auto; width: 100%; object-fit: contain; cursor:pointer; }

/* âœ… ØªØµÙ…ÙŠÙ… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª */
.products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px;
    padding: 15px;
}

.product-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(255, 105, 180, 0.1);
    border: 1px solid #ffe4ec;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(255, 105, 180, 0.2);
}

.option-select:disabled,
.form-select.out-of-stock-option,
.product-card.out-of-stock {
    opacity: 0.4; 
    cursor: not-allowed;
}

.product-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 15px 15px 0 0;
    cursor: pointer;
}

.product-body {
    padding: 15px;
}

.product-title {
    font-size: 16px;
    font-weight: bold;
    color: #d63384;
    margin-bottom: 8px;
    line-height: 1.3;
}

.product-price {
    font-size: 18px;
    font-weight: bold;
    color: #e91e63;
    margin-bottom: 5px;
}

.product-stock {
    font-size: 12px;
    color: #666;
    margin-bottom: 10px;
}

/* âœ… Ù‚Ù„Ø¨ Ø§Ù„Ù…ÙØ¶Ù„Ø© */
.heart-btn {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 18px;
    transition: all 0.3s ease;
    z-index: 10;
}

.heart-btn:hover {
    background: white;
    transform: scale(1.1);
}

.heart-btn.active {
    color: #e91e63;
}

/* âœ… Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
#categoriesBar { 
    text-align: center; 
    margin: 20px 0; 
    padding: 0 15px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
}

#categoriesBar .btn { 
    border-radius: 20px; 
    padding: 8px 16px; 
    font-weight: bold;
    font-size: 14px;
    border: 2px solid #d63384;
    color: #d63384;
    background: white;
}

#categoriesBar .btn:hover,
#categoriesBar .btn.active {
    background: linear-gradient(45deg, #ff69b4, #ff1493);
    color: white;
    border-color: #ff69b4;
}

/* âœ… Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³Ù„Ø© */
#cartIcon { 
    position: fixed; 
    bottom: 100px;
    right: 20px; 
    background: #d63384; 
    color: #fff; 
    padding: 12px 18px; 
    border-radius: 50%; 
    font-size: 24px; 
    cursor: pointer; 
    box-shadow: 0px 4px 15px rgba(255, 105, 180, 0.3); 
    z-index: 999; 
    transition: all 0.3s ease;
}

#cartIcon:hover {
    transform: scale(1.1);
    background: #e91e63;
}

#cartCount { 
    position: absolute; 
    top: -5px; 
    right: -5px; 
    background: #28a745; 
    color: #fff; 
    border-radius: 50%; 
    padding: 2px 7px; 
    font-size: 14px; 
}

/* âœ… Ø§Ù„Ø³Ù„Ø© */
#cartPanel { 
    position: fixed; 
    top: 0; 
    right: -400px; 
    width: 360px; 
    height: 100%; 
    background: #fff; 
    box-shadow: -2px 0 10px rgba(0,0,0,0.3); 
    transition: right 0.4s ease; 
    z-index: 1000; 
    padding: 20px; 
    overflow-y: auto; 
}

#cartPanel.open { right: 0; }
#cartPanel h4 { color:#d63384; font-weight:bold; }

/* âœ… ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ø³Ù„Ø© (Ø¬Ø¯ÙŠØ¯) */
.cart-item-img {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 5px;
    margin-left: 10px;
    border: 1px solid #eee;
}

/* âœ… ØªÙ†Ø¨ÙŠÙ‡ */
.alert-custom { 
    position: fixed; 
    top: 80px; 
    left: 50%; 
    transform: translateX(-50%); 
    background: linear-gradient(45deg, #ff416c, #ff4b2b); 
    color: white; 
    padding: 12px 20px; 
    border-radius: 8px; 
    font-size: 16px; 
    font-weight: bold; 
    z-index: 3000; 
    display: none; 
}

/* âœ… ØªØµÙ…ÙŠÙ… Ù…ØªØ¬Ø§ÙˆØ¨ */
@media (max-width: 768px) {
    .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 12px;
        padding: 10px;
    }
    
    .product-image {
        height: 180px;
    }
}

@media (max-width: 480px) {
    .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 10px;
        padding: 8px;
    }
    
    .product-image {
        height: 160px;
    }
    
    #categoriesBar .btn {
        font-size: 12px;
        padding: 6px 12px;
    }
    
    #cartIcon {
        bottom: 90px;
        right: 15px;
        padding: 10px 15px;
        font-size: 20px;
    }
}

/* âœ… Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù†Ù…Ø§Ø· */
.confirm-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 5000; justify-content: center; align-items: center; }
.confirm-content { background: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 5px 25px rgba(0,0,0,0.3); max-width: 400px; width: 90%; }
.confirm-buttons { margin-top: 20px; display: flex; gap: 10px; justify-content: center;}

/* ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
.data-alert { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #ff69b4, #ff1493); color: white; padding: 30px; border-radius: 20px; font-size: 1.2rem; font-weight: bold; z-index: 2000; display: none; box-shadow: 0 15px 40px rgba(255, 105, 180, 0.5); text-align: center; border: 3px solid white; animation: alertPop 0.5s ease; }
.data-alert-buttons { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
.data-alert-btn { padding: 10px 20px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; }
.data-alert-btn.primary { background: white; color: #d63384; }
.data-alert-btn.secondary { background: rgba(255, 255, 255, 0.2); color: white; border: 2px solid white; }
.data-alert-btn:hover { transform: translateY(-2px); }
@keyframes alertPop { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); } 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); } }

/* ğŸ†• Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
.product-gallery { position: relative; width: 100%; height: 200px; overflow: hidden; border-radius: 15px 15px 0 0; }
.main-product-image { width: 100%; height: 100%; object-fit: cover; cursor: pointer; transition: transform 0.3s ease; }
.main-product-image:hover { transform: scale(1.05); }
.thumbnail-container { position: absolute; bottom: 10px; left: 0; right: 0; display: flex; justify-content: center; gap: 5px; padding: 0 10px; }
.thumbnail { width: 30px; height: 30px; object-fit: cover; border-radius: 4px; border: 2px solid transparent; cursor: pointer; opacity: 0.7; transition: all 0.3s ease; }
.thumbnail.active { border-color: #ff69b4; opacity: 1; }
.thumbnail:hover { opacity: 1; }
.image-nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255, 255, 255, 0.8); border: none; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; color: #d63384; transition: all 0.3s ease; z-index: 10; }
.image-nav-btn:hover { background: white; transform: translateY(-50%) scale(1.1); }
.image-nav-btn.prev { right: 10px; }
.image-nav-btn.next { left: 10px; }
.image-counter { position: absolute; top: 10px; left: 10px; background: rgba(0, 0, 0, 0.6); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; z-index: 10; }

/* Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ÙˆØ³Ø¹ */
.image-gallery-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 4000; justify-content: center; align-items: center; }
.gallery-main-image { max-width: 90%; max-height: 80%; object-fit: contain; border-radius: 10px; }
.gallery-thumbnails { position: absolute; bottom: 20px; left: 0; right: 0; display: flex; justify-content: center; gap: 10px; padding: 10px; }
.gallery-thumbnail { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border: 2px solid transparent; cursor: pointer; opacity: 0.7; transition: all 0.3s ease; }
.gallery-thumbnail.active { border-color: #ff69b4; opacity: 1; }
.gallery-thumbnail:hover { opacity: 1; }
.gallery-nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255, 255, 255, 0.2); border: none; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; color: white; transition: all 0.3s ease; }
.gallery-nav-btn:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-50%) scale(1.1); }
.gallery-nav-btn.prev { right: 20px; }
.gallery-nav-btn.next { left: 20px; }
.gallery-close { position: absolute; top: 20px; right: 20px; background: rgba(255, 255, 255, 0.2); border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; color: white; transition: all 0.3s ease; }
.gallery-close:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
.gallery-counter { position: absolute; top: 20px; left: 20px; color: white; font-size: 16px; font-weight: bold; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 10px; z-index: 10; }
</style>
</head>
<body>

<nav class="top-navbar">
    <button class="menu-icon" onclick="toggleMenu()">â˜°</button>
    
    <div class="store-name">ğŸŒ¸ Ø±ÙŠÙ€Ù€Ù€ÙÙ€Ù€Ù€<span dir="ltr">REVANA</span>Ù€Ù€Ù€Ù€Ø§Ù†Ù€Ù€Ù€Ù€Ù€Ø§</div>
    
    <div class="dropdown-menu" id="dropdownMenu">
        <a href="profile.html" class="dropdown-item" onclick="closeMenu()">ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ</a>
        <div class="menu-divider"></div>
        <a href="orders.html" class="dropdown-item" onclick="closeMenu()">ğŸ“¦ Ø·Ù„Ø¨Ø§ØªÙŠ</a>
    </div>
</nav>

<div class="overlay" id="overlay" onclick="closeMenu()"></div>

<div class="page-title" style="text-align: center; margin: 20px 0; color: #d63384; font-weight: bold; font-size: 2rem;">ğŸ›ï¸ Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§</div>

<div id="categoriesBar"></div>

<div class="products-grid" id="productsContainer"></div>

<div id="cartIcon">
  ğŸ›’ <span id="cartCount">0</span>
</div>

<div id="cartPanel">
  <h4>ğŸ›’ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h4>
  <div id="cartItems"></div>
  <hr>
  <div id="cartTotal"></div>
  <button class="btn btn-success w-100 mt-2" onclick="confirmSendOrder()">âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
  <button class="btn btn-danger w-100 mt-2" onclick="confirmClearCart()">ğŸ—‘ï¸ ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©</button>
  <button class="btn btn-secondary w-100 mt-2" onclick="closeCart()">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
</div>

<div id="alertBox" class="alert-custom"></div>

<div id="dataAlert" class="data-alert">
    <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ“</div>
    <h4 style="margin-bottom: 15px;">Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ© Ù…Ø·Ù„ÙˆØ¨Ø©</h4>
    <p style="margin-bottom: 20px; line-height: 1.5;">ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</p>
    <div class="data-alert-buttons">
        <button class="data-alert-btn primary" onclick="goToProfile()">ğŸ‘¤ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button class="data-alert-btn secondary" onclick="closeDataAlert()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>
<div class="overlay" id="dataAlertOverlay" style="display: none;"></div>

<div id="confirmSendModal" class="confirm-modal">
  <div class="confirm-content">
    <h5 style="color: #d63384;">ğŸ“¦ ØªØ£ÙƒÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</h5>
    <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ</p>
    <div class="confirm-buttons">
      <button class="btn btn-success" onclick="sendOrder()">âœ… Ù†Ø¹Ù…ØŒ Ø¥Ø±Ø³Ø§Ù„</button>
      <button class="btn btn-secondary" onclick="closeConfirmSend()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<div id="confirmClearModal" class="confirm-modal">
  <div class="confirm-content">
    <h5 style="color: #d63384;">ğŸ—‘ï¸ ØªØ£ÙƒÙŠØ¯ ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©</h5>
    <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±.</p>
    <div class="confirm-buttons">
      <button class="btn btn-danger" onclick="clearCart()">âœ… Ù†Ø¹Ù…ØŒ ØªÙØ±ÙŠØº</button>
      <button class="btn btn-secondary" onclick="closeConfirmClear()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<div id="imageGalleryModal" class="image-gallery-modal">
    <button class="gallery-close" onclick="closeImageGallery()">âœ•</button>
    <div class="gallery-counter" id="galleryCounter">1/5</div>
    <button class="gallery-nav-btn prev" onclick="prevGalleryImage()">â®</button>
    <img class="gallery-main-image" id="galleryMainImage" src="">
    <button class="gallery-nav-btn next" onclick="nextGalleryImage()">â¯</button>
    <div class="gallery-thumbnails" id="galleryThumbnails"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
const firebaseConfig = { 
    apiKey: "AIzaSyA-LdNQbQneJyxJQ8iMUUd5gsJypTFi6sg",
    authDomain: "mystore-orders-a74f8.firebaseapp.com",
    databaseURL: "https://mystore-orders-a74f8-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "mystore-orders-a74f8",
    storageBucket: "mystore-orders-a74f8.appspot.com",
    messagingSenderId: "431733924264",
    appId: "1:431733924264:web:986b8dc983ef8c0097bd9d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ğŸ”” Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… (ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©)
const TELEGRAM_TOKEN = "8493711191:AAFeTCns1pWV9whkdFaYpaw2r4voO2Zpd48";
const TELEGRAM_CHAT_ID = "8386976225";

let products = {};
let currentCategory = "";
let categoriesMap = {};
let favorites = JSON.parse(localStorage.getItem("favorites")) || {};
let currentGalleryImages = [];
let currentGalleryIndex = 0;

function getShippingCost() {
    const userData = JSON.parse(localStorage.getItem('userProfile'));
    let shippingCost = 0;
    if (userData && userData.cityData) {
        const cityDataParts = userData.cityData.split('_');
        shippingCost = parseFloat(cityDataParts[cityDataParts.length - 1]) || 0;
    }
    return shippingCost;
}

function loadCategories() {
  db.ref("categories").on("value", snap => {
    let cats = snap.val() || {};
    let bar = document.getElementById("categoriesBar");
    bar.innerHTML = "";
    categoriesMap = {};
    Object.keys(cats).forEach(id=>{
      categoriesMap[id] = cats[id].name;
      let btn = document.createElement("button");
      btn.className = "btn btn-outline-primary";
      btn.innerText = cats[id].name;
      btn.onclick = ()=> showCategory(cats[id].name);
      bar.appendChild(btn);
    });
    loadProducts();
  });
}

function loadProducts() {
  db.ref("products").on("value", snap => {
    products = {};
    let data = snap.val() || {};
    Object.keys(data).forEach(id=>{
      let p = data[id];
      if(p.status === "Ù…Ø¹Ø±ÙˆØ¶" && p.category){
        let categoryName = categoriesMap[p.category];
        if(categoryName) {
          if(!products[categoryName]) products[categoryName] = [];
          products[categoryName].push({
            id: id,
            name: p.name,
            price: p.price,
            category: categoryName,
            status: p.status,
            stockDetails: p.stockDetails || [], 
            totalStock: p.totalStock !== undefined ? p.totalStock : 0, 
            images: p.images || [],
            sizes: p.sizes || [],
            colors: p.colors || [],
            types: p.types || [] 
          });
        }
      }
    });
    if(currentCategory) showCategory(currentCategory);
    else {
        const firstCategory = Object.keys(products)[0];
        if(firstCategory) showCategory(firstCategory);
    }
  });
}

function showCategory(cat){
  currentCategory = cat;
  document.querySelectorAll('#categoriesBar .btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('#categoriesBar .btn').forEach(btn => {
    if(btn.innerText.trim() === cat.trim()) btn.classList.add('active');
  });

  let container = document.getElementById("productsContainer");
  container.innerHTML = "";
  
  if(!products[cat] || products[cat].length === 0) {
    container.innerHTML = `<div class="col-12 text-center" style="grid-column: 1 / -1; padding: 40px;"><p style="color: #666; font-size: 18px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</p></div>`;
    return;
  }
  
  products[cat].forEach((p,i)=>{
    const isFavorite = favorites[p.id];
    const hasMultipleImages = p.images && p.images.length > 1;
    const currentTotalStock = p.totalStock || 0;
    const isOutOfStock = currentTotalStock === 0;

    container.innerHTML += `
      <div class="product-card ${isOutOfStock ? 'out-of-stock' : ''}" id="product-card-${p.id}">
        <button class="heart-btn ${isFavorite ? 'active' : ''}" onclick="toggleFavorite('${p.id}')">
            ${isFavorite ? 'â¤ï¸' : 'ğŸ¤'}
        </button>
        <div class="product-gallery" id="gallery-${p.id}">
          ${hasMultipleImages ? `<div class="image-counter">1/${p.images.length}</div>` : ''}
          <img src="${p.images[0] || getDefaultImage()}" class="main-product-image" 
               onclick="openImageGallery('${p.id}')" 
               onerror="this.src='${getDefaultImage()}'"
               data-current-index="0">
          
          ${hasMultipleImages ? `
            <button class="image-nav-btn prev" onclick="changeProductImage('${p.id}', -1)">â®</button>
            <button class="image-nav-btn next" onclick="changeProductImage('${p.id}', 1)">â¯</button>
            <div class="thumbnail-container" id="thumbnails-${p.id}">
              ${p.images.map((img, index) => `
                <img src="${img}" class="thumbnail ${index === 0 ? 'active' : ''}" 
                     onclick="setProductImage('${p.id}', ${index})"
                     onerror="this.src='${getDefaultImage()}'">
              `).join('')}
            </div>
          ` : ''}
        </div>
        <div class="product-body">
          <h5 class="product-title">${p.name}</h5>
          <div class="product-price">ğŸ’µ ${p.price} Ø¯</div>
          
          ${p.colors && p.colors.length ? 
            `<select id="color-${p.id}" class="form-select mb-2 color-select option-select" style="font-size: 12px;" onchange="updateStockStatus('${p.id}'); updateDependentOptions('${p.id}', 'color')"><option value="">Ø§Ù„Ù„ÙˆÙ†</option>${p.colors.map(c=>`<option value="${c}">${c}</option>`).join("")}</select>` 
            : ""}

          ${p.sizes && p.sizes.length ? 
            `<select id="size-${p.id}" class="form-select mb-2 size-select option-select" style="font-size: 12px;" onchange="updateStockStatus('${p.id}'); updateDependentOptions('${p.id}', 'size')"><option value="">Ø§Ù„Ù…Ù‚Ø§Ø³</option>${p.sizes.map(s=>`<option value="${s}">${s}</option>`).join("")}</select>` 
            : ""}
          
          ${p.types && p.types.length ? 
            `<select id="type-${p.id}" class="form-select mb-2 type-select option-select" style="font-size: 12px;" onchange="updateStockStatus('${p.id}'); updateDependentOptions('${p.id}', 'type')"><option value="">Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ù‡Ø§ØªÙ</option>${p.types.map(t=>`<option value="${t}">${t}</option>`).join("")}</select>` 
            : ""}
          
          <p id="stock-alert-${p.id}" style="font-size: 12px; color: red; font-weight: bold; margin-bottom: 5px;">${isOutOfStock ? 'ğŸ”´ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹' : ''}</p>
          
          <div class="input-group mb-2">
            <button class="btn btn-outline-danger" style="font-size: 12px; padding: 4px 8px;" onclick="changeQty('${p.id}',-1)">â–</button>
            <input type="text" id="qty-${p.id}" class="form-control text-center" value="1" readonly style="font-size: 12px;">
            <button class="btn btn-outline-success" style="font-size: 12px; padding: 4px 8px;" onclick="changeQty('${p.id}',1)">â•</button>
          </div>
          
          <button class="btn btn-primary w-100" style="background: linear-gradient(45deg, #ff69b4, #ff1493); border: none; font-size: 14px; padding: 8px;" onclick="addToCart('${p.id}')" id="add-btn-${p.id}" ${isOutOfStock ? 'disabled' : ''}>ğŸ›’ Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
        </div>
      </div>
    `;
    setTimeout(() => {
        updateDependentOptions(p.id, '');
        updateStockStatus(p.id);
    }, 50);
  });
}

function updateDependentOptions(productId, changedOptionType) {
    const product = getProductById(productId);
    if (!product || !product.stockDetails || product.stockDetails.length === 0) return;

    const sizeSelect = document.getElementById(`size-${productId}`);
    const colorSelect = document.getElementById(`color-${productId}`);
    const typeSelect = document.getElementById(`type-${productId}`);

    const selectedColor = colorSelect ? colorSelect.value : "";
    const selectedSize = sizeSelect ? sizeSelect.value : "";
    const selectedType = typeSelect ? typeSelect.value : "";
    
    if (sizeSelect) {
        Array.from(sizeSelect.options).slice(1).forEach(option => {
            const currentSize = option.value;
            let stock = 0;
            const combinationExists = product.stockDetails.some(item => {
                const itemColorMatch = !selectedColor || item.color === selectedColor;
                const itemTypeMatch = !selectedType || item.type === selectedType;
                const itemSizeMatch = item.size === currentSize;
                if (itemColorMatch && itemTypeMatch && itemSizeMatch) {
                    stock += item.quantity;
                    return true; 
                }
                return false;
            });
            if (stock === 0) { option.classList.add('out-of-stock-option'); option.disabled = true; } 
            else { option.classList.remove('out-of-stock-option'); option.disabled = false; }
        });
    }

    if (colorSelect) {
        Array.from(colorSelect.options).slice(1).forEach(option => {
            const currentColor = option.value;
            let stock = 0;
            const combinationExists = product.stockDetails.some(item => {
                const itemSizeMatch = !selectedSize || item.size === selectedSize;
                const itemTypeMatch = !selectedType || item.type === selectedType;
                const itemColorMatch = item.color === currentColor;
                if (itemSizeMatch && itemTypeMatch && itemColorMatch) {
                    stock += item.quantity;
                    return true;
                }
                return false;
            });
            if (stock === 0) { option.classList.add('out-of-stock-option'); option.disabled = true; } 
            else { option.classList.remove('out-of-stock-option'); option.disabled = false; }
        });
    }

    if (typeSelect) {
        Array.from(typeSelect.options).slice(1).forEach(option => {
            const currentType = option.value;
            let stock = 0;
            const combinationExists = product.stockDetails.some(item => {
                const itemSizeMatch = !selectedSize || item.size === selectedSize;
                const itemColorMatch = !selectedColor || item.color === selectedColor;
                const itemTypeMatch = item.type === currentType;
                if (itemSizeMatch && itemColorMatch && itemTypeMatch) {
                    stock += item.quantity;
                    return true;
                }
                return false;
            });
            if (stock === 0) { option.classList.add('out-of-stock-option'); option.disabled = true; } 
            else { option.classList.remove('out-of-stock-option'); option.disabled = false; }
        });
    }
}

function getAvailableStock(productId, color, size, type) { 
    const product = getProductById(productId);
    if (!product || !product.stockDetails) return product?.totalStock || 0;
    
    const finalColor = (product.colors && product.colors.length > 0) ? color : "";
    const finalSize = (product.sizes && product.sizes.length > 0) ? size : "";
    const finalType = (product.types && product.types.length > 0) ? type : ""; 

    const stockItem = product.stockDetails.find(item => 
        (item.color === finalColor) && 
        (item.size === finalSize) &&
        (item.type === finalType) 
    );
    return stockItem ? stockItem.quantity : 0;
}

function updateStockStatus(productId) {
    const product = getProductById(productId);
    if (!product) return;

    const sizeSelect = document.getElementById(`size-${productId}`);
    const colorSelect = document.getElementById(`color-${productId}`);
    const typeSelect = document.getElementById(`type-${productId}`);
    const addBtn = document.getElementById(`add-btn-${productId}`);
    const stockAlert = document.getElementById(`stock-alert-${productId}`);
    const qtyInput = document.getElementById(`qty-${productId}`);

    const selectedSize = sizeSelect ? sizeSelect.value : "";
    const selectedColor = colorSelect ? colorSelect.value : "";
    const selectedType = typeSelect ? typeSelect.value : "";
    
    let availableStock = product.totalStock || 0; 
    const requiresColor = product.colors && product.colors.length > 0;
    const requiresSize = product.sizes && product.sizes.length > 0;
    const requiresType = product.types && product.types.length > 0;
    const requiresSelection = requiresColor || requiresSize || requiresType;
    
    const isReadyToSelect = (!requiresColor || selectedColor) && (!requiresSize || selectedSize) && (!requiresType || selectedType);

    if (requiresSelection) {
        if (isReadyToSelect) { availableStock = getAvailableStock(productId, selectedColor, selectedSize, selectedType); } 
        else { availableStock = 0; }
    } else { availableStock = product.totalStock || 0; }
    
    let message = "";
    let isDisabled = false;

    if (requiresSelection && !isReadyToSelect) {
        const missingOptions = [];
        if (requiresColor && !selectedColor) missingOptions.push(" Ø§Ù„Ù„ÙˆÙ†");
        if (requiresSize && !selectedSize) missingOptions.push(" Ø§Ù„Ù…Ù‚Ø§Ø³");
        if (requiresType && !selectedType) missingOptions.push(" Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ù‡Ø§ØªÙ");
        message = "âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø±" + missingOptions.join(" Ùˆ") + " Ø£ÙˆÙ„Ø§Ù‹";
        isDisabled = true;
    } else if (availableStock === 0) {
        message = "ğŸ”´ ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹" + (requiresSelection ? " Ø¨Ù‡Ø°Ù‡ Ø§Ù„ØªØ±ÙƒÙŠØ¨Ø©" : "");
        isDisabled = true;
    } else if (availableStock > 0) {
        message = `âœ… Ù…ØªÙˆÙØ±: ${availableStock} Ù‚Ø·Ø¹Ø©`;
        isDisabled = false;
    }
    
    stockAlert.style.color = isDisabled ? 'red' : 'green';
    stockAlert.innerText = message;
    addBtn.disabled = isDisabled;
    
    const currentQty = parseInt(qtyInput.value) || 1;
    if (currentQty > availableStock && availableStock > 0) { qtyInput.value = availableStock; }
    qtyInput.setAttribute('data-max-stock', availableStock);
}

function toggleFavorite(productId) {
    favorites[productId] = !favorites[productId];
    localStorage.setItem("favorites", JSON.stringify(favorites));
    showCategory(currentCategory);
    showAlert(favorites[productId] ? "â¤ï¸ ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©" : "ğŸ¤ ØªÙ… Ø§Ù„Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©");
}

// ğŸ”¥ Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… (Ø¬Ø¯ÙŠØ¯) ğŸ”¥
function sendTelegramNotification(orderData) {
    if (!TELEGRAM_TOKEN || !TELEGRAM_CHAT_ID) return;

    let itemsList = orderData.items.map(item => 
        `â–«ï¸ ${item.name} ${item.size ? `(Ù…:${item.size})` : ''} ${item.color ? `(Ù„:${item.color})` : ''} ${item.type ? `(Ù†:${item.type})` : ''} Ã— ${item.qty}`
    ).join('%0A');

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
    let cityName = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
    if (orderData.customer && orderData.customer.cityData) {
        cityName = orderData.customer.cityData.split('_')[0];
    }

    let message = `
ğŸš¨ *Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯!* ğŸš¨
--------------------
ğŸ‘¤ *Ø§Ù„Ø¹Ù…ÙŠÙ„:* ${orderData.customer.name}
ğŸ“ *Ø§Ù„Ù‡Ø§ØªÙ:* ${orderData.customer.phone}
ğŸ™ *Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:* ${cityName}
ğŸ“ *Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:* ${orderData.customer.address}
--------------------
ğŸ›’ *Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:*
${itemsList}
--------------------
ğŸšš *Ø§Ù„ØªÙˆØµÙŠÙ„:* ${orderData.shippingCost} Ø¯.Ù„
ğŸ’° *Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:* ${orderData.total} Ø¯.Ù„
    `;

    const url = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(message)}&parse_mode=Markdown`;

    fetch(url).catch(err => console.error("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…", err));
}

async function sendOrder() {
    if (cart.length === 0) {
        showAlert("âš ï¸ Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©");
        closeConfirmSend();
        return;
    }
    const userData = JSON.parse(localStorage.getItem('userProfile'));
    if (!userData || !userData.name || !userData.phone || !userData.cityData || !userData.address) {
        showDataAlert();
        closeConfirmSend();
        return;
    }
    closeConfirmSend();
    showAlert("â³ ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...", 5000); 

    let subTotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
    const shippingCost = getShippingCost();
    const grandTotal = subTotal + shippingCost;
    
    let allTransactionsSuccessful = true;
    let failedItemName = ""; 

    for (const item of cart) {
        const productRef = db.ref(`products/${item.id}`);
        const result = await productRef.transaction(currentProduct => {
            if (!currentProduct) { failedItemName = item.name + " (ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯)"; return; }
            let requiredQty = item.qty;
            let newTotalStock = currentProduct.totalStock !== undefined ? currentProduct.totalStock : 0;
            let stockReduced = false;
            const finalColor = (currentProduct.colors && currentProduct.colors.length > 0) ? item.color : "";
            const finalSize = (currentProduct.sizes && currentProduct.sizes.length > 0) ? item.size : "";
            const finalType = (currentProduct.types && currentProduct.types.length > 0) ? item.type : ""; 

            if (currentProduct.stockDetails && currentProduct.stockDetails.length > 0) {
                let detailIndex = currentProduct.stockDetails.findIndex(detail => 
                    detail.color === finalColor && detail.size === finalSize && detail.type === finalType
                );
                if (detailIndex === -1) { failedItemName = item.name; return; }
                let detail = currentProduct.stockDetails[detailIndex];
                if (detail.quantity >= requiredQty) {
                    detail.quantity -= requiredQty; newTotalStock -= requiredQty; stockReduced = true;
                }
            } else {
                if (newTotalStock >= requiredQty) { newTotalStock -= requiredQty; stockReduced = true; }
            }
            if (stockReduced) {
                currentProduct.totalStock = newTotalStock;
                if (currentProduct.stock !== undefined) currentProduct.stock = newTotalStock; 
                return currentProduct; 
            } else { failedItemName = item.name; return; }
        });
        if (!result.committed) { allTransactionsSuccessful = false; if (!failedItemName) failedItemName = item.name; break; }
    }
    
    if (allTransactionsSuccessful) {
        let orderData = {
            items: cart,
            subTotal: subTotal,
            shippingCost: shippingCost,
            total: grandTotal,
            timestamp: Date.now(),
            status: "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±",
            customer: userData 
        };

        // ğŸ”¥ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… ğŸ”¥
        sendTelegramNotification(orderData);

        db.ref("orders").push(orderData, (error) => {
            if (error) { showAlert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨: " + error.message); } 
            else {
                showAlert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªÙ… Ø®ØµÙ… Ø§Ù„ÙƒÙ…ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†");
                cart = [];
                localStorage.setItem("cart", JSON.stringify(cart));
                updateCart();
                closeCart();
                loadProducts();
            }
        });
    } else {
        showAlert(`âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨. Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù€ ${failedItemName} ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©.`, 5000);
        loadProducts(); 
    }
}

function changeQty(id,delta){
  let input = document.getElementById(`qty-${id}`);
  let value = parseInt(input.value) || 1;
  const maxStock = parseInt(input.getAttribute('data-max-stock')) || 1; 
  value += delta;
  if(value < 1) value = 1; 
  if(value > maxStock) value = maxStock; 
  if(maxStock === 0) value = 1; 
  input.value = value;
}

let cart = JSON.parse(localStorage.getItem("cart")) || [];
updateCart();

function addToCart(productId){ 
  const product = getProductById(productId);
  if (!product) { showAlert("âŒ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"); return; }
  
  let qty = parseInt(document.getElementById(`qty-${productId}`).value) || 1;
  let size = document.getElementById(`size-${productId}`)?.value || "";
  let color = document.getElementById(`color-${productId}`)?.value || "";
  let type = document.getElementById(`type-${productId}`)?.value || "";

  const requiresColor = product.colors && product.colors.length > 0;
  const requiresSize = product.sizes && product.sizes.length > 0;
  const requiresType = product.types && product.types.length > 0;

  if((requiresSize && size==="") || (requiresColor && color==="") || (requiresType && type==="")){
    showAlert("âš ï¸ Ø§Ø®ØªØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©");
    return;
  }
  
  if (qty === 0) { showAlert("âš ï¸ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù‡ÙŠ ØµÙØ±"); return; }

  let availableStock = product.totalStock || 0;
  if (product.stockDetails && product.stockDetails.length > 0) {
      availableStock = getAvailableStock(productId, color, size, type);
  }
  if(qty > availableStock) { showAlert(`âš ï¸ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©. Ø§Ù„Ù…ØªÙˆÙØ±: ${availableStock}`); return; }

  const existingItemIndex = cart.findIndex(item => 
      item.id === productId && item.color === color && item.size === size && item.type === type 
  );
  
  const mainImage = (product.images && product.images.length > 0) ? product.images[0] : getDefaultImage();

  if (existingItemIndex !== -1) {
      const newQty = cart[existingItemIndex].qty + qty;
      if (newQty > availableStock) { showAlert(`âš ï¸ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…ØªØ§Ø­ (${availableStock}).`); return; }
      cart[existingItemIndex].qty = newQty;
      cart[existingItemIndex].image = mainImage; 
      showAlert("ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ø³Ù„Ø©");
  } else {
      cart.push({
        id: productId,
        name: product.name,
        price: product.price,
        image: mainImage, 
        qty, 
        size, 
        color, 
        type
      });
      showAlert("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©");
  }
  
  localStorage.setItem("cart", JSON.stringify(cart));
  updateCart();
}

function updateCart(){
  document.getElementById("cartCount").innerText = cart.length;
  let container = document.getElementById("cartItems");
  container.innerHTML = "";
  
  let subTotal = 0;
  cart.forEach((it,index)=>{
    const itemTotal = it.price * it.qty;
    const imgHtml = it.image ? `<img src="${it.image}" class="cart-item-img">` : '';

    container.innerHTML += `
      <div class="d-flex justify-content-between align-items-center mb-2" style="background:#f9f9f9; padding:5px; border-radius:8px;">
        <div class="d-flex align-items-center">
             ${imgHtml}
             <div style="font-size: 13px; margin-right:10px;">
                <strong>${it.name}</strong><br>
                ${it.size? `Ù…: ${it.size}`:""} ${it.color? `| Ù„: ${it.color}`:""} ${it.type? `| Ù†ÙˆØ¹: ${it.type}`:""}<br>
                ${it.qty} Ã— ${it.price} = <strong>${itemTotal.toFixed(2)} Ø¯</strong>
             </div>
        </div>
        <div style="min-width: 80px; text-align: left;">
          <button class="btn btn-sm btn-outline-secondary p-1" onclick="editCartQty(${index},-1)">â–</button>
          <button class="btn btn-sm btn-outline-danger p-1" onclick="removeFromCart(${index})">ğŸ—‘ï¸</button>
          <button class="btn btn-sm btn-outline-secondary p-1" onclick="editCartQty(${index},1)">â•</button>
        </div>
      </div>
    `;
    subTotal += itemTotal;
  });
  
  const shippingCost = getShippingCost();
  const grandTotal = subTotal + shippingCost;
  
  document.getElementById("cartTotal").innerHTML = `
    <div class="d-flex justify-content-between mb-1" style="font-size: 16px;">
        <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</span>
        <span style="font-weight: bold;">${subTotal.toFixed(2)} Ø¯</span>
    </div>
    <div class="d-flex justify-content-between mb-1" style="font-size: 16px;">
        <span>Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„:</span>
        <span style="font-weight: bold; color: #d63384;">+ ${shippingCost.toFixed(2)} Ø¯</span>
    </div>
    <hr style="margin: 5px 0;">
    <div class="d-flex justify-content-between" style="font-size: 18px;">
        <span style="font-weight: bold;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</span>
        <span style="font-weight: bold; color: #ff1493;">${grandTotal.toFixed(2)} Ø¯</span>
    </div>
  `;
}

function editCartQty(index,delta){ 
    const item = cart[index];
    const product = getProductById(item.id);
    if (!product) return;
    let availableStock = product.totalStock || 0;
    if (product.stockDetails && product.stockDetails.length > 0) {
        availableStock = getAvailableStock(item.id, item.color, item.size, item.type);
    }
    item.qty += delta; 
    if(item.qty < 1) item.qty = 1; 
    if(item.qty > availableStock) item.qty = availableStock; 
    if(item.qty === 0) { removeFromCart(index); } 
    else { localStorage.setItem("cart", JSON.stringify(cart)); updateCart(); }
}

function removeFromCart(index){ cart.splice(index,1); localStorage.setItem("cart", JSON.stringify(cart)); updateCart(); showAlert("ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø³Ù„Ø©"); }
function closeCart(){ document.getElementById("cartPanel").classList.remove("open"); }
function confirmSendOrder() {
    if (cart.length === 0) { showAlert("âš ï¸ Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©ØŒ Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆÙ„Ø§Ù‹"); return; }
    const userData = JSON.parse(localStorage.getItem('userProfile'));
    if (!userData || !userData.name || !userData.phone || !userData.cityData || !userData.address) { showDataAlert(); return; }
    document.getElementById("confirmSendModal").style.display = "flex";
}
function confirmClearCart() {
    if (cart.length === 0) { showAlert("âš ï¸ Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ© Ø¨Ø§Ù„ÙØ¹Ù„"); return; }
    document.getElementById("confirmClearModal").style.display = "flex";
}
function closeConfirmSend() { document.getElementById("confirmSendModal").style.display = "none"; }
function closeConfirmClear() { document.getElementById("confirmClearModal").style.display = "none"; }
function clearCart() {
    cart = []; localStorage.setItem("cart", JSON.stringify(cart)); updateCart(); showAlert("ğŸ—‘ï¸ ØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©"); closeConfirmClear(); closeCart();
}
function toggleMenu() {
    const menu = document.getElementById('dropdownMenu');
    const overlay = document.getElementById('overlay');
    if (menu.classList.contains('show')) { closeMenu(); } 
    else { menu.classList.add('show'); overlay.style.display = 'block'; }
}
function closeMenu() {
    const menu = document.getElementById('dropdownMenu');
    const overlay = document.getElementById('overlay');
    menu.classList.remove('show'); overlay.style.display = 'none';
}
document.addEventListener('click', function(event) {
    const menu = document.getElementById('dropdownMenu');
    const icon = document.querySelector('.menu-icon');
    if (!menu.contains(event.target) && !icon.contains(event.target)) { closeMenu(); }
});
document.querySelectorAll('.dropdown-item').forEach(item => { item.addEventListener('click', function() { closeMenu(); }); });
function showDataAlert() { document.getElementById('dataAlert').style.display = 'block'; document.getElementById('dataAlertOverlay').style.display = 'block'; }
function closeDataAlert() { document.getElementById('dataAlert').style.display = 'none'; document.getElementById('dataAlertOverlay').style.display = 'none'; }
function goToProfile() { window.location.href = 'profile.html'; }

window.onload = function(){
    loadCategories();
    document.getElementById("cartIcon").onclick = function(){
        const panel = document.getElementById("cartPanel");
        if(panel.classList.contains("open")) panel.classList.remove("open");
        else panel.classList.add("open");
    };
    updateCart(); 
};

function showAlert(msg, duration = 2500){
  let box = document.getElementById("alertBox");
  box.innerHTML = msg; box.style.display = "block";
  setTimeout(()=> box.style.display="none", duration);
}

function changeProductImage(productId, direction) {
    const product = getProductById(productId);
    if (!product || !product.images || product.images.length <= 1) return;
    const gallery = document.getElementById(`gallery-${productId}`);
    const mainImage = gallery.querySelector('.main-product-image');
    let currentIndex = parseInt(mainImage.dataset.currentIndex || 0);
    let newIndex = (currentIndex + direction + product.images.length) % product.images.length;
    updateProductImageDisplay(productId, newIndex);
}

function setProductImage(productId, index) { updateProductImageDisplay(productId, index); }
function updateProductImageDisplay(productId, index) {
    const product = getProductById(productId);
    if (!product || !product.images) return;
    const gallery = document.getElementById(`gallery-${productId}`);
    const mainImage = gallery.querySelector('.main-product-image');
    const thumbnails = gallery.querySelectorAll('.thumbnail');
    const counter = gallery.querySelector('.image-counter');
    mainImage.src = product.images[index] || getDefaultImage();
    mainImage.dataset.currentIndex = index;
    thumbnails.forEach((thumb, i) => { thumb.classList.toggle('active', i === index); });
    if (counter) { counter.textContent = `${index + 1}/${product.images.length}`; }
}

function openImageGallery(productId) {
    const product = getProductById(productId);
    if (!product || !product.images || product.images.length === 0) return;
    const mainImageElement = document.getElementById(`gallery-${productId}`).querySelector('.main-product-image');
    currentGalleryIndex = parseInt(mainImageElement.dataset.currentIndex || 0);
    currentGalleryImages = product.images;
    updateGalleryDisplay();
    document.getElementById('imageGalleryModal').style.display = 'flex';
}

function updateGalleryDisplay() {
    document.getElementById('galleryMainImage').src = currentGalleryImages[currentGalleryIndex] || getDefaultImage();
    document.getElementById('galleryCounter').textContent = `${currentGalleryIndex + 1}/${currentGalleryImages.length}`;
    const thumbnailsContainer = document.getElementById('galleryThumbnails');
    thumbnailsContainer.innerHTML = '';
    currentGalleryImages.forEach((img, index) => {
        const thumb = document.createElement('img');
        thumb.className = `gallery-thumbnail ${index === currentGalleryIndex ? 'active' : ''}`;
        thumb.src = img || getDefaultImage();
        thumb.onclick = () => { currentGalleryIndex = index; updateGalleryDisplay(); };
        thumbnailsContainer.appendChild(thumb);
    });
}

function nextGalleryImage() { currentGalleryIndex = (currentGalleryIndex + 1) % currentGalleryImages.length; updateGalleryDisplay(); }
function prevGalleryImage() { currentGalleryIndex = (currentGalleryIndex - 1 + currentGalleryImages.length) % currentGalleryImages.length; updateGalleryDisplay(); }
function closeImageGallery() { document.getElementById('imageGalleryModal').style.display = 'none'; }
function getProductById(productId) {
    for (const category in products) {
        const product = products[category].find(p => p.id === productId);
        if (product) return product;
    }
    return null;
}
function getDefaultImage() {
    return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmOWZhIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPjx0c3BhbiB4PSI1MCUiIHk9IjUwJSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+8J+UtyDZhNmE6YQg2KfZhNiv2YrYqTwvdHNwYW4+PC90ZXh0Pjwvc3ZnPg==';
}
</script>

<iframe src="bottom-nav.html" style="width:100%; height:80px; border:none; position: fixed; bottom: 0; left: 0; z-index: 1000;"></iframe>
</body>
</html>
